!function(root,factory){if("function"==typeof define&&define.amd)define(["backbone","lodash","jquery"],function(Backbone,_,$){return Backbone.$=$,factory(root,Backbone,_,$)});else if("undefined"!=typeof exports){var Backbone=require("backbone"),_=require("lodash"),$=Backbone.$=require("jquery");module.exports=factory(root,Backbone,_,$)}else{var Backbone=root.Backbone,_=root._,$=Backbone.$=root.jQuery||root.$;root.joint=factory(root,Backbone,_,$),root.g=root.joint.g,root.V=root.Vectorizer=root.joint.V}}(this,function(root,Backbone,_,$){var V,Vectorizer,g=function(){var g={},math=Math,abs=math.abs,cos=math.cos,sin=math.sin,sqrt=math.sqrt,mmin=math.min,mmax=math.max,atan2=(math.atan,math.atan2),round=(math.acos,math.round),floor=math.floor,PI=math.PI,random=math.random,Ellipse=(g.bezier={curveThroughPoints:function(points){for(var controlPoints=this.getCurveControlPoints(points),path=["M",points[0].x,points[0].y],i=0;i<controlPoints[0].length;i++)path.push("C",controlPoints[0][i].x,controlPoints[0][i].y,controlPoints[1][i].x,controlPoints[1][i].y,points[i+1].x,points[i+1].y);return path},getCurveControlPoints:function(knots){var i,firstControlPoints=[],secondControlPoints=[],n=knots.length-1;if(1==n)return firstControlPoints[0]=Point((2*knots[0].x+knots[1].x)/3,(2*knots[0].y+knots[1].y)/3),secondControlPoints[0]=Point(2*firstControlPoints[0].x-knots[0].x,2*firstControlPoints[0].y-knots[0].y),[firstControlPoints,secondControlPoints];var rhs=[];for(i=1;i<n-1;i++)rhs[i]=4*knots[i].x+2*knots[i+1].x;rhs[0]=knots[0].x+2*knots[1].x,rhs[n-1]=(8*knots[n-1].x+knots[n].x)/2;var x=this.getFirstControlPoints(rhs);for(i=1;i<n-1;++i)rhs[i]=4*knots[i].y+2*knots[i+1].y;rhs[0]=knots[0].y+2*knots[1].y,rhs[n-1]=(8*knots[n-1].y+knots[n].y)/2;var y=this.getFirstControlPoints(rhs);for(i=0;i<n;i++)firstControlPoints.push(Point(x[i],y[i])),i<n-1?secondControlPoints.push(Point(2*knots[i+1].x-x[i+1],2*knots[i+1].y-y[i+1])):secondControlPoints.push(Point((knots[n].x+x[n-1])/2,(knots[n].y+y[n-1])/2));return[firstControlPoints,secondControlPoints]},getCurveDivider:function(p0,p1,p2,p3){return function(t){var l=Line(p0,p1).pointAt(t),m=Line(p1,p2).pointAt(t),n=Line(p2,p3).pointAt(t),p=Line(l,m).pointAt(t),q=Line(m,n).pointAt(t),r=Line(p,q).pointAt(t);return[{p0:p0,p1:l,p2:p,p3:r},{p0:r,p1:q,p2:n,p3:p3}]}},getFirstControlPoints:function(rhs){var n=rhs.length,x=[],tmp=[],b=2;x[0]=rhs[0]/b;for(var i=1;i<n;i++)tmp[i]=1/b,b=(i<n-1?4:3.5)-tmp[i],x[i]=(rhs[i]-x[i-1])/b;for(i=1;i<n;i++)x[n-i-1]-=tmp[n-i]*x[n-i];return x},getInversionSolver:function(p0,p1,p2,p3){function l(i,j){var pi=pts[i],pj=pts[j];return function(p){var w=(i%3?3:1)*(j%3?3:1),lij=p.x*(pi.y-pj.y)+p.y*(pj.x-pi.x)+pi.x*pj.y-pi.y*pj.x;return w*lij}}var pts=arguments;return function(p){var ct=3*l(2,3)(p1),c1=l(1,3)(p0)/ct,c2=-l(2,3)(p0)/ct,la=c1*l(3,1)(p)+c2*(l(3,0)(p)+l(2,1)(p))+l(2,0)(p),lb=c1*l(3,0)(p)+c2*l(2,0)(p)+l(1,0)(p);return lb/(lb-la)}}},g.Ellipse=function(c,a,b){return this instanceof Ellipse?c instanceof Ellipse?new Ellipse(Point(c),c.a,c.b):(c=Point(c),this.x=c.x,this.y=c.y,this.a=a,void(this.b=b)):new Ellipse(c,a,b)});g.Ellipse.fromRect=function(rect){return rect=Rect(rect),Ellipse(rect.center(),rect.width/2,rect.height/2)},g.Ellipse.prototype={bbox:function(){return Rect(this.x-this.a,this.y-this.b,2*this.a,2*this.b)},clone:function(){return Ellipse(this)},equals:function(ellipse){return ellipse=Ellipse(ellipse),ellipse.x===this.x&&ellipse.y===this.y&&ellipse.a===this.a&&ellipse.b===this.b},intersectionWithLineFromCenterToPoint:function(p,angle){p=Point(p),angle&&p.rotate(Point(this.x,this.y),angle);var result,dx=p.x-this.x,dy=p.y-this.y;if(0===dx)return result=this.bbox().pointNearestToPoint(p),angle?result.rotate(Point(this.x,this.y),-angle):result;var m=dy/dx,mSquared=m*m,aSquared=this.a*this.a,bSquared=this.b*this.b,x=sqrt(1/(1/aSquared+mSquared/bSquared));x=dx<0?-x:x;var y=m*x;return result=Point(this.x+x,this.y+y),angle?result.rotate(Point(this.x,this.y),-angle):result},toString:function(){return Point(this.x,this.y).toString()+" "+this.a+" "+this.b}};var Line=g.Line=function(p1,p2){return this instanceof Line?(this.start=Point(p1),void(this.end=Point(p2))):new Line(p1,p2)};g.Line.prototype={bearing:function(){var lat1=toRad(this.start.y),lat2=toRad(this.end.y),lon1=this.start.x,lon2=this.end.x,dLon=toRad(lon2-lon1),y=sin(dLon)*cos(lat2),x=cos(lat1)*sin(lat2)-sin(lat1)*cos(lat2)*cos(dLon),brng=toDeg(atan2(y,x)),bearings=["NE","E","SE","S","SW","W","NW","N"],index=brng-22.5;return index<0&&(index+=360),index=parseInt(index/45),bearings[index]},clone:function(){return Line(this)},intersection:function(l){var pt1Dir=Point(this.end.x-this.start.x,this.end.y-this.start.y),pt2Dir=Point(l.end.x-l.start.x,l.end.y-l.start.y),det=pt1Dir.x*pt2Dir.y-pt1Dir.y*pt2Dir.x,deltaPt=Point(l.start.x-this.start.x,l.start.y-this.start.y),alpha=deltaPt.x*pt2Dir.y-deltaPt.y*pt2Dir.x,beta=deltaPt.x*pt1Dir.y-deltaPt.y*pt1Dir.x;if(0===det||alpha*det<0||beta*det<0)return null;if(det>0){if(alpha>det||beta>det)return null}else if(alpha<det||beta<det)return null;return Point(this.start.x+alpha*pt1Dir.x/det,this.start.y+alpha*pt1Dir.y/det)},length:function(){return sqrt(this.squaredLength())},midpoint:function(){return Point((this.start.x+this.end.x)/2,(this.start.y+this.end.y)/2)},pointAt:function(t){var x=(1-t)*this.start.x+t*this.end.x,y=(1-t)*this.start.y+t*this.end.y;return Point(x,y)},pointOffset:function(p){return((this.end.x-this.start.x)*(p.y-this.start.y)-(this.end.y-this.start.y)*(p.x-this.start.x))/2},squaredLength:function(){var x0=this.start.x,y0=this.start.y,x1=this.end.x,y1=this.end.y;return(x0-=x1)*x0+(y0-=y1)*y0},toString:function(){return this.start.toString()+" "+this.end.toString()}};var Point=g.Point=function(x,y){if(!(this instanceof Point))return new Point(x,y);if("string"==typeof x){var xy=x.split(x.indexOf("@")===-1?" ":"@");x=parseInt(xy[0],10),y=parseInt(xy[1],10)}else Object(x)===x&&(y=x.y,x=x.x);this.x=void 0===x?0:x,this.y=void 0===y?0:y};g.Point.fromPolar=function(distance,angle,origin){origin=origin&&Point(origin)||Point(0,0);var x=abs(distance*cos(angle)),y=abs(distance*sin(angle)),deg=normalizeAngle(toDeg(angle));return deg<90?y=-y:deg<180?(x=-x,y=-y):deg<270&&(x=-x),Point(origin.x+x,origin.y+y)},g.Point.random=function(x1,x2,y1,y2){return Point(floor(random()*(x2-x1+1)+x1),floor(random()*(y2-y1+1)+y1))},g.Point.prototype={adhereToRect:function(r){return r.containsPoint(this)?this:(this.x=mmin(mmax(this.x,r.x),r.x+r.width),this.y=mmin(mmax(this.y,r.y),r.y+r.height),this)},bearing:function(point){return Line(this,point).bearing()},changeInAngle:function(dx,dy,ref){return Point(this).offset(-dx,-dy).theta(ref)-this.theta(ref)},clone:function(){return Point(this)},difference:function(p){return Point(this.x-p.x,this.y-p.y)},distance:function(p){return Line(this,p).length()},equals:function(p){return this.x===p.x&&this.y===p.y},magnitude:function(){return sqrt(this.x*this.x+this.y*this.y)||.01},manhattanDistance:function(p){return abs(p.x-this.x)+abs(p.y-this.y)},move:function(ref,distance){var theta=toRad(Point(ref).theta(this));return this.offset(cos(theta)*distance,-sin(theta)*distance)},normalize:function(length){var scale=(length||1)/this.magnitude();return this.scale(scale,scale)},offset:function(dx,dy){return this.x+=dx||0,this.y+=dy||0,this},reflection:function(ref){return Point(ref).move(this,this.distance(ref))},rotate:function(origin,angle){angle=(angle+360)%360,this.toPolar(origin),this.y+=toRad(angle);var point=Point.fromPolar(this.x,this.y,origin);return this.x=point.x,this.y=point.y,this},round:function(precision){return this.x=precision?this.x.toFixed(precision):round(this.x),this.y=precision?this.y.toFixed(precision):round(this.y),this},scale:function(sx,sy,origin){return origin=origin&&Point(origin)||Point(0,0),this.x=origin.x+sx*(this.x-origin.x),this.y=origin.y+sy*(this.y-origin.y),this},snapToGrid:function(gx,gy){return this.x=snapToGrid(this.x,gx),this.y=snapToGrid(this.y,gy||gx),this},theta:function(p){p=Point(p);var y=-(p.y-this.y),x=p.x-this.x,PRECISION=10,rad=0==y.toFixed(PRECISION)&&0==x.toFixed(PRECISION)?0:atan2(y,x);return rad<0&&(rad=2*PI+rad),180*rad/PI},toJSON:function(){return{x:this.x,y:this.y}},toPolar:function(o){o=o&&Point(o)||Point(0,0);var x=this.x,y=this.y;return this.x=sqrt((x-o.x)*(x-o.x)+(y-o.y)*(y-o.y)),this.y=toRad(o.theta(Point(x,y))),this},toString:function(){return this.x+"@"+this.y},update:function(x,y){return this.x=x||0,this.y=y||0,this}};var Rect=g.Rect=function(x,y,w,h){return this instanceof Rect?(Object(x)===x&&(y=x.y,w=x.width,h=x.height,x=x.x),this.x=void 0===x?0:x,this.y=void 0===y?0:y,this.width=void 0===w?0:w,void(this.height=void 0===h?0:h)):new Rect(x,y,w,h)};g.Rect.fromEllipse=function(e){return e=Ellipse(e),Rect(e.x-e.a,e.y-e.b,2*e.a,2*e.b)},g.Rect.prototype={bbox:function(angle){var theta=toRad(angle||0),st=abs(sin(theta)),ct=abs(cos(theta)),w=this.width*ct+this.height*st,h=this.width*st+this.height*ct;return Rect(this.x+(this.width-w)/2,this.y+(this.height-h)/2,w,h)},bottomLeft:function(){return Point(this.x,this.y+this.height)},bottomMiddle:function(){return Point(this.x+this.width/2,this.y+this.height)},center:function(){return Point(this.x+this.width/2,this.y+this.height/2)},clone:function(){return Rect(this)},containsPoint:function(p){return p=Point(p),p.x>=this.x&&p.x<=this.x+this.width&&p.y>=this.y&&p.y<=this.y+this.height},containsRect:function(r){var r0=Rect(this).normalize(),r1=Rect(r).normalize(),w0=r0.width,h0=r0.height,w1=r1.width,h1=r1.height;if(!(w0&&h0&&w1&&h1))return!1;var x0=r0.x,y0=r0.y,x1=r1.x,y1=r1.y;return w1+=x1,w0+=x0,h1+=y1,h0+=y0,x0<=x1&&w1<=w0&&y0<=y1&&h1<=h0},corner:function(){return Point(this.x+this.width,this.y+this.height)},equals:function(r){var mr=Rect(this).normalize(),nr=Rect(r).normalize();return mr.x===nr.x&&mr.y===nr.y&&mr.width===nr.width&&mr.height===nr.height},intersect:function(r){var myOrigin=this.origin(),myCorner=this.corner(),rOrigin=r.origin(),rCorner=r.corner();if(rCorner.x<=myOrigin.x||rCorner.y<=myOrigin.y||rOrigin.x>=myCorner.x||rOrigin.y>=myCorner.y)return null;var x=Math.max(myOrigin.x,rOrigin.x),y=Math.max(myOrigin.y,rOrigin.y);return Rect(x,y,Math.min(myCorner.x,rCorner.x)-x,Math.min(myCorner.y,rCorner.y)-y)},intersectionWithLineFromCenterToPoint:function(p,angle){p=Point(p);var result,center=Point(this.x+this.width/2,this.y+this.height/2);angle&&p.rotate(center,angle);for(var sides=[Line(this.origin(),this.topRight()),Line(this.topRight(),this.corner()),Line(this.corner(),this.bottomLeft()),Line(this.bottomLeft(),this.origin())],connector=Line(center,p),i=sides.length-1;i>=0;--i){var intersection=sides[i].intersection(connector);if(null!==intersection){result=intersection;break}}return result&&angle&&result.rotate(center,-angle),result},leftMiddle:function(){return Point(this.x,this.y+this.height/2)},moveAndExpand:function(r){return this.x+=r.x||0,this.y+=r.y||0,this.width+=r.width||0,this.height+=r.height||0,this},normalize:function(){var newx=this.x,newy=this.y,newwidth=this.width,newheight=this.height;return this.width<0&&(newx=this.x+this.width,newwidth=-this.width),this.height<0&&(newy=this.y+this.height,newheight=-this.height),this.x=newx,this.y=newy,this.width=newwidth,this.height=newheight,this},origin:function(){return Point(this.x,this.y)},pointNearestToPoint:function(point){if(point=Point(point),this.containsPoint(point)){var side=this.sideNearestToPoint(point);switch(side){case"right":return Point(this.x+this.width,point.y);case"left":return Point(this.x,point.y);case"bottom":return Point(point.x,this.y+this.height);case"top":return Point(point.x,this.y)}}return point.adhereToRect(this)},rightMiddle:function(){return Point(this.x+this.width,this.y+this.height/2)},round:function(precision){return this.x=precision?this.x.toFixed(precision):round(this.x),this.y=precision?this.y.toFixed(precision):round(this.y),this.width=precision?this.width.toFixed(precision):round(this.width),this.height=precision?this.height.toFixed(precision):round(this.height),this},scale:function(sx,sy,origin){var origin=this.origin().scale(sx,sy,origin);return this.x=origin.x,this.y=origin.y,this.width*=sx,this.height*=sy,this},sideNearestToPoint:function(point){point=Point(point);var distToLeft=point.x-this.x,distToRight=this.x+this.width-point.x,distToTop=point.y-this.y,distToBottom=this.y+this.height-point.y,closest=distToLeft,side="left";return distToRight<closest&&(closest=distToRight,side="right"),distToTop<closest&&(closest=distToTop,side="top"),distToBottom<closest&&(closest=distToBottom,side="bottom"),side},snapToGrid:function(gx,gy){var origin=this.origin().snapToGrid(gx,gy),corner=this.corner().snapToGrid(gx,gy);return this.x=origin.x,this.y=origin.y,this.width=corner.x-origin.x,this.height=corner.y-origin.y,this},topMiddle:function(){return Point(this.x+this.width/2,this.y)},topRight:function(){return Point(this.x+this.width,this.y)},toJSON:function(){return{x:this.x,y:this.y,width:this.width,height:this.height}},toString:function(){return this.origin().toString()+" "+this.corner().toString()},union:function(rect){var myOrigin=this.origin(),myCorner=this.corner(),rOrigin=rect.origin(),rCorner=rect.corner(),originX=Math.min(myOrigin.x,rOrigin.x),originY=Math.min(myOrigin.y,rOrigin.y),cornerX=Math.max(myCorner.x,rCorner.x),cornerY=Math.max(myCorner.y,rCorner.y);return Rect(originX,originY,cornerX-originX,cornerY-originY)}};var normalizeAngle=g.normalizeAngle=function(angle){return angle%360+(angle<0?360:0)},snapToGrid=(g.scale={linear:function(domain,range,value){var domainSpan=domain[1]-domain[0],rangeSpan=range[1]-range[0];return(value-domain[0])/domainSpan*rangeSpan+range[0]||0}},g.snapToGrid=function(value,gridSize){return gridSize*Math.round(value/gridSize)}),toDeg=g.toDeg=function(rad){return 180*rad/PI%360},toRad=g.toRad=function(deg,over360){return over360=over360||!1,deg=over360?deg:deg%360,deg*PI/180};return g.ellipse=g.Ellipse,g.line=g.Line,g.point=g.Point,g.rect=g.Rect,g}();V=Vectorizer=function(){"use strict";var hasSvg="object"==typeof window&&!(!window.SVGAngle&&!document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1"));if(!hasSvg)return function(){throw new Error("SVG is required to use Vectorizer.")};var ns={xmlns:"http://www.w3.org/2000/svg",xml:"http://www.w3.org/XML/1998/namespace",xlink:"http://www.w3.org/1999/xlink"},SVGversion="1.1",V=function(el,attrs,children){if(!(this instanceof V))return V.apply(Object.create(V.prototype),arguments);if(el){if(V.isV(el)&&(el=el.node),attrs=attrs||{},V.isString(el))if("svg"===el.toLowerCase())el=V.createSvgDocument();else if("<"===el[0]){var svgDoc=V.createSvgDocument(el);if(svgDoc.childNodes.length>1){var i,len,arrayOfVels=[];for(i=0,len=svgDoc.childNodes.length;i<len;i++){var childNode=svgDoc.childNodes[i];arrayOfVels.push(new V(document.importNode(childNode,!0)))}return arrayOfVels}el=document.importNode(svgDoc.firstChild,!0)}else el=document.createElementNS(ns.xmlns,el);return this.node=el,this.node.id||(this.node.id=V.uniqueId()),this.setAttributes(attrs),children&&this.append(children),this}};V.prototype.getTransformToElement=function(toElem){return toElem.getScreenCTM().inverse().multiply(this.node.getScreenCTM())},V.prototype.transform=function(matrix){if(V.isUndefined(matrix))return this.node.parentNode?this.getTransformToElement(this.node.parentNode):this.node.getScreenCTM();var svgTransform=V.createSVGTransform(matrix);return this.node.transform.baseVal.appendItem(svgTransform),this},V.prototype.translate=function(tx,ty,opt){opt=opt||{},ty=ty||0;var transformAttr=this.attr("transform")||"",transform=V.parseTransformString(transformAttr);if(V.isUndefined(tx))return transform.translate;transformAttr=transformAttr.replace(/translate\([^\)]*\)/g,"").trim();var newTx=opt.absolute?tx:transform.translate.tx+tx,newTy=opt.absolute?ty:transform.translate.ty+ty,newTranslate="translate("+newTx+","+newTy+")";return this.attr("transform",(newTranslate+" "+transformAttr).trim()),this},V.prototype.rotate=function(angle,cx,cy,opt){opt=opt||{};var transformAttr=this.attr("transform")||"",transform=V.parseTransformString(transformAttr);if(V.isUndefined(angle))return transform.rotate;transformAttr=transformAttr.replace(/rotate\([^\)]*\)/g,"").trim(),angle%=360;var newAngle=opt.absolute?angle:transform.rotate.angle+angle,newOrigin=void 0!==cx&&void 0!==cy?","+cx+","+cy:"",newRotate="rotate("+newAngle+newOrigin+")";return this.attr("transform",(transformAttr+" "+newRotate).trim()),this},V.prototype.scale=function(sx,sy){sy=V.isUndefined(sy)?sx:sy;var transformAttr=this.attr("transform")||"",transform=V.parseTransformString(transformAttr);if(V.isUndefined(sx))return transform.scale;transformAttr=transformAttr.replace(/scale\([^\)]*\)/g,"").trim();var newScale="scale("+sx+","+sy+")";return this.attr("transform",(transformAttr+" "+newScale).trim()),this},V.prototype.bbox=function(withoutTransformations,target){if(!this.node.ownerSVGElement)return{x:0,y:0,width:0,height:0};var box;try{box=this.node.getBBox(),box={x:box.x,y:box.y,width:box.width,height:box.height}}catch(e){box={x:this.node.clientLeft,y:this.node.clientTop,width:this.node.clientWidth,height:this.node.clientHeight}}if(withoutTransformations)return box;var matrix=this.getTransformToElement(target||this.node.ownerSVGElement);return V.transformRect(box,matrix)},V.prototype.text=function(content,opt){content=V.sanitizeText(content),opt=opt||{};var tspan,lines=content.split("\n"),y=this.attr("y");y||this.attr("y","0.8em"),this.attr("display",content?null:"none"),this.attr("xml:space","preserve"),this.node.textContent="";var textNode=this.node;if(opt.textPath){var defs=this.find("defs");0===defs.length&&(defs=V("defs"),this.append(defs));var d=Object(opt.textPath)===opt.textPath?opt.textPath.d:opt.textPath;if(d){var path=V("path",{d:d});defs.append(path)}var textPath=V("textPath");!opt.textPath["xlink:href"]&&path&&textPath.attr("xlink:href","#"+path.node.id),Object(opt.textPath)===opt.textPath&&textPath.attr(opt.textPath),this.append(textPath),textNode=textPath.node}for(var offset=0,i=0;i<lines.length;i++){var line=lines[i],lineHeight=opt.lineHeight||"1em";"auto"===opt.lineHeight&&(lineHeight="1.5em");var vLine=V("tspan",{dy:0==i?"0em":lineHeight,x:this.attr("x")||0});if(vLine.addClass("v-line"),line)if(opt.annotations){for(var maxFontSize=0,lineAnnotations=V.annotateString(lines[i],V.isArray(opt.annotations)?opt.annotations:[opt.annotations],{offset:-offset,includeAnnotationIndices:opt.includeAnnotationIndices}),j=0;j<lineAnnotations.length;j++){var annotation=lineAnnotations[j];if(V.isObject(annotation)){var fontSize=parseInt(annotation.attrs["font-size"],10);fontSize&&fontSize>maxFontSize&&(maxFontSize=fontSize),tspan=V("tspan",annotation.attrs),opt.includeAnnotationIndices&&tspan.attr("annotations",annotation.annotations),annotation.attrs["class"]&&tspan.addClass(annotation.attrs["class"]),tspan.node.textContent=annotation.t}else tspan=document.createTextNode(annotation||" ");vLine.append(tspan)}"auto"===opt.lineHeight&&maxFontSize&&0!==i&&vLine.attr("dy",1.2*maxFontSize+"px")}else vLine.node.textContent=line;else vLine.addClass("v-empty-line"),vLine.node.style.opacity=0,vLine.node.textContent="-";V(textNode).append(vLine),offset+=line.length+1}return this},V.prototype.removeAttr=function(name){var qualifiedName=V.qualifyAttr(name),el=this.node;return qualifiedName.ns?el.hasAttributeNS(qualifiedName.ns,qualifiedName.local)&&el.removeAttributeNS(qualifiedName.ns,qualifiedName.local):el.hasAttribute(name)&&el.removeAttribute(name),this},V.prototype.attr=function(name,value){if(V.isUndefined(name)){for(var attributes=this.node.attributes,attrs={},i=0;i<attributes.length;i++)attrs[attributes[i].nodeName]=attributes[i].nodeValue;return attrs}if(V.isString(name)&&V.isUndefined(value))return this.node.getAttribute(name);if("object"==typeof name)for(var attrName in name)name.hasOwnProperty(attrName)&&this.setAttribute(attrName,name[attrName]);else this.setAttribute(name,value);return this},V.prototype.remove=function(){return this.node.parentNode&&this.node.parentNode.removeChild(this.node),this},V.prototype.empty=function(){for(;this.node.firstChild;)this.node.removeChild(this.node.firstChild);return this},V.prototype.setAttributes=function(attrs){for(var key in attrs)attrs.hasOwnProperty(key)&&this.setAttribute(key,attrs[key]);return this},V.prototype.append=function(els){V.isArray(els)||(els=[els]);for(var i=0,len=els.length;i<len;i++)this.node.appendChild(V.toNode(els[i]));return this},V.prototype.prepend=function(els){var child=this.node.firstChild;return child?V(child).before(els):this.append(els)},V.prototype.before=function(els){var node=this.node,parent=node.parentNode;if(parent){V.isArray(els)||(els=[els]);for(var i=0,len=els.length;i<len;i++)parent.insertBefore(V.toNode(els[i]),node)}return this},V.prototype.svg=function(){return this.node instanceof window.SVGSVGElement?this:V(this.node.ownerSVGElement)},V.prototype.defs=function(){var defs=this.svg().node.getElementsByTagName("defs");return defs&&defs.length?V(defs[0]):void 0},V.prototype.clone=function(){var clone=V(this.node.cloneNode(!0));return clone.node.id=V.uniqueId(),clone},V.prototype.findOne=function(selector){var found=this.node.querySelector(selector);return found?V(found):void 0},V.prototype.find=function(selector){var vels=[],nodes=this.node.querySelectorAll(selector);if(nodes)for(var i=0;i<nodes.length;i++)vels.push(V(nodes[i]));return vels},V.prototype.index=function(){for(var index=0,node=this.node.previousSibling;node;)1===node.nodeType&&index++,node=node.previousSibling;return index},V.prototype.findParentByClass=function(className,terminator){for(var ownerSVGElement=this.node.ownerSVGElement,node=this.node.parentNode;node&&node!==terminator&&node!==ownerSVGElement;){var vel=V(node);if(vel.hasClass(className))return vel;node=node.parentNode}return null},V.prototype.toLocalPoint=function(x,y){var svg=this.svg().node,p=svg.createSVGPoint();p.x=x,p.y=y;try{var globalPoint=p.matrixTransform(svg.getScreenCTM().inverse()),globalToLocalMatrix=this.getTransformToElement(svg).inverse()}catch(e){return p}return globalPoint.matrixTransform(globalToLocalMatrix)},V.prototype.translateCenterToPoint=function(p){var bbox=this.bbox(),center=g.rect(bbox).center();this.translate(p.x-center.x,p.y-center.y)},V.prototype.translateAndAutoOrient=function(position,reference,target){var s=this.scale();this.attr("transform",""),this.scale(s.sx,s.sy);var svg=this.svg().node,bbox=this.bbox(!1,target),translateToOrigin=svg.createSVGTransform();translateToOrigin.setTranslate(-bbox.x-bbox.width/2,-bbox.y-bbox.height/2);var rotateAroundOrigin=svg.createSVGTransform(),angle=g.point(position).changeInAngle(position.x-reference.x,position.y-reference.y,reference);rotateAroundOrigin.setRotate(angle,0,0);var translateFinal=svg.createSVGTransform(),finalPosition=g.point(position).move(reference,bbox.width/2);translateFinal.setTranslate(position.x+(position.x-finalPosition.x),position.y+(position.y-finalPosition.y));var ctm=this.getTransformToElement(target),transform=svg.createSVGTransform();transform.setMatrix(translateFinal.matrix.multiply(rotateAroundOrigin.matrix.multiply(translateToOrigin.matrix.multiply(ctm))));var decomposition=V.decomposeMatrix(transform.matrix);return this.translate(decomposition.translateX,decomposition.translateY),this.rotate(decomposition.rotation),this},V.prototype.animateAlongPath=function(attrs,path){var animateMotion=V("animateMotion",attrs),mpath=V("mpath",{"xlink:href":"#"+V(path).node.id});animateMotion.append(mpath),this.append(animateMotion);try{animateMotion.node.beginElement()}catch(e){if("fake"===document.documentElement.getAttribute("smiling")){var animation=animateMotion.node;animation.animators=[];var animationID=animation.getAttribute("id");animationID&&(id2anim[animationID]=animation);for(var targets=getTargets(animation),i=0,len=targets.length;i<len;i++){var target=targets[i],animator=new Animator(animation,target,i);animators.push(animator),animation.animators[i]=animator,animator.register()}}}},V.prototype.hasClass=function(className){return new RegExp("(\\s|^)"+className+"(\\s|$)").test(this.node.getAttribute("class"))},V.prototype.addClass=function(className){if(!this.hasClass(className)){var prevClasses=this.node.getAttribute("class")||"";this.node.setAttribute("class",(prevClasses+" "+className).trim())}return this},V.prototype.removeClass=function(className){if(this.hasClass(className)){var newClasses=this.node.getAttribute("class").replace(new RegExp("(\\s|^)"+className+"(\\s|$)","g"),"$2");this.node.setAttribute("class",newClasses)}return this},V.prototype.toggleClass=function(className,toAdd){var toRemove=V.isUndefined(toAdd)?this.hasClass(className):!toAdd;return toRemove?this.removeClass(className):this.addClass(className),this},V.prototype.sample=function(interval){interval=interval||1;for(var sample,node=this.node,length=node.getTotalLength(),samples=[],distance=0;distance<length;)sample=node.getPointAtLength(distance),samples.push({x:sample.x,y:sample.y,distance:distance}),distance+=interval;return samples},V.prototype.convertToPath=function(){var path=V("path");path.attr(this.attr());var d=this.convertToPathData();return d&&path.attr("d",d),path},V.prototype.convertToPathData=function(){var tagName=this.node.tagName.toUpperCase();switch(tagName){case"PATH":return this.attr("d");case"LINE":return V.convertLineToPathData(this.node);case"POLYGON":return V.convertPolygonToPathData(this.node);case"POLYLINE":return V.convertPolylineToPathData(this.node);case"ELLIPSE":return V.convertEllipseToPathData(this.node);case"CIRCLE":return V.convertCircleToPathData(this.node);case"RECT":return V.convertRectToPathData(this.node)}throw new Error(tagName+" cannot be converted to PATH.")},V.prototype.findIntersection=function(ref,target){var svg=this.svg().node;target=target||svg;var bbox=g.rect(this.bbox(!1,target)),center=bbox.center();if(bbox.intersectionWithLineFromCenterToPoint(ref)){var spot,tagName=this.node.localName.toUpperCase();if("RECT"===tagName){var gRect=g.rect(parseFloat(this.attr("x")||0),parseFloat(this.attr("y")||0),parseFloat(this.attr("width")),parseFloat(this.attr("height"))),rectMatrix=this.getTransformToElement(target),rectMatrixComponents=V.decomposeMatrix(rectMatrix),resetRotation=svg.createSVGTransform();resetRotation.setRotate(-rectMatrixComponents.rotation,center.x,center.y);var rect=V.transformRect(gRect,resetRotation.matrix.multiply(rectMatrix));spot=g.rect(rect).intersectionWithLineFromCenterToPoint(ref,rectMatrixComponents.rotation)}else if("PATH"===tagName||"POLYGON"===tagName||"POLYLINE"===tagName||"CIRCLE"===tagName||"ELLIPSE"===tagName){var i,sample,gp,centerDistance,refDistance,distance,pathNode="PATH"===tagName?this:this.convertToPath(),samples=pathNode.sample(),minDistance=1/0,closestSamples=[];for(i=0;i<samples.length;i++)sample=samples[i],gp=V.createSVGPoint(sample.x,sample.y),gp=gp.matrixTransform(this.getTransformToElement(target)),sample=g.point(gp),centerDistance=sample.distance(center),refDistance=1.1*sample.distance(ref),distance=centerDistance+refDistance,distance<minDistance?(minDistance=distance,closestSamples=[{sample:sample,refDistance:refDistance}]):distance<minDistance+1&&closestSamples.push({sample:sample,refDistance:refDistance});closestSamples.sort(function(a,b){return a.refDistance-b.refDistance}),closestSamples[0]&&(spot=closestSamples[0].sample)}return spot}},V.prototype.setAttribute=function(name,value){var el=this.node;if(null===value)return this.removeAttr(name),this;var qualifiedName=V.qualifyAttr(name);return qualifiedName.ns?el.setAttributeNS(qualifiedName.ns,name,value):"id"===name?el.id=value:el.setAttribute(name,value),this},V.createSvgDocument=function(content){var svg='<svg xmlns="'+ns.xmlns+'" xmlns:xlink="'+ns.xlink+'" version="'+SVGversion+'">'+(content||"")+"</svg>",xml=V.parseXML(svg,{async:!1});return xml.documentElement},V.idCounter=0,V.uniqueId=function(){var id=++V.idCounter+"";return"v-"+id},V.sanitizeText=function(text){return(text||"").replace(/ /g,"Â ")},V.isUndefined=function(value){return"undefined"==typeof value},V.isString=function(value){return"string"==typeof value},V.isObject=function(value){return value&&"object"==typeof value},V.isArray=Array.isArray,V.parseXML=function(data,opt){opt=opt||{};var xml;try{var parser=new DOMParser;V.isUndefined(opt.async)||(parser.async=opt.async),xml=parser.parseFromString(data,"text/xml")}catch(error){xml=void 0}if(!xml||xml.getElementsByTagName("parsererror").length)throw new Error("Invalid XML: "+data);return xml},V.qualifyAttr=function(name){if(name.indexOf(":")!==-1){var combinedKey=name.split(":");return{ns:ns[combinedKey[0]],local:combinedKey[1]}}return{ns:null,local:name}},V.parseTransformString=function(transform){var translate,rotate,scale;if(transform){var separator=/[ ,]+/,translateMatch=transform.match(/translate\((.*)\)/);translateMatch&&(translate=translateMatch[1].split(separator));var rotateMatch=transform.match(/rotate\((.*)\)/);rotateMatch&&(rotate=rotateMatch[1].split(separator));var scaleMatch=transform.match(/scale\((.*)\)/);scaleMatch&&(scale=scaleMatch[1].split(separator))}var sx=scale&&scale[0]?parseFloat(scale[0]):1;return{translate:{tx:translate&&translate[0]?parseInt(translate[0],10):0,ty:translate&&translate[1]?parseInt(translate[1],10):0},rotate:{angle:rotate&&rotate[0]?parseInt(rotate[0],10):0,cx:rotate&&rotate[1]?parseInt(rotate[1],10):void 0,cy:rotate&&rotate[2]?parseInt(rotate[2],10):void 0},scale:{sx:sx,sy:scale&&scale[1]?parseFloat(scale[1]):sx}}},V.deltaTransformPoint=function(matrix,point){var dx=point.x*matrix.a+point.y*matrix.c+0,dy=point.x*matrix.b+point.y*matrix.d+0;return{x:dx,y:dy}},V.decomposeMatrix=function(matrix){var px=V.deltaTransformPoint(matrix,{x:0,y:1}),py=V.deltaTransformPoint(matrix,{x:1,y:0}),skewX=180/Math.PI*Math.atan2(px.y,px.x)-90,skewY=180/Math.PI*Math.atan2(py.y,py.x);return{translateX:matrix.e,translateY:matrix.f,scaleX:Math.sqrt(matrix.a*matrix.a+matrix.b*matrix.b),scaleY:Math.sqrt(matrix.c*matrix.c+matrix.d*matrix.d),skewX:skewX,skewY:skewY,rotation:skewX}},V.isV=function(object){return object instanceof V},V.isVElement=V.isV;var svgDocument=V("svg").node;return V.createSVGMatrix=function(matrix){var svgMatrix=svgDocument.createSVGMatrix();for(var component in matrix)svgMatrix[component]=matrix[component];return svgMatrix},V.createSVGTransform=function(matrix){return V.isUndefined(matrix)?svgDocument.createSVGTransform():(matrix instanceof SVGMatrix||(matrix=V.createSVGMatrix(matrix)),svgDocument.createSVGTransformFromMatrix(matrix))},V.createSVGPoint=function(x,y){var p=svgDocument.createSVGPoint();return p.x=x,p.y=y,p},V.transformRect=function(r,matrix){var p=svgDocument.createSVGPoint();p.x=r.x,p.y=r.y;var corner1=p.matrixTransform(matrix);p.x=r.x+r.width,p.y=r.y;var corner2=p.matrixTransform(matrix);p.x=r.x+r.width,p.y=r.y+r.height;var corner3=p.matrixTransform(matrix);p.x=r.x,p.y=r.y+r.height;var corner4=p.matrixTransform(matrix),minX=Math.min(corner1.x,corner2.x,corner3.x,corner4.x),maxX=Math.max(corner1.x,corner2.x,corner3.x,corner4.x),minY=Math.min(corner1.y,corner2.y,corner3.y,corner4.y),maxY=Math.max(corner1.y,corner2.y,corner3.y,corner4.y);return{x:minX,y:minY,width:maxX-minX,height:maxY-minY}},V.transformPoint=function(p,matrix){return V.createSVGPoint(p.x,p.y).matrixTransform(matrix)},V.styleToObject=function(styleString){for(var ret={},styles=styleString.split(";"),i=0;i<styles.length;i++){var style=styles[i],pair=style.split("=");ret[pair[0].trim()]=pair[1].trim()}return ret},V.createSlicePathData=function(innerRadius,outerRadius,startAngle,endAngle){var svgArcMax=2*Math.PI-1e-6,r0=innerRadius,r1=outerRadius,a0=startAngle,a1=endAngle,da=(a1<a0&&(da=a0,a0=a1,a1=da),a1-a0),df=da<Math.PI?"0":"1",c0=Math.cos(a0),s0=Math.sin(a0),c1=Math.cos(a1),s1=Math.sin(a1);return da>=svgArcMax?r0?"M0,"+r1+"A"+r1+","+r1+" 0 1,1 0,"+-r1+"A"+r1+","+r1+" 0 1,1 0,"+r1+"M0,"+r0+"A"+r0+","+r0+" 0 1,0 0,"+-r0+"A"+r0+","+r0+" 0 1,0 0,"+r0+"Z":"M0,"+r1+"A"+r1+","+r1+" 0 1,1 0,"+-r1+"A"+r1+","+r1+" 0 1,1 0,"+r1+"Z":r0?"M"+r1*c0+","+r1*s0+"A"+r1+","+r1+" 0 "+df+",1 "+r1*c1+","+r1*s1+"L"+r0*c1+","+r0*s1+"A"+r0+","+r0+" 0 "+df+",0 "+r0*c0+","+r0*s0+"Z":"M"+r1*c0+","+r1*s0+"A"+r1+","+r1+" 0 "+df+",1 "+r1*c1+","+r1*s1+"L0,0Z";
},V.mergeAttrs=function(a,b){for(var attr in b)"class"===attr?a[attr]=a[attr]?a[attr]+" "+b[attr]:b[attr]:"style"===attr?V.isObject(a[attr])&&V.isObject(b[attr])?a[attr]=V.mergeAttrs(a[attr],b[attr]):V.isObject(a[attr])?a[attr]=V.mergeAttrs(a[attr],V.styleToObject(b[attr])):V.isObject(b[attr])?a[attr]=V.mergeAttrs(V.styleToObject(a[attr]),b[attr]):a[attr]=V.mergeAttrs(V.styleToObject(a[attr]),V.styleToObject(b[attr])):a[attr]=b[attr];return a},V.annotateString=function(t,annotations,opt){annotations=annotations||[],opt=opt||{};for(var batch,item,prev,offset=opt.offset||0,compacted=[],ret=[],i=0;i<t.length;i++){item=ret[i]=t[i];for(var j=0;j<annotations.length;j++){var annotation=annotations[j],start=annotation.start+offset,end=annotation.end+offset;i>=start&&i<end&&(V.isObject(item)?item.attrs=V.mergeAttrs(V.mergeAttrs({},item.attrs),annotation.attrs):item=ret[i]={t:t[i],attrs:annotation.attrs},opt.includeAnnotationIndices&&(item.annotations||(item.annotations=[])).push(j))}prev=ret[i-1],prev?V.isObject(item)&&V.isObject(prev)?JSON.stringify(item.attrs)===JSON.stringify(prev.attrs)?batch.t+=item.t:(compacted.push(batch),batch=item):V.isObject(item)?(compacted.push(batch),batch=item):V.isObject(prev)?(compacted.push(batch),batch=item):batch=(batch||"")+item:batch=item}return batch&&compacted.push(batch),compacted},V.findAnnotationsAtIndex=function(annotations,index){var found=[];return annotations&&annotations.forEach(function(annotation){annotation.start<index&&index<=annotation.end&&found.push(annotation)}),found},V.findAnnotationsBetweenIndexes=function(annotations,start,end){var found=[];return annotations&&annotations.forEach(function(annotation){(start>=annotation.start&&start<annotation.end||end>annotation.start&&end<=annotation.end||annotation.start>=start&&annotation.end<end)&&found.push(annotation)}),found},V.shiftAnnotations=function(annotations,index,offset){return annotations&&annotations.forEach(function(annotation){annotation.start<index&&annotation.end>=index?annotation.end+=offset:annotation.start>=index&&(annotation.start+=offset,annotation.end+=offset)}),annotations},V.convertLineToPathData=function(line){line=V(line);var d=["M",line.attr("x1"),line.attr("y1"),"L",line.attr("x2"),line.attr("y2")].join(" ");return d},V.convertPolygonToPathData=function(polygon){polygon=V(polygon);var points=V.getPointsFromSvgNode(polygon.node);return points.length>0?V.svgPointsToPath(points):null},V.convertPolylineToPathData=function(polyline){var points=V.getPointsFromSvgNode(polyline.node);return points.length>0?V.svgPointsToPath(points):null},V.svgPointsToPath=function(points){var i;for(i=0;i<points.length;i++)points[i]=points[i].x+" "+points[i].y;return"M "+points.join(" L")+" Z"},V.getPointsFromSvgNode=function(node){var i,points=[];for(i=0;i<node.points.numberOfItems;i++)points.push(node.points.getItem(i));return points},V.KAPPA=.5522847498307935,V.convertCircleToPathData=function(circle){circle=V(circle);var cx=parseFloat(circle.attr("cx"))||0,cy=parseFloat(circle.attr("cy"))||0,r=parseFloat(circle.attr("r")),cd=r*V.KAPPA,d=["M",cx,cy-r,"C",cx+cd,cy-r,cx+r,cy-cd,cx+r,cy,"C",cx+r,cy+cd,cx+cd,cy+r,cx,cy+r,"C",cx-cd,cy+r,cx-r,cy+cd,cx-r,cy,"C",cx-r,cy-cd,cx-cd,cy-r,cx,cy-r,"Z"].join(" ");return d},V.convertEllipseToPathData=function(ellipse){ellipse=V(ellipse);var cx=parseFloat(ellipse.attr("cx"))||0,cy=parseFloat(ellipse.attr("cy"))||0,rx=parseFloat(ellipse.attr("rx")),ry=parseFloat(ellipse.attr("ry"))||rx,cdx=rx*V.KAPPA,cdy=ry*V.KAPPA,d=["M",cx,cy-ry,"C",cx+cdx,cy-ry,cx+rx,cy-cdy,cx+rx,cy,"C",cx+rx,cy+cdy,cx+cdx,cy+ry,cx,cy+ry,"C",cx-cdx,cy+ry,cx-rx,cy+cdy,cx-rx,cy,"C",cx-rx,cy-cdy,cx-cdx,cy-ry,cx,cy-ry,"Z"].join(" ");return d},V.convertRectToPathData=function(rect){rect=V(rect);var d,x=parseFloat(rect.attr("x"))||0,y=parseFloat(rect.attr("y"))||0,width=parseFloat(rect.attr("width"))||0,height=parseFloat(rect.attr("height"))||0,rx=parseFloat(rect.attr("rx"))||0,ry=parseFloat(rect.attr("ry"))||0,bbox=g.rect(x,y,width,height);if(rx||ry){var r=x+width,b=y+height;d=["M",x+rx,y,"L",r-rx,y,"Q",r,y,r,y+ry,"L",r,y+height-ry,"Q",r,b,r-rx,b,"L",x+rx,b,"Q",x,b,x,b-rx,"L",x,y+ry,"Q",x,y,x+rx,y,"Z"].join(" ")}else d=["M",bbox.origin().x,bbox.origin().y,"H",bbox.corner().x,"V",bbox.corner().y,"H",bbox.origin().x,"V",bbox.origin().y,"Z"].join(" ");return d},V.rectToPath=function(r){var topRx=r.rx||r["top-rx"]||0,bottomRx=r.rx||r["bottom-rx"]||0,topRy=r.ry||r["top-ry"]||0,bottomRy=r.ry||r["bottom-ry"]||0;return["M",r.x,r.y+topRy,"v",r.height-topRy-bottomRy,"a",bottomRx,bottomRy,0,0,0,bottomRx,bottomRy,"h",r.width-2*bottomRx,"a",bottomRx,bottomRy,0,0,0,bottomRx,-bottomRy,"v",-(r.height-bottomRy-topRy),"a",topRx,topRy,0,0,0,-topRx,-topRy,"h",-(r.width-2*topRx),"a",topRx,topRy,0,0,0,-topRx,topRy].join(" ")},V.toNode=function(el){return V.isV(el)?el.node:el.nodeName&&el||el[0]},V}();var joint={version:"0.9.8",dia:{},ui:{},layout:{},shapes:{},format:{},connectors:{},highlighters:{},routers:{},mvc:{views:{}},setTheme:function(theme,opt){opt=opt||{},_.invoke(joint.mvc.views,"setTheme",theme,opt),joint.mvc.View.prototype.defaultTheme=theme},env:{_results:{},_tests:{svgforeignobject:function(){return!!document.createElementNS&&/SVGForeignObject/.test({}.toString.call(document.createElementNS("http://www.w3.org/2000/svg","foreignObject")))}},addTest:function(name,fn){return joint.env._tests[name]=fn},test:function(name){var fn=joint.env._tests[name];if(!fn)throw new Error('Test not defined ("'+name+'"). Use `joint.env.addTest(name, fn) to add a new test.`');var result=joint.env._results[name];if("undefined"!=typeof result)return result;try{result=fn()}catch(error){result=!1}return joint.env._results[name]=result,result}},util:{hashCode:function(str){var hash=0;if(0==str.length)return hash;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);hash=(hash<<5)-hash+c,hash&=hash}return hash},getByPath:function(obj,path,delim){delim=delim||"/";for(var key,keys=path.split(delim);keys.length;){if(key=keys.shift(),!(Object(obj)===obj&&key in obj))return;obj=obj[key]}return obj},setByPath:function(obj,path,value,delim){delim=delim||"/";var keys=path.split(delim),diver=obj,i=0;if(path.indexOf(delim)>-1){for(var len=keys.length;i<len-1;i++)diver=diver[keys[i]]||(diver[keys[i]]={});diver[keys[len-1]]=value}else obj[path]=value;return obj},unsetByPath:function(obj,path,delim){delim=delim||"/";var i=path.lastIndexOf(delim);if(i>-1){var parent=joint.util.getByPath(obj,path.substr(0,i),delim);parent&&delete parent[path.slice(i+1)]}else delete obj[path];return obj},flattenObject:function(obj,delim,stop){delim=delim||"/";var ret={};for(var key in obj)if(obj.hasOwnProperty(key)){var shouldGoDeeper="object"==typeof obj[key];if(shouldGoDeeper&&stop&&stop(obj[key])&&(shouldGoDeeper=!1),shouldGoDeeper){var flatObject=this.flattenObject(obj[key],delim,stop);for(var flatKey in flatObject)flatObject.hasOwnProperty(flatKey)&&(ret[key+delim+flatKey]=flatObject[flatKey])}else ret[key]=obj[key]}return ret},uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)})},guid:function(obj){return this.guid.id=this.guid.id||1,obj.id=void 0===obj.id?"j_"+this.guid.id++:obj.id,obj.id},mixin:function(){for(var target=arguments[0],i=1,l=arguments.length;i<l;i++){var extension=arguments[i];(Object(extension)===extension||_.isFunction(extension)||null!==extension&&void 0!==extension)&&_.each(extension,function(copy,key){return this.mixin.deep&&Object(copy)===copy?(target[key]||(target[key]=_.isArray(copy)?[]:{}),void this.mixin(target[key],copy)):void(target[key]!==copy&&(this.mixin.supplement&&target.hasOwnProperty(key)||(target[key]=copy)))},this)}return target},supplement:function(){this.mixin.supplement=!0;var ret=this.mixin.apply(this,arguments);return this.mixin.supplement=!1,ret},deepMixin:function(){this.mixin.deep=!0;var ret=this.mixin.apply(this,arguments);return this.mixin.deep=!1,ret},deepSupplement:function(){this.mixin.deep=this.mixin.supplement=!0;var ret=this.mixin.apply(this,arguments);return this.mixin.deep=this.mixin.supplement=!1,ret},normalizeEvent:function(evt){var touchEvt=evt.originalEvent&&evt.originalEvent.changedTouches&&evt.originalEvent.changedTouches[0];if(touchEvt){for(var property in evt)void 0===touchEvt[property]&&(touchEvt[property]=evt[property]);return touchEvt}return evt},nextFrame:function(){var raf;if("undefined"!=typeof window&&(raf=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),!raf){var lastTime=0;raf=function(callback){var currTime=(new Date).getTime(),timeToCall=Math.max(0,16-(currTime-lastTime)),id=setTimeout(function(){callback(currTime+timeToCall)},timeToCall);return lastTime=currTime+timeToCall,id}}return function(callback,context){return raf(context?_.bind(callback,context):callback)}}(),cancelFrame:function(){var caf,client="undefined"!=typeof window;return client&&(caf=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame),caf=caf||clearTimeout,client?_.bind(caf,window):caf}(),shapePerimeterConnectionPoint:function(linkView,view,magnet,reference){var bbox,spot;if(!magnet){var scalable=view.$(".scalable")[0],rotatable=view.$(".rotatable")[0];scalable&&scalable.firstChild?magnet=scalable.firstChild:rotatable&&rotatable.firstChild&&(magnet=rotatable.firstChild)}return magnet?(spot=V(magnet).findIntersection(reference,linkView.paper.viewport),spot||(bbox=g.rect(V(magnet).bbox(!1,linkView.paper.viewport)))):(bbox=view.model.getBBox(),spot=bbox.intersectionWithLineFromCenterToPoint(reference)),spot||bbox.center()},breakText:function(text,size,styles,opt){opt=opt||{};var width=size.width,height=size.height,svgDocument=opt.svgDocument||V("svg").node,textElement=V("<text><tspan></tspan></text>").attr(styles||{}).node,textSpan=textElement.firstChild,textNode=document.createTextNode("");textElement.style.opacity=0,textElement.style.display="block",textSpan.style.display="block",textSpan.appendChild(textNode),svgDocument.appendChild(textElement),opt.svgDocument||document.body.appendChild(svgDocument);for(var p,words=text.split(" "),full=[],lines=[],i=0,l=0,len=words.length;i<len;i++){var word=words[i];if(textNode.data=lines[l]?lines[l]+" "+word:word,textSpan.getComputedTextLength()<=width)lines[l]=textNode.data,p&&(full[l++]=!0,p=0);else{if(!lines[l]||p){var partition=!!p;if(p=word.length-1,partition||!p){if(!p){if(!lines[l]){lines=[];break}words.splice(i,2,word+words[i+1]),len--,full[l++]=!0,i--;continue}words[i]=word.substring(0,p),words[i+1]=word.substring(p)+words[i+1]}else words.splice(i,1,word.substring(0,p),word.substring(p)),len++,l&&!full[l-1]&&l--;i--;continue}l++,i--}if("undefined"!=typeof height){var lh=lh||1.25*textElement.getBBox().height;if(lh*lines.length>height){lines.splice(Math.floor(height/lh));break}}}return opt.svgDocument?svgDocument.removeChild(textElement):document.body.removeChild(svgDocument),lines.join("\n")},imageToDataUri:function(url,callback){if(!url||"data:"===url.substr(0,"data:".length))return setTimeout(function(){callback(null,url)},0);var canvas=document.createElement("canvas"),img=document.createElement("img");img.onload=function(){var ctx=canvas.getContext("2d");canvas.width=img.width,canvas.height=img.height,ctx.drawImage(img,0,0);try{var type=(url.split(".").pop()||"png","jpeg"),dataUri=canvas.toDataURL(type)}catch(e){if(/\.svg$/.test(url)){var xhr=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");xhr.open("GET",url,!1),xhr.send(null);var svg=xhr.responseText;return callback(null,"data:image/svg+xml,"+encodeURIComponent(svg))}}callback(null,dataUri)},img.ononerror=function(){callback(new Error("Failed to load image."))},img.src=url},getElementBBox:function(el){var bbox,$el=$(el),offset=$el.offset();if(el.ownerSVGElement){bbox=V(el).bbox();var crect=el.getBoundingClientRect(),strokeWidthX=(crect.width-bbox.width)/2,strokeWidthY=(crect.height-bbox.height)/2;bbox.x=offset.left+strokeWidthX,bbox.y=offset.top+strokeWidthY}else bbox={x:offset.left,y:offset.top,width:$el.outerWidth(),height:$el.outerHeight()};return bbox},sortElements:function(elements,comparator){var $elements=$(elements),placements=$elements.map(function(){var sortElement=this,parentNode=sortElement.parentNode,nextSibling=parentNode.insertBefore(document.createTextNode(""),sortElement.nextSibling);return function(){if(parentNode===this)throw new Error("You can't sort elements if any one is a descendant of another.");parentNode.insertBefore(this,nextSibling),parentNode.removeChild(nextSibling)}});return Array.prototype.sort.call($elements,comparator).each(function(i){placements[i].call(this)})},setAttributesBySelector:function(element,attrs){var $element=$(element);_.each(attrs,function(attrs,selector){var $elements=$element.find(selector).addBack().filter(selector);_.has(attrs,"class")&&($elements.addClass(attrs["class"]),attrs=_.omit(attrs,"class")),$elements.attr(attrs)})},normalizeSides:function(box){return Object(box)!==box?(box=box||0,{top:box,bottom:box,left:box,right:box}):{top:box.top||0,bottom:box.bottom||0,left:box.left||0,right:box.right||0}},timing:{linear:function(t){return t},quad:function(t){return t*t},cubic:function(t){return t*t*t},inout:function(t){if(t<=0)return 0;if(t>=1)return 1;var t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75)},exponential:function(t){return Math.pow(2,10*(t-1))},bounce:function(t){for(var a=0,b=1;1;a+=b,b/=2)if(t>=(7-4*a)/11){var q=(11-6*a-11*t)/4;return-q*q+b*b}},reverse:function(f){return function(t){return 1-f(1-t)}},reflect:function(f){return function(t){return.5*(t<.5?f(2*t):2-f(2-2*t))}},clamp:function(f,n,x){return n=n||0,x=x||1,function(t){var r=f(t);return r<n?n:r>x?x:r}},back:function(s){return s||(s=1.70158),function(t){return t*t*((s+1)*t-s)}},elastic:function(x){return x||(x=1.5),function(t){return Math.pow(2,10*(t-1))*Math.cos(20*Math.PI*x/3*t)}}},interpolate:{number:function(a,b){var d=b-a;return function(t){return a+d*t}},object:function(a,b){var s=_.keys(a);return function(t){var i,p,r={};for(i=s.length-1;i!=-1;i--)p=s[i],r[p]=a[p]+(b[p]-a[p])*t;return r}},hexColor:function(a,b){var ca=parseInt(a.slice(1),16),cb=parseInt(b.slice(1),16),ra=255&ca,rd=(255&cb)-ra,ga=65280&ca,gd=(65280&cb)-ga,ba=16711680&ca,bd=(16711680&cb)-ba;return function(t){var r=ra+rd*t&255,g=ga+gd*t&65280,b=ba+bd*t&16711680;return"#"+(1<<24|r|g|b).toString(16).slice(1)}},unit:function(a,b){var r=/(-?[0-9]*.[0-9]*)(px|em|cm|mm|in|pt|pc|%)/,ma=r.exec(a),mb=r.exec(b),p=mb[1].indexOf("."),f=p>0?mb[1].length-p-1:0;a=+ma[1];var d=+mb[1]-a,u=ma[2];return function(t){return(a+d*t).toFixed(f)+u}}},filter:{outline:function(args){var tpl='<filter><feFlood flood-color="${color}" flood-opacity="${opacity}" result="colored"/><feMorphology in="SourceAlpha" result="morphedOuter" operator="dilate" radius="${outerRadius}" /><feMorphology in="SourceAlpha" result="morphedInner" operator="dilate" radius="${innerRadius}" /><feComposite result="morphedOuterColored" in="colored" in2="morphedOuter" operator="in"/><feComposite operator="xor" in="morphedOuterColored" in2="morphedInner" result="outline"/><feMerge><feMergeNode in="outline"/><feMergeNode in="SourceGraphic"/></feMerge></filter>',margin=_.isFinite(args.margin)?args.margin:2,width=_.isFinite(args.width)?args.width:1;return joint.util.template(tpl)({color:args.color||"blue",opacity:_.isFinite(args.opacity)?args.opacity:1,outerRadius:margin+width,innerRadius:margin})},highlight:function(args){var tpl='<filter><feFlood flood-color="${color}" flood-opacity="${opacity}" result="colored"/><feMorphology result="morphed" in="SourceGraphic" operator="dilate" radius="${width}"/><feComposite result="composed" in="colored" in2="morphed" operator="in"/><feGaussianBlur result="blured" in="composed" stdDeviation="${blur}"/><feBlend in="SourceGraphic" in2="blured" mode="normal"/></filter>';return joint.util.template(tpl)({color:args.color||"red",width:_.isFinite(args.width)?args.width:1,blur:_.isFinite(args.blur)?args.blur:0,opacity:_.isFinite(args.opacity)?args.opacity:1})},blur:function(args){var x=_.isFinite(args.x)?args.x:2;return joint.util.template('<filter><feGaussianBlur stdDeviation="${stdDeviation}"/></filter>')({stdDeviation:_.isFinite(args.y)?[x,args.y]:x})},dropShadow:function(args){var tpl="SVGFEDropShadowElement"in window?'<filter><feDropShadow stdDeviation="${blur}" dx="${dx}" dy="${dy}" flood-color="${color}" flood-opacity="${opacity}"/></filter>':'<filter><feGaussianBlur in="SourceAlpha" stdDeviation="${blur}"/><feOffset dx="${dx}" dy="${dy}" result="offsetblur"/><feFlood flood-color="${color}"/><feComposite in2="offsetblur" operator="in"/><feComponentTransfer><feFuncA type="linear" slope="${opacity}"/></feComponentTransfer><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter>';return joint.util.template(tpl)({dx:args.dx||0,dy:args.dy||0,opacity:_.isFinite(args.opacity)?args.opacity:1,color:args.color||"black",blur:_.isFinite(args.blur)?args.blur:4})},grayscale:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return joint.util.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${b} ${h} 0 0 0 0 0 1 0"/></filter>')({a:.2126+.7874*(1-amount),b:.7152-.7152*(1-amount),c:.0722-.0722*(1-amount),d:.2126-.2126*(1-amount),e:.7152+.2848*(1-amount),f:.0722-.0722*(1-amount),g:.2126-.2126*(1-amount),h:.0722+.9278*(1-amount)})},sepia:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return joint.util.template('<filter><feColorMatrix type="matrix" values="${a} ${b} ${c} 0 0 ${d} ${e} ${f} 0 0 ${g} ${h} ${i} 0 0 0 0 0 1 0"/></filter>')({a:.393+.607*(1-amount),b:.769-.769*(1-amount),c:.189-.189*(1-amount),d:.349-.349*(1-amount),e:.686+.314*(1-amount),f:.168-.168*(1-amount),g:.272-.272*(1-amount),h:.534-.534*(1-amount),i:.131+.869*(1-amount)})},saturate:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return joint.util.template('<filter><feColorMatrix type="saturate" values="${amount}"/></filter>')({amount:1-amount})},hueRotate:function(args){return joint.util.template('<filter><feColorMatrix type="hueRotate" values="${angle}"/></filter>')({angle:args.angle||0})},invert:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return joint.util.template('<filter><feComponentTransfer><feFuncR type="table" tableValues="${amount} ${amount2}"/><feFuncG type="table" tableValues="${amount} ${amount2}"/><feFuncB type="table" tableValues="${amount} ${amount2}"/></feComponentTransfer></filter>')({amount:amount,amount2:1-amount})},brightness:function(args){return joint.util.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}"/><feFuncG type="linear" slope="${amount}"/><feFuncB type="linear" slope="${amount}"/></feComponentTransfer></filter>')({amount:_.isFinite(args.amount)?args.amount:1})},contrast:function(args){var amount=_.isFinite(args.amount)?args.amount:1;return joint.util.template('<filter><feComponentTransfer><feFuncR type="linear" slope="${amount}" intercept="${amount2}"/><feFuncG type="linear" slope="${amount}" intercept="${amount2}"/><feFuncB type="linear" slope="${amount}" intercept="${amount2}"/></feComponentTransfer></filter>')({amount:amount,amount2:.5-amount/2})}},format:{number:function(specifier,value,locale){function formatGroup(value){for(var i=value.length,t=[],j=0,g=locale.grouping[0];i>0&&g>0;)t.push(value.substring(i-=g,i+g)),g=locale.grouping[j=(j+1)%locale.grouping.length];return t.reverse().join(locale.thousands)}locale=locale||{currency:["$",""],decimal:".",thousands:",",grouping:[3]};var re=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i,match=re.exec(specifier),fill=match[1]||" ",align=match[2]||">",sign=match[3]||"",symbol=match[4]||"",zfill=match[5],width=+match[6],comma=match[7],precision=match[8],type=match[9],scale=1,prefix="",suffix="",integer=!1;switch(precision&&(precision=+precision.substring(1)),(zfill||"0"===fill&&"="===align)&&(zfill=fill="0",align="=",comma&&(width-=Math.floor((width-1)/4))),type){case"n":comma=!0,type="g";break;case"%":scale=100,suffix="%",type="f";break;case"p":scale=100,suffix="%",type="r";break;case"b":case"o":case"x":case"X":"#"===symbol&&(prefix="0"+type.toLowerCase());case"c":case"d":integer=!0,precision=0;break;case"s":scale=-1,type="r"}"$"===symbol&&(prefix=locale.currency[0],suffix=locale.currency[1]),"r"!=type||precision||(type="g"),null!=precision&&("g"==type?precision=Math.max(1,Math.min(21,precision)):"e"!=type&&"f"!=type||(precision=Math.max(0,Math.min(20,precision))));var zcomma=zfill&&comma;if(integer&&value%1)return"";var negative=value<0||0===value&&1/value<0?(value=-value,"-"):sign,fullSuffix=suffix;if(scale<0){var unit=this.prefix(value,precision);value=unit.scale(value),fullSuffix=unit.symbol+suffix}else value*=scale;value=this.convert(type,value,precision);var i=value.lastIndexOf("."),before=i<0?value:value.substring(0,i),after=i<0?"":locale.decimal+value.substring(i+1);!zfill&&comma&&locale.grouping&&(before=formatGroup(before));var length=prefix.length+before.length+after.length+(zcomma?0:negative.length),padding=length<width?new Array(length=width-length+1).join(fill):"";return zcomma&&(before=formatGroup(padding+before)),negative+=prefix,value=before+after,("<"===align?negative+value+padding:">"===align?padding+negative+value:"^"===align?padding.substring(0,length>>=1)+negative+value+padding.substring(length):negative+(zcomma?value:padding+value))+fullSuffix},string:function(formatString,value){for(var fieldDelimiterIndex,fieldDelimiter="{",endPlaceholder=!1,formattedStringArray=[];(fieldDelimiterIndex=formatString.indexOf(fieldDelimiter))!==-1;){var pieceFormatedString,formatSpec,fieldName;if(pieceFormatedString=formatString.slice(0,fieldDelimiterIndex),endPlaceholder){formatSpec=pieceFormatedString.split(":"),fieldName=formatSpec.shift().split("."),pieceFormatedString=value;for(var i=0;i<fieldName.length;i++)pieceFormatedString=pieceFormatedString[fieldName[i]];formatSpec.length&&(pieceFormatedString=this.number(formatSpec,pieceFormatedString))}formattedStringArray.push(pieceFormatedString),formatString=formatString.slice(fieldDelimiterIndex+1),fieldDelimiter=(endPlaceholder=!endPlaceholder)?"}":"{"}return formattedStringArray.push(formatString),formattedStringArray.join("")},convert:function(type,value,precision){switch(type){case"b":return value.toString(2);case"c":return String.fromCharCode(value);case"o":return value.toString(8);case"x":return value.toString(16);case"X":return value.toString(16).toUpperCase();case"g":return value.toPrecision(precision);case"e":return value.toExponential(precision);case"f":return value.toFixed(precision);case"r":return(value=this.round(value,this.precision(value,precision))).toFixed(Math.max(0,Math.min(20,this.precision(value*(1+1e-15),precision))));default:return value+""}},round:function(value,precision){return precision?Math.round(value*(precision=Math.pow(10,precision)))/precision:Math.round(value)},precision:function(value,precision){return precision-(value?Math.ceil(Math.log(value)/Math.LN10):1)},prefix:function(value,precision){var prefixes=_.map(["y","z","a","f","p","n","Âµ","m","","k","M","G","T","P","E","Z","Y"],function(d,i){var k=Math.pow(10,3*Math.abs(8-i));return{scale:i>8?function(d){return d/k}:function(d){return d*k},symbol:d}}),i=0;return value&&(value<0&&(value*=-1),precision&&(value=this.round(value,this.precision(value,precision))),i=1+Math.floor(1e-12+Math.log(value)/Math.LN10),i=Math.max(-24,Math.min(24,3*Math.floor((i<=0?i+1:i-1)/3)))),prefixes[8+i/3]}},template:function(html){var regex=/<%= ([^ ]+) %>|\$\{ ?([^\{\} ]+) ?\}|\{\{([^\{\} ]+)\}\}/g;return function(data){return html.replace(regex,function(match){for(var args=Array.prototype.slice.call(arguments),attr=_.find(args.slice(1,4),function(_attr){return!!_attr}),attrArray=attr.split("."),value=data[attrArray.shift()];!_.isUndefined(value)&&attrArray.length;)value=value[attrArray.shift()];return _.isUndefined(value)?"":value})}},toggleFullScreen:function(el){function prefixedResult(el,prop){for(var prefixes=["webkit","moz","ms","o",""],i=0;i<prefixes.length;i++){var prefix=prefixes[i],propName=prefix?prefix+prop:prop.substr(0,1).toLowerCase()+prop.substr(1);if(!_.isUndefined(el[propName]))return _.isFunction(el[propName])?el[propName]():el[propName]}}el=el||document.body,prefixedResult(document,"FullScreen")||prefixedResult(document,"IsFullScreen")?prefixedResult(document,"CancelFullScreen"):prefixedResult(el,"RequestFullScreen")},wrapWith:function(object,methods,wrapper){if(_.isString(wrapper)){if(!joint.util.wrappers[wrapper])throw new Error('Unknown wrapper: "'+wrapper+'"');wrapper=joint.util.wrappers[wrapper]}if(!_.isFunction(wrapper))throw new Error("Wrapper must be a function.");_.each(methods,function(method){object[method]=wrapper(object[method])})},wrappers:{cells:function(fn){return function(){var args=Array.prototype.slice.call(arguments),cells=args.length>0&&_.first(args)||[],opt=args.length>1&&_.last(args)||{};return _.isArray(cells)||(opt instanceof joint.dia.Cell?(cells=args,opt={}):cells=_.initial(args)),fn.call(this,cells,opt)}}}}};return joint.mvc.View=Backbone.View.extend({options:{},theme:null,themeClassNamePrefix:"joint-theme-",requireSetThemeOverride:!1,defaultTheme:"default",constructor:function(options){Backbone.View.call(this,options)},initialize:function(options){this.requireSetThemeOverride=options&&!!options.theme,this.options=_.extend({},this.options,options),_.bindAll(this,"setTheme","onSetTheme","remove","onRemove"),joint.mvc.views[this.cid]=this,this.setTheme(this.options.theme||this.defaultTheme),this._ensureElClassName(),this.init()},_ensureElClassName:function(){var className=_.result(this,"className");this.$el.addClass(className)},init:function(){},onRender:function(){},setTheme:function(theme,opt){if(opt=opt||{},!this.theme||!this.requireSetThemeOverride||opt.override)return this.theme&&this.$el.removeClass(this.themeClassNamePrefix+this.theme),this.$el.addClass(this.themeClassNamePrefix+theme),this.onSetTheme(this.theme,theme),this.theme=theme,this},onSetTheme:function(oldTheme,newTheme){},remove:function(){return this.onRemove(),joint.mvc.views[this.cid]=null,Backbone.View.prototype.remove.apply(this,arguments),this},onRemove:function(){}}),function(){joint.mvc.View._extend=joint.mvc.View.extend,joint.mvc.View.extend=function(protoProps,staticProps){protoProps=protoProps||{};var render=protoProps.render||this.prototype.render||null;return protoProps.render=function(){return render&&render.apply(this,arguments),this.onRender(),this},joint.mvc.View._extend.call(this,protoProps,staticProps)}}(),joint.dia.GraphCells=Backbone.Collection.extend({cellNamespace:joint.shapes,initialize:function(models,opt){opt.cellNamespace&&(this.cellNamespace=opt.cellNamespace),this.graph=opt.graph},model:function(attrs,options){var collection=options.collection,namespace=collection.cellNamespace,ModelClass="link"===attrs.type?joint.dia.Link:joint.util.getByPath(namespace,attrs.type,".")||joint.dia.Element,cell=new ModelClass(attrs,options);return cell.graph=collection.graph,cell},comparator:function(model){return model.get("z")||0}}),joint.dia.Graph=Backbone.Model.extend({_batches:{},initialize:function(attrs,opt){opt=opt||{};var cells=new joint.dia.GraphCells([],{model:opt.cellModel,cellNamespace:opt.cellNamespace,graph:this});Backbone.Model.prototype.set.call(this,"cells",cells),cells.on("all",this.trigger,this),this.on("change:z",this._sortOnChangeZ,this),this.on("batch:stop",this._onBatchStop,this),this._out={},this._in={},this._nodes={},this._edges={},cells.on("add",this._restructureOnAdd,this),cells.on("remove",this._restructureOnRemove,this),cells.on("reset",this._restructureOnReset,this),cells.on("change:source",this._restructureOnChangeSource,this),cells.on("change:target",this._restructureOnChangeTarget,this),cells.on("remove",this._removeCell,this)},_sortOnChangeZ:function(){this.hasActiveBatch("to-front")||this.hasActiveBatch("to-back")||this.get("cells").sort()},_onBatchStop:function(data){var batchName=data&&data.batchName;"to-front"!==batchName&&"to-back"!==batchName||this.hasActiveBatch(batchName)||this.get("cells").sort()},_restructureOnAdd:function(cell){if(cell.isLink()){this._edges[cell.id]=!0;var source=cell.get("source"),target=cell.get("target");source.id&&((this._out[source.id]||(this._out[source.id]={}))[cell.id]=!0),target.id&&((this._in[target.id]||(this._in[target.id]={}))[cell.id]=!0)}else this._nodes[cell.id]=!0},_restructureOnRemove:function(cell){if(cell.isLink()){delete this._edges[cell.id];var source=cell.get("source"),target=cell.get("target");source.id&&this._out[source.id]&&this._out[source.id][cell.id]&&delete this._out[source.id][cell.id],target.id&&this._in[target.id]&&this._in[target.id][cell.id]&&delete this._in[target.id][cell.id]}else delete this._nodes[cell.id]},_restructureOnReset:function(cells){cells=cells.models,this._out={},this._in={},this._nodes={},this._edges={},_.each(cells,this._restructureOnAdd,this)},_restructureOnChangeSource:function(link){var prevSource=link.previous("source");prevSource.id&&this._out[prevSource.id]&&delete this._out[prevSource.id][link.id];var source=link.get("source");source.id&&((this._out[source.id]||(this._out[source.id]={}))[link.id]=!0)},_restructureOnChangeTarget:function(link){var prevTarget=link.previous("target");prevTarget.id&&this._in[prevTarget.id]&&delete this._in[prevTarget.id][link.id];var target=link.get("target");target.id&&((this._in[target.id]||(this._in[target.id]={}))[link.id]=!0)},getOutboundEdges:function(node){return this._out&&this._out[node]||{}},getInboundEdges:function(node){return this._in&&this._in[node]||{}},toJSON:function(){var json=Backbone.Model.prototype.toJSON.apply(this,arguments);return json.cells=this.get("cells").toJSON(),json},fromJSON:function(json,opt){if(!json.cells)throw new Error("Graph JSON must contain cells array.");return this.set(json,opt)},set:function(key,val,opt){var attrs;return"object"==typeof key?(attrs=key,opt=val):(attrs={})[key]=val,attrs.hasOwnProperty("cells")&&(this.resetCells(attrs.cells,opt),attrs=_.omit(attrs,"cells")),Backbone.Model.prototype.set.call(this,attrs,opt)},clear:function(opt){opt=_.extend({},opt,{clear:!0});var collection=this.get("cells");if(0===collection.length)return this;this.startBatch("clear",opt);var cells=collection.sortBy(function(cell){return cell.isLink()?1:2});do cells.shift().remove(opt);while(cells.length>0);return this.stopBatch("clear"),this},_prepareCell:function(cell){var attrs;if(cell instanceof Backbone.Model?(attrs=cell.attributes,cell.graph=this):attrs=cell,!_.isString(attrs.type))throw new TypeError("dia.Graph: cell type must be a string.");return cell},maxZIndex:function(){var lastCell=this.get("cells").last();return lastCell?lastCell.get("z")||0:0},addCell:function(cell,options){return _.isArray(cell)?this.addCells(cell,options):(cell instanceof Backbone.Model?cell.has("z")||cell.set("z",this.maxZIndex()+1):_.isUndefined(cell.z)&&(cell.z=this.maxZIndex()+1),this.get("cells").add(this._prepareCell(cell),options||{}),this)},addCells:function(cells,opt){return cells.length&&(opt.position=cells.length,this.startBatch("add"),_.each(cells,function(cell){opt.position--,this.addCell(cell,opt)},this),this.stopBatch("add")),this},resetCells:function(cells,opt){return this.get("cells").reset(_.map(cells,this._prepareCell,this),opt),this},removeCells:function(cells,opt){return cells.length&&(this.startBatch("remove"),_.invoke(cells,"remove",opt),this.stopBatch("remove")),this},_removeCell:function(cell,collection,options){
options=options||{},options.clear||(options.disconnectLinks?this.disconnectLinks(cell,options):this.removeLinks(cell,options)),this.get("cells").remove(cell,{silent:!0}),delete cell.graph},getCell:function(id){return this.get("cells").get(id)},getCells:function(){return this.get("cells").toArray()},getElements:function(){return _.map(this._nodes,function(exists,node){return this.getCell(node)},this)},getLinks:function(){return _.map(this._edges,function(exists,edge){return this.getCell(edge)},this)},getFirstCell:function(){return this.get("cells").first()},getLastCell:function(){return this.get("cells").last()},getConnectedLinks:function(model,opt){opt=opt||{};var inbound=opt.inbound,outbound=opt.outbound;_.isUndefined(inbound)&&_.isUndefined(outbound)&&(inbound=outbound=!0);var links=[],edges={};if(outbound&&_.each(this.getOutboundEdges(model.id),function(exists,edge){edges[edge]||(links.push(this.getCell(edge)),edges[edge]=!0)},this),inbound&&_.each(this.getInboundEdges(model.id),function(exists,edge){edges[edge]||(links.push(this.getCell(edge)),edges[edge]=!0)},this),opt.deep){var embeddedCells=model.getEmbeddedCells({deep:!0}),embeddedEdges={};_.each(embeddedCells,function(cell){cell.isLink()&&(embeddedEdges[cell.id]=!0)}),_.each(embeddedCells,function(cell){cell.isLink()||(outbound&&_.each(this.getOutboundEdges(cell.id),function(exists,edge){edges[edge]||embeddedEdges[edge]||(links.push(this.getCell(edge)),edges[edge]=!0)},this),inbound&&_.each(this.getInboundEdges(cell.id),function(exists,edge){edges[edge]||embeddedEdges[edge]||(links.push(this.getCell(edge)),edges[edge]=!0)},this))},this)}return links},getNeighbors:function(model,opt){opt=opt||{};var inbound=opt.inbound,outbound=opt.outbound;_.isUndefined(inbound)&&_.isUndefined(outbound)&&(inbound=outbound=!0);var neighbors=_.transform(this.getConnectedLinks(model,opt),function(res,link){var source=link.get("source"),target=link.get("target"),loop=link.hasLoop(opt);if(inbound&&_.has(source,"id")&&!res[source.id]){var sourceElement=this.getCell(source.id);!loop&&(!sourceElement||sourceElement===model||opt.deep&&sourceElement.isEmbeddedIn(model))||(res[source.id]=sourceElement)}if(outbound&&_.has(target,"id")&&!res[target.id]){var targetElement=this.getCell(target.id);!loop&&(!targetElement||targetElement===model||opt.deep&&targetElement.isEmbeddedIn(model))||(res[target.id]=targetElement)}},{},this);return _.values(neighbors)},getCommonAncestor:function(){var cellsAncestors=_.map(arguments,function(cell){for(var ancestors=[],parentId=cell.get("parent");parentId;)ancestors.push(parentId),parentId=this.getCell(parentId).get("parent");return ancestors},this);cellsAncestors=_.sortBy(cellsAncestors,"length");var commonAncestor=_.find(cellsAncestors.shift(),function(ancestor){return _.every(cellsAncestors,function(cellAncestors){return _.contains(cellAncestors,ancestor)})});return this.getCell(commonAncestor)},getSuccessors:function(element,opt){opt=opt||{};var res=[];return this.search(element,function(el){el!==element&&res.push(el)},_.extend({},opt,{outbound:!0})),res},cloneCells:function(cells){cells=_.unique(cells);var cloneMap=_.transform(cells,function(map,cell){map[cell.id]=cell.clone()},{});return _.each(cells,function(cell){var clone=cloneMap[cell.id];if(clone.isLink()){var source=clone.get("source"),target=clone.get("target");source.id&&cloneMap[source.id]&&clone.prop("source/id",cloneMap[source.id].id),target.id&&cloneMap[target.id]&&clone.prop("target/id",cloneMap[target.id].id)}var parent=cell.get("parent");parent&&cloneMap[parent]&&clone.set("parent",cloneMap[parent].id);var embeds=_.reduce(cell.get("embeds"),function(newEmbeds,embed){return cloneMap[embed]&&newEmbeds.push(cloneMap[embed].id),newEmbeds},[]);_.isEmpty(embeds)||clone.set("embeds",embeds)}),cloneMap},cloneSubgraph:function(cells,opt){var subgraph=this.getSubgraph(cells,opt);return this.cloneCells(subgraph)},getSubgraph:function(cells,opt){opt=opt||{};var subgraph=[],cellMap={},elements=[],links=[];return _.each(cells,function(cell){if(cellMap[cell.id]||(subgraph.push(cell),cellMap[cell.id]=cell,cell.isLink()?links.push(cell):elements.push(cell)),opt.deep){var embeds=cell.getEmbeddedCells({deep:!0});_.each(embeds,function(embed){cellMap[embed.id]||(subgraph.push(embed),cellMap[embed.id]=embed,embed.isLink()?links.push(embed):elements.push(embed))})}}),_.each(links,function(link){var source=link.get("source"),target=link.get("target");if(source.id&&!cellMap[source.id]){var sourceElement=this.getCell(source.id);subgraph.push(sourceElement),cellMap[sourceElement.id]=sourceElement,elements.push(sourceElement)}if(target.id&&!cellMap[target.id]){var targetElement=this.getCell(target.id);subgraph.push(this.getCell(target.id)),cellMap[targetElement.id]=targetElement,elements.push(targetElement)}},this),_.each(elements,function(element){var links=this.getConnectedLinks(element,opt);_.each(links,function(link){var source=link.get("source"),target=link.get("target");!cellMap[link.id]&&source.id&&cellMap[source.id]&&target.id&&cellMap[target.id]&&(subgraph.push(link),cellMap[link.id]=link)})},this),subgraph},getPredecessors:function(element,opt){opt=opt||{};var res=[];return this.search(element,function(el){el!==element&&res.push(el)},_.extend({},opt,{inbound:!0})),res},search:function(element,iteratee,opt){opt=opt||{},opt.breadthFirst?this.bfs(element,iteratee,opt):this.dfs(element,iteratee,opt)},bfs:function(element,iteratee,opt){opt=opt||{};var visited={},distance={},queue=[];for(queue.push(element),distance[element.id]=0;queue.length>0;){var next=queue.shift();if(!visited[next.id]){if(visited[next.id]=!0,iteratee(next,distance[next.id])===!1)return;_.each(this.getNeighbors(next,opt),function(neighbor){distance[neighbor.id]=distance[next.id]+1,queue.push(neighbor)})}}},dfs:function(element,iteratee,opt,_visited,_distance){opt=opt||{};var visited=_visited||{},distance=_distance||0;iteratee(element,distance)!==!1&&(visited[element.id]=!0,_.each(this.getNeighbors(element,opt),function(neighbor){visited[neighbor.id]||this.dfs(neighbor,iteratee,opt,visited,distance+1)},this))},getSources:function(){var sources=[];return _.each(this._nodes,function(exists,node){this._in[node]&&!_.isEmpty(this._in[node])||sources.push(this.getCell(node))},this),sources},getSinks:function(){var sinks=[];return _.each(this._nodes,function(exists,node){this._out[node]&&!_.isEmpty(this._out[node])||sinks.push(this.getCell(node))},this),sinks},isSource:function(element){return!this._in[element.id]||_.isEmpty(this._in[element.id])},isSink:function(element){return!this._out[element.id]||_.isEmpty(this._out[element.id])},isSuccessor:function(elementA,elementB){var isSuccessor=!1;return this.search(elementA,function(element){if(element===elementB&&element!==elementA)return isSuccessor=!0,!1},{outbound:!0}),isSuccessor},isPredecessor:function(elementA,elementB){var isPredecessor=!1;return this.search(elementA,function(element){if(element===elementB&&element!==elementA)return isPredecessor=!0,!1},{inbound:!0}),isPredecessor},isNeighbor:function(elementA,elementB,opt){opt=opt||{};var inbound=opt.inbound,outbound=opt.outbound;_.isUndefined(inbound)&&_.isUndefined(outbound)&&(inbound=outbound=!0);var isNeighbor=!1;return _.each(this.getConnectedLinks(elementA,opt),function(link){var source=link.get("source"),target=link.get("target");link.hasLoop(opt);return inbound&&_.has(source,"id")&&source.id===elementB.id?(isNeighbor=!0,!1):outbound&&_.has(target,"id")&&target.id===elementB.id?(isNeighbor=!0,!1):void 0}),isNeighbor},disconnectLinks:function(model,options){_.each(this.getConnectedLinks(model),function(link){link.set(link.get("source").id===model.id?"source":"target",g.point(0,0),options)})},removeLinks:function(model,options){_.invoke(this.getConnectedLinks(model),"remove",options)},findModelsFromPoint:function(p){return _.filter(this.getElements(),function(el){return el.getBBox().containsPoint(p)})},findModelsInArea:function(rect,opt){rect=g.rect(rect),opt=_.defaults(opt||{},{strict:!1});var method=opt.strict?"containsRect":"intersect";return _.filter(this.getElements(),function(el){return rect[method](el.getBBox())})},findModelsUnderElement:function(element,opt){opt=_.defaults(opt||{},{searchBy:"bbox"});var bbox=element.getBBox(),elements="bbox"==opt.searchBy?this.findModelsInArea(bbox):this.findModelsFromPoint(bbox[opt.searchBy]());return _.reject(elements,function(el){return element.id==el.id||el.isEmbeddedIn(element)})},getBBox:function(cells,opt){return this.getCellsBBox(cells||this.getElements(),opt)},getCellsBBox:function(cells,opt){return _.reduce(cells,function(memo,cell){return cell.isLink()?memo:memo?memo.union(cell.getBBox(opt)):cell.getBBox(opt)},null)},translate:function(dx,dy,opt){var cells=_.reject(this.getCells(),function(cell){return cell.isEmbedded()});_.invoke(cells,"translate",dx,dy,opt)},resize:function(width,height,opt){return this.resizeCells(width,height,this.getCells(),opt)},resizeCells:function(width,height,cells,opt){var bbox=this.getCellsBBox(cells);if(bbox){var sx=Math.max(width/bbox.width,0),sy=Math.max(height/bbox.height,0);_.invoke(cells,"scale",sx,sy,bbox.origin(),opt)}return this},startBatch:function(name,data){return data=data||{},this._batches[name]=(this._batches[name]||0)+1,this.trigger("batch:start",_.extend({},data,{batchName:name}))},stopBatch:function(name,data){return data=data||{},this._batches[name]=(this._batches[name]||0)-1,this.trigger("batch:stop",_.extend({},data,{batchName:name}))},hasActiveBatch:function(name){return name?this._batches[name]:_.any(this._batches,function(batches){return batches>0})}}),joint.util.wrapWith(joint.dia.Graph.prototype,["resetCells","addCells","removeCells"],"cells"),joint.dia.Cell=Backbone.Model.extend({constructor:function(attributes,options){var defaults,attrs=attributes||{};this.cid=_.uniqueId("c"),this.attributes={},options&&options.collection&&(this.collection=options.collection),options&&options.parse&&(attrs=this.parse(attrs,options)||{}),(defaults=_.result(this,"defaults"))&&(attrs=_.merge({},defaults,attrs)),this.set(attrs,options),this.changed={},this.initialize.apply(this,arguments)},translate:function(dx,dy,opt){throw new Error("Must define a translate() method.")},toJSON:function(){var defaultAttrs=this.constructor.prototype.defaults.attrs||{},attrs=this.attributes.attrs,finalAttrs={};_.each(attrs,function(attr,selector){var defaultAttr=defaultAttrs[selector];_.each(attr,function(value,name){_.isObject(value)&&!_.isArray(value)?_.each(value,function(value2,name2){defaultAttr&&defaultAttr[name]&&_.isEqual(defaultAttr[name][name2],value2)||(finalAttrs[selector]=finalAttrs[selector]||{},(finalAttrs[selector][name]||(finalAttrs[selector][name]={}))[name2]=value2)}):defaultAttr&&_.isEqual(defaultAttr[name],value)||(finalAttrs[selector]=finalAttrs[selector]||{},finalAttrs[selector][name]=value)})});var attributes=_.cloneDeep(_.omit(this.attributes,"attrs"));return attributes.attrs=finalAttrs,attributes},initialize:function(options){options&&options.id||this.set("id",joint.util.uuid(),{silent:!0}),this._transitionIds={},this.processPorts(),this.on("change:attrs",this.processPorts,this)},processPorts:function(){var previousPorts=this.ports,ports={};_.each(this.get("attrs"),function(attrs,selector){attrs&&attrs.port&&(_.isUndefined(attrs.port.id)?ports[attrs.port]={id:attrs.port}:ports[attrs.port.id]=attrs.port)});var removedPorts={};if(_.each(previousPorts,function(port,id){ports[id]||(removedPorts[id]=!0)}),this.graph&&!_.isEmpty(removedPorts)){var inboundLinks=this.graph.getConnectedLinks(this,{inbound:!0});_.each(inboundLinks,function(link){removedPorts[link.get("target").port]&&link.remove()});var outboundLinks=this.graph.getConnectedLinks(this,{outbound:!0});_.each(outboundLinks,function(link){removedPorts[link.get("source").port]&&link.remove()})}this.ports=ports},remove:function(opt){opt=opt||{};var graph=this.graph;graph&&graph.startBatch("remove");var parentCellId=this.get("parent");if(parentCellId){var parentCell=graph&&graph.getCell(parentCellId);parentCell.unembed(this)}return _.invoke(this.getEmbeddedCells(),"remove",opt),this.trigger("remove",this,this.collection,opt),graph&&graph.stopBatch("remove"),this},toFront:function(opt){if(this.graph){opt=opt||{};var z=(this.graph.getLastCell().get("z")||0)+1;if(this.startBatch("to-front").set("z",z,opt),opt.deep){var cells=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.each(cells,function(cell){cell.set("z",++z,opt)})}this.stopBatch("to-front")}return this},toBack:function(opt){if(this.graph){opt=opt||{};var z=(this.graph.getFirstCell().get("z")||0)-1;if(this.startBatch("to-back"),opt.deep){var cells=this.getEmbeddedCells({deep:!0,breadthFirst:!0});_.eachRight(cells,function(cell){cell.set("z",z--,opt)})}this.set("z",z,opt).stopBatch("to-back")}return this},embed:function(cell,opt){if(this===cell||this.isEmbeddedIn(cell))throw new Error("Recursive embedding not allowed.");this.startBatch("embed");var embeds=_.clone(this.get("embeds")||[]);return embeds[cell.isLink()?"unshift":"push"](cell.id),cell.set("parent",this.id,opt),this.set("embeds",_.uniq(embeds),opt),this.stopBatch("embed"),this},unembed:function(cell,opt){return this.startBatch("unembed"),cell.unset("parent",opt),this.set("embeds",_.without(this.get("embeds"),cell.id),opt),this.stopBatch("unembed"),this},getAncestors:function(){var ancestors=[],parentId=this.get("parent");if(!this.graph)return ancestors;for(;void 0!==parentId;){var parent=this.graph.getCell(parentId);if(void 0===parent)break;ancestors.push(parent),parentId=parent.get("parent")}return ancestors},getEmbeddedCells:function(opt){if(opt=opt||{},this.graph){var cells;if(opt.deep)if(opt.breadthFirst){cells=[];for(var queue=this.getEmbeddedCells();queue.length>0;){var parent=queue.shift();cells.push(parent),queue.push.apply(queue,parent.getEmbeddedCells())}}else cells=this.getEmbeddedCells(),_.each(cells,function(cell){cells.push.apply(cells,cell.getEmbeddedCells(opt))});else cells=_.map(this.get("embeds"),this.graph.getCell,this.graph);return cells}return[]},isEmbeddedIn:function(cell,opt){var cellId=_.isString(cell)?cell:cell.id,parentId=this.get("parent");if(opt=_.defaults({deep:!0},opt),this.graph&&opt.deep){for(;parentId;){if(parentId===cellId)return!0;parentId=this.graph.getCell(parentId).get("parent")}return!1}return parentId===cellId},isEmbedded:function(){return!!this.get("parent")},clone:function(opt){if(opt=opt||{},opt.deep)return _.values(joint.dia.Graph.prototype.cloneCells.call(null,[this].concat(this.getEmbeddedCells({deep:!0}))));var clone=Backbone.Model.prototype.clone.apply(this,arguments);return clone.set("id",joint.util.uuid()),clone.unset("embeds"),clone.unset("parent"),clone},prop:function(props,value,opt){var delim="/";if(_.isString(props)){if(arguments.length>1){var path=props,pathArray=path.split("/"),property=pathArray[0];if(pathArray.shift(),opt=opt||{},opt.propertyPath=path,opt.propertyValue=value,0===pathArray.length)return this.set(property,value,opt);var update={},initializer=update,prevProperty=property;_.each(pathArray,function(key){initializer=initializer[prevProperty]=_.isFinite(Number(key))?[]:{},prevProperty=key}),update=joint.util.setByPath(update,path,value,"/");var baseAttributes=_.merge({},this.attributes);opt.rewrite&&joint.util.unsetByPath(baseAttributes,path,"/");var attributes=_.merge(baseAttributes,update);return this.set(property,attributes[property],opt)}return joint.util.getByPath(this.attributes,props,delim)}return this.set(_.merge({},this.attributes,props),value)},removeProp:function(path,opt){opt=opt||{},opt.dirty=!0;var pathArray=path.split("/");if(1===pathArray.length)return this.unset(path,opt);var property=pathArray[0],nestedPath=pathArray.slice(1).join("/"),propertyValue=_.merge({},this.get(property));return joint.util.unsetByPath(propertyValue,nestedPath,"/"),this.set(property,propertyValue,opt)},attr:function(attrs,value,opt){var args=Array.prototype.slice.call(arguments);return _.isString(attrs)?args[0]="attrs/"+attrs:args[0]={attrs:attrs},this.prop.apply(this,args)},removeAttr:function(path,opt){return _.isArray(path)?(_.each(path,function(p){this.removeAttr(p,opt)},this),this):this.removeProp("attrs/"+path,opt)},transition:function(path,value,opt,delim){delim=delim||"/";var defaults={duration:100,delay:10,timingFunction:joint.util.timing.linear,valueFunction:joint.util.interpolate.number};opt=_.extend(defaults,opt);var interpolatingFunction,firstFrameTime=0,setter=_.bind(function(runtime){var id,progress,propertyValue;firstFrameTime=firstFrameTime||runtime,runtime-=firstFrameTime,progress=runtime/opt.duration,progress<1?this._transitionIds[path]=id=joint.util.nextFrame(setter):(progress=1,delete this._transitionIds[path]),propertyValue=interpolatingFunction(opt.timingFunction(progress)),opt.transitionId=id,this.prop(path,propertyValue,opt),id||this.trigger("transition:end",this,path)},this),initiator=_.bind(function(callback){this.stopTransitions(path),interpolatingFunction=opt.valueFunction(joint.util.getByPath(this.attributes,path,delim),value),this._transitionIds[path]=joint.util.nextFrame(callback),this.trigger("transition:start",this,path)},this);return _.delay(initiator,opt.delay,setter)},getTransitions:function(){return _.keys(this._transitionIds)},stopTransitions:function(path,delim){delim=delim||"/";var pathArray=path&&path.split(delim);return _(this._transitionIds).keys().filter(pathArray&&function(key){return _.isEqual(pathArray,key.split(delim).slice(0,pathArray.length))}).each(function(key){joint.util.cancelFrame(this._transitionIds[key]),delete this._transitionIds[key],this.trigger("transition:end",this,key)},this),this},addTo:function(graph,opt){return graph.addCell(this,opt),this},findView:function(paper){return paper.findViewByModel(this)},isElement:function(){return!1},isLink:function(){return!1},startBatch:function(name,opt){return this.graph&&this.graph.startBatch(name,_.extend({},opt,{cell:this})),this},stopBatch:function(name,opt){return this.graph&&this.graph.stopBatch(name,_.extend({},opt,{cell:this})),this}}),joint.dia.CellView=joint.mvc.View.extend({tagName:"g",attributes:function(){return{"model-id":this.model.id}},constructor:function(options){options.id=options.id||joint.util.guid(this),joint.mvc.View.call(this,options)},init:function(){_.bindAll(this,"remove","update"),this.$el.data("view",this),this.listenTo(this.model,"change:attrs",this.onChangeAttrs)},onChangeAttrs:function(cell,attrs,opt){return opt.dirty?this.render():this.update(cell,attrs,opt)},can:function(feature){var interactive=_.isFunction(this.options.interactive)?this.options.interactive(this):this.options.interactive;return _.isObject(interactive)&&interactive[feature]!==!1||_.isBoolean(interactive)&&interactive!==!1},_ensureElement:function(){var el;if(this.el)el=_.result(this,"el");else{var attrs=_.extend({id:this.id},_.result(this,"attributes"));this.className&&(attrs["class"]=_.result(this,"className")),el=V(_.result(this,"tagName"),attrs).node}this.setElement(el,!1)},_setElement:function(el){this.$el=el instanceof Backbone.$?el:Backbone.$(el),this.el=this.$el[0],this.vel=V(this.el)},findBySelector:function(selector){var $selected="."===selector?this.$el:this.$el.find(selector);return $selected},notify:function(eventName){if(this.paper){var args=Array.prototype.slice.call(arguments,1);this.trigger.apply(this,[eventName].concat(args)),this.paper.trigger.apply(this.paper,[eventName,this].concat(args))}},getStrokeBBox:function(el){var isMagnet=!!el;el=el||this.el;var strokeWidth,bbox=V(el).bbox(!1,this.paper.viewport);return strokeWidth=isMagnet?V(el).attr("stroke-width"):this.model.attr("rect/stroke-width")||this.model.attr("circle/stroke-width")||this.model.attr("ellipse/stroke-width")||this.model.attr("path/stroke-width"),strokeWidth=parseFloat(strokeWidth)||0,g.rect(bbox).moveAndExpand({x:-strokeWidth/2,y:-strokeWidth/2,width:strokeWidth,height:strokeWidth})},getBBox:function(){return g.rect(this.vel.bbox())},highlight:function(el,opt){return el=el?this.$(el)[0]||this.el:this.el,opt=opt||{},opt.partial=el!=this.el,this.notify("cell:highlight",el,opt),this},unhighlight:function(el,opt){return el=el?this.$(el)[0]||this.el:this.el,opt=opt||{},opt.partial=el!=this.el,this.notify("cell:unhighlight",el,opt),this},findMagnet:function(el){var $el=this.$(el);if(0===$el.length||$el[0]===this.el){var attrs=this.model.get("attrs")||{};if(attrs["."]&&attrs["."].magnet===!1)return;return this.el}return $el.attr("magnet")?$el[0]:this.findMagnet($el.parent())},applyFilter:function(selector,filter){var $selected=_.isString(selector)?this.findBySelector(selector):$(selector),filterId=filter.name+this.paper.svg.id+joint.util.hashCode(JSON.stringify(filter));if(!this.paper.svg.getElementById(filterId)){var filterSVGString=joint.util.filter[filter.name]&&joint.util.filter[filter.name](filter.args||{});if(!filterSVGString)throw new Error("Non-existing filter "+filter.name);var filterElement=V(filterSVGString);filterElement.attr({filterUnits:"objectBoundingBox",x:-1,y:-1,width:3,height:3}),filter.attrs&&filterElement.attr(filter.attrs),filterElement.node.id=filterId,V(this.paper.svg).defs().append(filterElement)}$selected.each(function(){V(this).attr("filter","url(#"+filterId+")")})},applyGradient:function(selector,attr,gradient){var $selected=_.isString(selector)?this.findBySelector(selector):$(selector),gradientId=gradient.type+this.paper.svg.id+joint.util.hashCode(JSON.stringify(gradient));if(!this.paper.svg.getElementById(gradientId)){var gradientSVGString=["<"+gradient.type+">",_.map(gradient.stops,function(stop){return'<stop offset="'+stop.offset+'" stop-color="'+stop.color+'" stop-opacity="'+(_.isFinite(stop.opacity)?stop.opacity:1)+'" />'}).join(""),"</"+gradient.type+">"].join(""),gradientElement=V(gradientSVGString);gradient.attrs&&gradientElement.attr(gradient.attrs),gradientElement.node.id=gradientId,V(this.paper.svg).defs().append(gradientElement)}$selected.each(function(){V(this).attr(attr,"url(#"+gradientId+")")})},getSelector:function(el,prevSelector){if(el===this.el)return prevSelector;var nthChild=V(el).index()+1,selector=el.tagName+":nth-child("+nthChild+")";return prevSelector&&(selector+=" > "+prevSelector),this.getSelector(el.parentNode,selector)},pointerdblclick:function(evt,x,y){this.notify("cell:pointerdblclick",evt,x,y)},pointerclick:function(evt,x,y){this.notify("cell:pointerclick",evt,x,y)},pointerdown:function(evt,x,y){this.model.graph&&(this.model.startBatch("pointer"),this._graph=this.model.graph),this.notify("cell:pointerdown",evt,x,y)},pointermove:function(evt,x,y){this.notify("cell:pointermove",evt,x,y)},pointerup:function(evt,x,y){this.notify("cell:pointerup",evt,x,y),this._graph&&(this._graph.stopBatch("pointer",{cell:this.model}),delete this._graph)},mouseover:function(evt){this.notify("cell:mouseover",evt)},mouseout:function(evt){this.notify("cell:mouseout",evt)},mousewheel:function(evt,x,y,delta){this.notify("cell:mousewheel",evt,x,y,delta)},contextmenu:function(evt,x,y){this.notify("cell:contextmenu",evt,x,y)},onSetTheme:function(oldTheme,newTheme){oldTheme&&this.vel.removeClass(this.themeClassNamePrefix+oldTheme),this.vel.addClass(this.themeClassNamePrefix+newTheme)},setInteractivity:function(value){this.options.interactive=value}}),joint.dia.Element=joint.dia.Cell.extend({defaults:{position:{x:0,y:0},size:{width:1,height:1},angle:0},isElement:function(){return!0},position:function(x,y,opt){var isSetter=_.isNumber(y);if(opt=(isSetter?opt:x)||{},opt.parentRelative){if(!this.graph)throw new Error("Element must be part of a graph.");var parent=this.graph.getCell(this.get("parent")),parentPosition=parent&&!parent.isLink()?parent.get("position"):{x:0,y:0}}if(isSetter)return opt.parentRelative&&(x+=parentPosition.x,y+=parentPosition.y),this.set("position",{x:x,y:y},opt);var elementPosition=g.point(this.get("position"));return opt.parentRelative?elementPosition.difference(parentPosition):elementPosition},translate:function(tx,ty,opt){if(tx=tx||0,ty=ty||0,0===tx&&0===ty)return this;opt=opt||{},opt.translateBy=opt.translateBy||this.id;var position=this.get("position")||{x:0,y:0};if(opt.restrictedArea&&opt.translateBy===this.id){var bbox=this.getBBox({deep:!0}),ra=opt.restrictedArea,dx=position.x-bbox.x,dy=position.y-bbox.y,x=Math.max(ra.x+dx,Math.min(ra.x+ra.width+dx-bbox.width,position.x+tx)),y=Math.max(ra.y+dy,Math.min(ra.y+ra.height+dy-bbox.height,position.y+ty));tx=x-position.x,ty=y-position.y}var translatedPosition={x:position.x+tx,y:position.y+ty};return opt.tx=tx,opt.ty=ty,opt.transition?(_.isObject(opt.transition)||(opt.transition={}),this.transition("position",translatedPosition,_.extend({},opt.transition,{valueFunction:joint.util.interpolate.object}))):(this.set("position",translatedPosition,opt),_.invoke(this.getEmbeddedCells(),"translate",tx,ty,opt)),this},resize:function(width,height,opt){if(opt=opt||{},this.startBatch("resize",opt),opt.direction){var currentSize=this.get("size");switch(opt.direction){case"left":case"right":height=currentSize.height;break;case"top":case"bottom":width=currentSize.width}var angle=g.normalizeAngle(this.get("angle")||0),quadrant={"top-right":0,right:0,"top-left":1,top:1,"bottom-left":2,left:2,"bottom-right":3,bottom:3}[opt.direction];opt.absolute&&(quadrant+=Math.floor((angle+45)/90),quadrant%=4);var bbox=this.getBBox(),fixedPoint=bbox[["bottomLeft","corner","topRight","origin"][quadrant]](),imageFixedPoint=g.point(fixedPoint).rotate(bbox.center(),-angle),radius=Math.sqrt(width*width+height*height)/2,alpha=quadrant*Math.PI/2;alpha+=Math.atan(quadrant%2==0?height/width:width/height),alpha-=g.toRad(angle);var center=g.point.fromPolar(radius,alpha,imageFixedPoint),origin=g.point(center).offset(width/-2,height/-2);this.set("size",{width:width,height:height},opt),this.position(origin.x,origin.y,opt)}else this.set("size",{width:width,height:height},opt);return this.stopBatch("resize",opt),this},scale:function(sx,sy,origin,opt){var scaledBBox=this.getBBox().scale(sx,sy,origin);return this.startBatch("scale",opt),this.position(scaledBBox.x,scaledBBox.y,opt),this.resize(scaledBBox.width,scaledBBox.height,opt),this.stopBatch("scale"),this},fitEmbeds:function(opt){if(opt=opt||{},!this.graph)throw new Error("Element must be part of a graph.");var embeddedCells=this.getEmbeddedCells();if(embeddedCells.length>0){this.startBatch("fit-embeds",opt),opt.deep&&_.invoke(embeddedCells,"fitEmbeds",opt);var bbox=this.graph.getCellsBBox(embeddedCells),padding=joint.util.normalizeSides(opt.padding);bbox.moveAndExpand({x:-padding.left,y:-padding.top,width:padding.right+padding.left,height:padding.bottom+padding.top}),this.set({position:{x:bbox.x,y:bbox.y},size:{width:bbox.width,height:bbox.height}},opt),this.stopBatch("fit-embeds")}return this},rotate:function(angle,absolute,origin){if(origin){var center=this.getBBox().center(),size=this.get("size"),position=this.get("position");center.rotate(origin,this.get("angle")-angle);var dx=center.x-size.width/2-position.x,dy=center.y-size.height/2-position.y;this.startBatch("rotate",{angle:angle,absolute:absolute,origin:origin}),this.translate(dx,dy),this.rotate(angle,absolute),this.stopBatch("rotate")}else this.set("angle",absolute?angle:(this.get("angle")+angle)%360);return this},getBBox:function(opt){if(opt=opt||{},opt.deep&&this.graph){var elements=this.getEmbeddedCells({deep:!0,breadthFirst:!0});return elements.push(this),this.graph.getCellsBBox(elements)}var position=this.get("position"),size=this.get("size");return g.rect(position.x,position.y,size.width,size.height)}}),joint.dia.ElementView=joint.dia.CellView.extend({SPECIAL_ATTRIBUTES:["style","text","html","ref-x","ref-y","ref-dx","ref-dy","ref-width","ref-height","ref","x-alignment","y-alignment","port"],className:function(){return"element "+this.model.get("type").replace(/\./g," ")},initialize:function(){_.bindAll(this,"translate","resize","rotate"),joint.dia.CellView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:position",this.translate),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change:angle",this.rotate)},update:function(cell,renderingOnlyAttrs){var allAttrs=this.model.get("attrs"),rotatable=this.rotatableNode;if(rotatable){var rotation=rotatable.attr("transform");rotatable.attr("transform","")}var relativelyPositioned=[],nodesBySelector={};_.each(renderingOnlyAttrs||allAttrs,function(attrs,selector){var $selected=this.findBySelector(selector);if(0!==$selected.length){nodesBySelector[selector]=$selected;var specialAttributes=this.SPECIAL_ATTRIBUTES.slice();_.isObject(attrs.filter)&&(specialAttributes.push("filter"),this.applyFilter($selected,attrs.filter)),_.isObject(attrs.fill)&&(specialAttributes.push("fill"),this.applyGradient($selected,"fill",attrs.fill)),_.isObject(attrs.stroke)&&(specialAttributes.push("stroke"),this.applyGradient($selected,"stroke",attrs.stroke)),_.isUndefined(attrs.text)||($selected.each(function(){V(this).text(attrs.text+"",{lineHeight:attrs.lineHeight,textPath:attrs.textPath,annotations:attrs.annotations})}),specialAttributes.push("lineHeight","textPath","annotations"));var finalAttributes=_.omit(attrs,specialAttributes);$selected.each(function(){V(this).attr(finalAttributes)}),attrs.port&&$selected.attr("port",_.isUndefined(attrs.port.id)?attrs.port:attrs.port.id),attrs.style&&$selected.css(attrs.style),_.isUndefined(attrs.html)||$selected.each(function(){$(this).html(attrs.html+"")}),_.isUndefined(attrs["ref-x"])&&_.isUndefined(attrs["ref-y"])&&_.isUndefined(attrs["ref-dx"])&&_.isUndefined(attrs["ref-dy"])&&_.isUndefined(attrs["x-alignment"])&&_.isUndefined(attrs["y-alignment"])&&_.isUndefined(attrs["ref-width"])&&_.isUndefined(attrs["ref-height"])||_.each($selected,function(el,index,list){var $el=$(el);$el.selector=list.selector,relativelyPositioned.push($el)})}},this);var size=this.model.get("size"),bbox={x:0,y:0,width:size.width,height:size.height};renderingOnlyAttrs=renderingOnlyAttrs||{},_.each(relativelyPositioned,function($el){var renderingOnlyElAttrs=renderingOnlyAttrs[$el.selector],elAttrs=renderingOnlyElAttrs?_.merge({},allAttrs[$el.selector],renderingOnlyElAttrs):allAttrs[$el.selector];this.positionRelative(V($el[0]),bbox,elAttrs,nodesBySelector)},this),rotatable&&rotatable.attr("transform",rotation||"")},positionRelative:function(vel,bbox,attributes,nodesBySelector){var ref=attributes.ref,refDx=parseFloat(attributes["ref-dx"]),refDy=parseFloat(attributes["ref-dy"]),yAlignment=attributes["y-alignment"],xAlignment=attributes["x-alignment"],refY=attributes["ref-y"],refYPercentage=_.isString(refY)&&"%"===refY.slice(-1);refY=parseFloat(refY),refYPercentage&&(refY/=100);var refX=attributes["ref-x"],refXPercentage=_.isString(refX)&&"%"===refX.slice(-1);refX=parseFloat(refX),refXPercentage&&(refX/=100);var refWidth=attributes["ref-width"],refWidthPercentage=_.isString(refWidth)&&"%"===refWidth.slice(-1);refWidth=parseFloat(refWidth),refWidthPercentage&&(refWidth/=100);var refHeight=attributes["ref-height"],refHeightPercentage=_.isString(refHeight)&&"%"===refHeight.slice(-1);refHeight=parseFloat(refHeight),refHeightPercentage&&(refHeight/=100);var scalable=vel.findParentByClass("scalable",this.el);if(ref){var vref;if(vref=nodesBySelector&&nodesBySelector[ref]?V(nodesBySelector[ref][0]):"."===ref?this.vel:this.vel.findOne(ref),!vref)throw new Error("dia.ElementView: reference does not exists.");bbox=vref.bbox(!1,this.el)}vel.attr("transform")&&vel.attr("transform",vel.attr("transform").replace(/translate\([^)]*\)/g,"").trim()||""),isFinite(refWidth)&&(refWidthPercentage||refWidth>=0&&refWidth<=1?vel.attr("width",refWidth*bbox.width):vel.attr("width",Math.max(refWidth+bbox.width,0))),isFinite(refHeight)&&(refHeightPercentage||refHeight>=0&&refHeight<=1?vel.attr("height",refHeight*bbox.height):vel.attr("height",Math.max(refHeight+bbox.height,0)));var scale,tx=0,ty=0;if(isFinite(refDx)&&(scalable?(scale=scale||scalable.scale(),tx=bbox.x+bbox.width+refDx/scale.sx):tx=bbox.x+bbox.width+refDx),
isFinite(refDy)&&(scalable?(scale=scale||scalable.scale(),ty=bbox.y+bbox.height+refDy/scale.sy):ty=bbox.y+bbox.height+refDy),isFinite(refX)&&(refXPercentage||refX>0&&refX<1?tx=bbox.x+bbox.width*refX:scalable?(scale=scale||scalable.scale(),tx=bbox.x+refX/scale.sx):tx=bbox.x+refX),isFinite(refY)&&(refYPercentage||refY>0&&refY<1?ty=bbox.y+bbox.height*refY:scalable?(scale=scale||scalable.scale(),ty=bbox.y+refY/scale.sy):ty=bbox.y+refY),!_.isUndefined(yAlignment)||!_.isUndefined(xAlignment)){var velBBox=vel.bbox(!1,this.paper.viewport);"middle"===yAlignment?ty-=velBBox.height/2:"bottom"===yAlignment?ty-=velBBox.height:isFinite(yAlignment)&&(ty+=yAlignment>-1&&yAlignment<1?velBBox.height*yAlignment:yAlignment),"middle"===xAlignment?tx-=velBBox.width/2:"right"===xAlignment?tx-=velBBox.width:isFinite(xAlignment)&&(tx+=xAlignment>-1&&xAlignment<1?velBBox.width*xAlignment:xAlignment)}vel.translate(tx,ty)},renderMarkup:function(){var markup=this.model.get("markup")||this.model.markup;if(!markup)throw new Error("properties.markup is missing while the default render() implementation is used.");var nodes=V(markup);this.vel.append(nodes)},render:function(){return this.$el.empty(),this.renderMarkup(),this.rotatableNode=this.vel.findOne(".rotatable"),this.scalableNode=this.vel.findOne(".scalable"),this.update(),this.resize(),this.rotate(),this.translate(),this},scale:function(sx,sy){this.vel.scale(sx,sy)},resize:function(){var size=this.model.get("size")||{width:1,height:1},angle=this.model.get("angle")||0,scalable=this.scalableNode;if(scalable){var scalableBbox=scalable.bbox(!0);scalable.attr("transform","scale("+size.width/(scalableBbox.width||1)+","+size.height/(scalableBbox.height||1)+")");var rotatable=this.rotatableNode,rotation=rotatable&&rotatable.attr("transform");if(rotation&&"null"!==rotation){rotatable.attr("transform",rotation+" rotate("+-angle+","+size.width/2+","+size.height/2+")");var rotatableBbox=scalable.bbox(!1,this.paper.viewport);this.model.set("position",{x:rotatableBbox.x,y:rotatableBbox.y}),this.rotate()}this.update()}},translate:function(model,changes,opt){var position=this.model.get("position")||{x:0,y:0};this.vel.attr("transform","translate("+position.x+","+position.y+")")},rotate:function(){var rotatable=this.rotatableNode;if(rotatable){var angle=this.model.get("angle")||0,size=this.model.get("size")||{width:1,height:1},ox=size.width/2,oy=size.height/2;rotatable.attr("transform","rotate("+angle+","+ox+","+oy+")")}},getBBox:function(opt){if(opt&&opt.useModelGeometry){var noTransformationBBox=this.model.getBBox().bbox(this.model.get("angle")),transformationMatrix=this.paper.viewport.getCTM();return g.rect(V.transformRect(noTransformationBBox,transformationMatrix))}return joint.dia.CellView.prototype.getBBox.apply(this,arguments)},prepareEmbedding:function(opt){opt=opt||{};var model=opt.model||this.model,paper=opt.paper||this.paper;model.startBatch("to-front",opt),model.toFront({deep:!0,ui:!0}),_.invoke(paper.model.getConnectedLinks(model,{deep:!0}),"toFront",{ui:!0}),model.stopBatch("to-front");var parentId=model.get("parent");parentId&&paper.model.getCell(parentId).unembed(model,{ui:!0})},processEmbedding:function(opt){opt=opt||{};var model=opt.model||this.model,paper=opt.paper||this.paper,paperOptions=paper.options,candidates=paper.model.findModelsUnderElement(model,{searchBy:paperOptions.findParentBy});paperOptions.frontParentOnly&&(candidates=candidates.slice(-1));for(var newCandidateView=null,prevCandidateView=this._candidateEmbedView,i=candidates.length-1;i>=0;i--){var candidate=candidates[i];if(prevCandidateView&&prevCandidateView.model.id==candidate.id){newCandidateView=prevCandidateView;break}var view=candidate.findView(paper);if(paperOptions.validateEmbedding.call(paper,this,view)){newCandidateView=view;break}}newCandidateView&&newCandidateView!=prevCandidateView&&(prevCandidateView&&prevCandidateView.unhighlight(null,{embedding:!0}),this._candidateEmbedView=newCandidateView.highlight(null,{embedding:!0})),!newCandidateView&&prevCandidateView&&(prevCandidateView.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView)},finalizeEmbedding:function(opt){opt=opt||{};var candidateView=this._candidateEmbedView,model=opt.model||this.model,paper=opt.paper||this.paper;candidateView&&(candidateView.model.embed(model,{ui:!0}),candidateView.unhighlight(null,{embedding:!0}),delete this._candidateEmbedView),_.invoke(paper.model.getConnectedLinks(model,{deep:!0}),"reparent",{ui:!0})},pointerdown:function(evt,x,y){var paper=this.paper;if(evt.target.getAttribute("magnet")&&this.can("addLinkFromMagnet")&&paper.options.validateMagnet.call(paper,this,evt.target)){this.model.startBatch("add-link");var link=paper.getDefaultLink(this,evt.target);link.set({source:{id:this.model.id,selector:this.getSelector(evt.target),port:evt.target.getAttribute("port")},target:{x:x,y:y}}),paper.model.addCell(link);var linkView=this._linkView=paper.findViewByModel(link);linkView.pointerdown(evt,x,y),linkView.startArrowheadMove("target",{whenNotAllowed:"remove"})}else this._dx=x,this._dy=y,this.restrictedArea=paper.getRestrictedArea(this),joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("element:pointerdown",evt,x,y)},pointermove:function(evt,x,y){if(this._linkView)this._linkView.pointermove(evt,x,y);else{var grid=this.paper.options.gridSize;if(this.can("elementMove")){var position=this.model.get("position"),tx=g.snapToGrid(position.x,grid)-position.x+g.snapToGrid(x-this._dx,grid),ty=g.snapToGrid(position.y,grid)-position.y+g.snapToGrid(y-this._dy,grid);this.model.translate(tx,ty,{restrictedArea:this.restrictedArea,ui:!0}),this.paper.options.embeddingMode&&(this._inProcessOfEmbedding||(this.prepareEmbedding(),this._inProcessOfEmbedding=!0),this.processEmbedding())}this._dx=g.snapToGrid(x,grid),this._dy=g.snapToGrid(y,grid),joint.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("element:pointermove",evt,x,y)}},pointerup:function(evt,x,y){this._linkView?(this._linkView.pointerup(evt,x,y),this._linkView=null,this.model.stopBatch("add-link")):(this._inProcessOfEmbedding&&(this.finalizeEmbedding(),this._inProcessOfEmbedding=!1),this.notify("element:pointerup",evt,x,y),joint.dia.CellView.prototype.pointerup.apply(this,arguments))}}),joint.dia.Link=joint.dia.Cell.extend({markup:['<path class="connection" stroke="black" d="M 0 0 0 0"/>','<path class="marker-source" fill="black" stroke="black" d="M 0 0 0 0"/>','<path class="marker-target" fill="black" stroke="black" d="M 0 0 0 0"/>','<path class="connection-wrap" d="M 0 0 0 0"/>','<g class="labels"/>','<g class="marker-vertices"/>','<g class="marker-arrowheads"/>','<g class="link-tools"/>'].join(""),labelMarkup:['<g class="label">',"<rect />","<text />","</g>"].join(""),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle r="11" />','<path transform="scale(.8) translate(-16, -16)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z" />',"<title>Remove link.</title>","</g>",'<g class="tool-options" event="link:options">','<circle r="11" transform="translate(25)"/>','<path fill="white" transform="scale(.55) translate(29, -16)" d="M31.229,17.736c0.064-0.571,0.104-1.148,0.104-1.736s-0.04-1.166-0.104-1.737l-4.377-1.557c-0.218-0.716-0.504-1.401-0.851-2.05l1.993-4.192c-0.725-0.91-1.549-1.734-2.458-2.459l-4.193,1.994c-0.647-0.347-1.334-0.632-2.049-0.849l-1.558-4.378C17.165,0.708,16.588,0.667,16,0.667s-1.166,0.041-1.737,0.105L12.707,5.15c-0.716,0.217-1.401,0.502-2.05,0.849L6.464,4.005C5.554,4.73,4.73,5.554,4.005,6.464l1.994,4.192c-0.347,0.648-0.632,1.334-0.849,2.05l-4.378,1.557C0.708,14.834,0.667,15.412,0.667,16s0.041,1.165,0.105,1.736l4.378,1.558c0.217,0.715,0.502,1.401,0.849,2.049l-1.994,4.193c0.725,0.909,1.549,1.733,2.459,2.458l4.192-1.993c0.648,0.347,1.334,0.633,2.05,0.851l1.557,4.377c0.571,0.064,1.148,0.104,1.737,0.104c0.588,0,1.165-0.04,1.736-0.104l1.558-4.377c0.715-0.218,1.399-0.504,2.049-0.851l4.193,1.993c0.909-0.725,1.733-1.549,2.458-2.458l-1.993-4.193c0.347-0.647,0.633-1.334,0.851-2.049L31.229,17.736zM16,20.871c-2.69,0-4.872-2.182-4.872-4.871c0-2.69,2.182-4.872,4.872-4.872c2.689,0,4.871,2.182,4.871,4.872C20.871,18.689,18.689,20.871,16,20.871z"/>',"<title>Link options.</title>","</g>","</g>"].join(""),vertexMarkup:['<g class="marker-vertex-group" transform="translate(<%= x %>, <%= y %>)">','<circle class="marker-vertex" idx="<%= idx %>" r="10" />','<path class="marker-vertex-remove-area" idx="<%= idx %>" d="M16,5.333c-7.732,0-14,4.701-14,10.5c0,1.982,0.741,3.833,2.016,5.414L2,25.667l5.613-1.441c2.339,1.317,5.237,2.107,8.387,2.107c7.732,0,14-4.701,14-10.5C30,10.034,23.732,5.333,16,5.333z" transform="translate(5, -33)"/>','<path class="marker-vertex-remove" idx="<%= idx %>" transform="scale(.8) translate(9.5, -37)" d="M24.778,21.419 19.276,15.917 24.777,10.415 21.949,7.585 16.447,13.087 10.945,7.585 8.117,10.415 13.618,15.917 8.116,21.419 10.946,24.248 16.447,18.746 21.948,24.248z">',"<title>Remove vertex.</title>","</path>","</g>"].join(""),arrowheadMarkup:['<g class="marker-arrowhead-group marker-arrowhead-group-<%= end %>">','<path class="marker-arrowhead" end="<%= end %>" d="M 26 0 L 0 13 L 26 26 z" />',"</g>"].join(""),defaults:{type:"link",source:{},target:{}},isLink:function(){return!0},disconnect:function(){return this.set({source:g.point(0,0),target:g.point(0,0)})},label:function(idx,value){idx=idx||0;var labels=this.get("labels")||[];if(0===arguments.length||1===arguments.length)return labels[idx];var newValue=_.merge({},labels[idx],value),newLabels=labels.slice();return newLabels[idx]=newValue,this.set({labels:newLabels})},translate:function(tx,ty,opt){return opt=opt||{},opt.translateBy=opt.translateBy||this.id,opt.tx=tx,opt.ty=ty,this.applyToPoints(function(p){return{x:(p.x||0)+tx,y:(p.y||0)+ty}},opt)},scale:function(sx,sy,origin,opt){return this.applyToPoints(function(p){return g.point(p).scale(sx,sy,origin).toJSON()},opt)},applyToPoints:function(fn,opt){if(!_.isFunction(fn))throw new TypeError("dia.Link: applyToPoints expects its first parameter to be a function.");var attrs={},source=this.get("source");source.id||(attrs.source=fn(source));var target=this.get("target");target.id||(attrs.target=fn(target));var vertices=this.get("vertices");return vertices&&vertices.length>0&&(attrs.vertices=_.map(vertices,fn)),this.set(attrs,opt)},reparent:function(opt){var newParent;if(this.graph){var source=this.graph.getCell(this.get("source").id),target=this.graph.getCell(this.get("target").id),prevParent=this.graph.getCell(this.get("parent"));source&&target&&(newParent=this.graph.getCommonAncestor(source,target)),!prevParent||newParent&&newParent.id===prevParent.id||prevParent.unembed(this,opt),newParent&&newParent.embed(this,opt)}return newParent},hasLoop:function(opt){opt=opt||{};var sourceId=this.get("source").id,targetId=this.get("target").id;if(!sourceId||!targetId)return!1;var loop=sourceId===targetId;if(!loop&&opt.deep&&this.graph){var sourceElement=this.graph.getCell(sourceId),targetElement=this.graph.getCell(targetId);loop=sourceElement.isEmbeddedIn(targetElement)||targetElement.isEmbeddedIn(sourceElement)}return loop},getSourceElement:function(){var source=this.get("source");return source&&source.id&&this.graph&&this.graph.getCell(source.id)||null},getTargetElement:function(){var target=this.get("target");return target&&target.id&&this.graph&&this.graph.getCell(target.id)||null},getRelationshipAncestor:function(){var connectionAncestor;if(this.graph){var cells=_.compact([this,this.getSourceElement(),this.getTargetElement()]);connectionAncestor=this.graph.getCommonAncestor.apply(this.graph,cells)}return connectionAncestor||null},isRelationshipEmbeddedIn:function(element){var elementId=_.isString(element)?element:element.id,ancestor=this.getRelationshipAncestor();return!!ancestor&&(ancestor.id===elementId||ancestor.isEmbeddedIn(elementId))}},{endsEqual:function(a,b){var portsEqual=a.port===b.port||!a.port&&!b.port;return a.id===b.id&&portsEqual}}),joint.dia.LinkView=joint.dia.CellView.extend({className:function(){return _.unique(this.model.get("type").split(".").concat("link")).join(" ")},options:{shortLinkLength:100,doubleLinkTools:!1,longLinkLength:160,linkToolsOffset:40,doubleLinkToolsOffset:60,sampleInterval:50},_z:null,initialize:function(options){joint.dia.CellView.prototype.initialize.apply(this,arguments),"function"!=typeof this.constructor.prototype.watchSource&&(this.constructor.prototype.watchSource=this.createWatcher("source"),this.constructor.prototype.watchTarget=this.createWatcher("target")),this._labelCache={},this._markerCache={},this.startListening()},startListening:function(){var model=this.model;this.listenTo(model,"change:markup",this.render),this.listenTo(model,"change:smooth change:manhattan change:router change:connector",this.update),this.listenTo(model,"change:toolMarkup",this.onToolsChange),this.listenTo(model,"change:labels change:labelMarkup",this.onLabelsChange),this.listenTo(model,"change:vertices change:vertexMarkup",this.onVerticesChange),this.listenTo(model,"change:source",this.onSourceChange),this.listenTo(model,"change:target",this.onTargetChange)},onSourceChange:function(cell,source,opt){this.watchSource(cell,source),opt.translateBy&&this.model.get("target").id||(opt.updateConnectionOnly=!0,this.update(this.model,null,opt))},onTargetChange:function(cell,target,opt){this.watchTarget(cell,target),opt.translateBy||(opt.updateConnectionOnly=!0,this.update(this.model,null,opt))},onVerticesChange:function(cell,changed,opt){this.renderVertexMarkers(),opt.translateBy&&opt.translateBy!==this.model.id||(opt.updateConnectionOnly=!0,this.update(cell,null,opt))},onToolsChange:function(){this.renderTools().updateToolsPosition()},onLabelsChange:function(){this.renderLabels().updateLabelPositions()},render:function(){this.$el.empty();var model=this.model,children=V(model.get("markup")||model.markup);if(_.isArray(children)||(children=[children]),this._V={},_.each(children,function(child){var c=child.attr("class");c&&(this._V[$.camelCase(c)]=child)},this),!this._V.connection)throw new Error("link: no connection path in the markup");return this.renderTools(),this.renderVertexMarkers(),this.renderArrowheadMarkers(),this.vel.append(children),this.renderLabels(),this.watchSource(model,model.get("source")).watchTarget(model,model.get("target")).update(),this},renderLabels:function(){if(!this._V.labels)return this;this._labelCache={};var $labels=$(this._V.labels.node).empty(),labels=this.model.get("labels")||[];if(!labels.length)return this;var labelTemplate=joint.util.template(this.model.get("labelMarkup")||this.model.labelMarkup),labelNodeInstance=V(labelTemplate()),canLabelMove=this.can("labelMove");return _.each(labels,function(label,idx){var labelNode=labelNodeInstance.clone().node;V(labelNode).attr("label-idx",idx),canLabelMove&&V(labelNode).attr("cursor","move"),this._labelCache[idx]=V(labelNode);var $text=$(labelNode).find("text"),$rect=$(labelNode).find("rect"),textAttributes=_.extend({"text-anchor":"middle","font-size":14},joint.util.getByPath(label,"attrs/text","/"));$text.attr(_.omit(textAttributes,"text")),_.isUndefined(textAttributes.text)||V($text[0]).text(textAttributes.text+"",{annotations:textAttributes.annotations}),$labels.append(labelNode);var textBbox=V($text[0]).bbox(!0,$labels[0]);V($text[0]).translate(0,-textBbox.height/2);var rectAttributes=_.extend({fill:"white",rx:3,ry:3},joint.util.getByPath(label,"attrs/rect","/"));$rect.attr(_.extend(rectAttributes,{x:textBbox.x,y:textBbox.y-textBbox.height/2,width:textBbox.width,height:textBbox.height}))},this),this},renderTools:function(){if(!this._V.linkTools)return this;var $tools=$(this._V.linkTools.node).empty(),toolTemplate=joint.util.template(this.model.get("toolMarkup")||this.model.toolMarkup),tool=V(toolTemplate());if($tools.append(tool.node),this._toolCache=tool,this.options.doubleLinkTools){var tool2;this.model.get("doubleToolMarkup")||this.model.doubleToolMarkup?(toolTemplate=joint.util.template(this.model.get("doubleToolMarkup")||this.model.doubleToolMarkup),tool2=V(toolTemplate())):tool2=tool.clone(),$tools.append(tool2.node),this._tool2Cache=tool2}return this},renderVertexMarkers:function(){if(!this._V.markerVertices)return this;var $markerVertices=$(this._V.markerVertices.node).empty(),markupTemplate=joint.util.template(this.model.get("vertexMarkup")||this.model.vertexMarkup);return _.each(this.model.get("vertices"),function(vertex,idx){$markerVertices.append(V(markupTemplate(_.extend({idx:idx},vertex))).node)}),this},renderArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;var $markerArrowheads=$(this._V.markerArrowheads.node);$markerArrowheads.empty();var markupTemplate=joint.util.template(this.model.get("arrowheadMarkup")||this.model.arrowheadMarkup);return this._V.sourceArrowhead=V(markupTemplate({end:"source"})),this._V.targetArrowhead=V(markupTemplate({end:"target"})),$markerArrowheads.append(this._V.sourceArrowhead.node,this._V.targetArrowhead.node),this},update:function(model,attributes,opt){return opt=opt||{},opt.updateConnectionOnly||this.updateAttributes(),this.updateConnection(opt),this.updateLabelPositions(),this.updateToolsPosition(),this.updateArrowheadMarkers(),this.options.perpendicular=null,this.updatePostponed=!1,this},updateConnection:function(opt){opt=opt||{};var route,model=this.model;if(opt.translateBy&&model.isRelationshipEmbeddedIn(opt.translateBy)){var tx=opt.tx||0,ty=opt.ty||0;route=this.route=_.map(this.route,function(point){return g.point(point).offset(tx,ty)}),this._translateConnectionPoints(tx,ty)}else route=this.route=this.findRoute(model.get("vertices")||[],opt),this._findConnectionPoints(route);var pathData=this.getPathData(route);this._V.connection.attr("d",pathData),this._V.connectionWrap&&this._V.connectionWrap.attr("d",pathData),this._translateAndAutoOrientArrows(this._V.markerSource,this._V.markerTarget)},updateAttributes:function(){_.each(this.model.get("attrs"),function(attrs,selector){var processedAttributes=[];_.isObject(attrs.fill)&&(this.applyGradient(selector,"fill",attrs.fill),processedAttributes.push("fill")),_.isObject(attrs.stroke)&&(this.applyGradient(selector,"stroke",attrs.stroke),processedAttributes.push("stroke")),_.isObject(attrs.filter)&&(this.applyFilter(selector,attrs.filter),processedAttributes.push("filter")),processedAttributes.length>0&&(processedAttributes.unshift(attrs),attrs=_.omit.apply(_,processedAttributes)),this.findBySelector(selector).attr(attrs)},this)},_findConnectionPoints:function(vertices){var sourcePoint,targetPoint,sourceMarkerPoint,targetMarkerPoint,firstVertex=_.first(vertices);sourcePoint=this.getConnectionPoint("source",this.model.get("source"),firstVertex||this.model.get("target")).round();var lastVertex=_.last(vertices);targetPoint=this.getConnectionPoint("target",this.model.get("target"),lastVertex||sourcePoint).round();var cache=this._markerCache;this._V.markerSource&&(cache.sourceBBox=cache.sourceBBox||this._V.markerSource.bbox(!0),sourceMarkerPoint=g.point(sourcePoint).move(firstVertex||targetPoint,cache.sourceBBox.width*this._V.markerSource.scale().sx*-1).round()),this._V.markerTarget&&(cache.targetBBox=cache.targetBBox||this._V.markerTarget.bbox(!0),targetMarkerPoint=g.point(targetPoint).move(lastVertex||sourcePoint,cache.targetBBox.width*this._V.markerTarget.scale().sx*-1).round()),cache.sourcePoint=sourceMarkerPoint||sourcePoint,cache.targetPoint=targetMarkerPoint||targetPoint,this.sourcePoint=sourcePoint,this.targetPoint=targetPoint},_translateConnectionPoints:function(tx,ty){var cache=this._markerCache;cache.sourcePoint.offset(tx,ty),cache.targetPoint.offset(tx,ty),this.sourcePoint.offset(tx,ty),this.targetPoint.offset(tx,ty)},updateLabelPositions:function(){if(!this._V.labels)return this;var labels=this.model.get("labels")||[];if(!labels.length)return this;var connectionElement=this._V.connection.node,connectionLength=connectionElement.getTotalLength();if(!_.isNaN(connectionLength)){var samples;_.each(labels,function(label,idx){var position=label.position,distance=_.isObject(position)?position.distance:position,offset=_.isObject(position)?position.offset:{x:0,y:0};_.isNaN(distance)?distance=connectionLength/2:(distance=distance>connectionLength?connectionLength:distance,distance=distance<0?connectionLength+distance:distance,distance=distance>1?distance:connectionLength*distance);var labelCoordinates=connectionElement.getPointAtLength(distance);if(_.isObject(offset))labelCoordinates=g.point(labelCoordinates).offset(offset.x,offset.y);else if(_.isNumber(offset)){samples||(samples=this._samples||this._V.connection.sample(this.options.sampleInterval));for(var closestSample,closestSampleIndex,p,sqDistance,minSqDistance=1/0,i=0,len=samples.length;i<len;i++)p=samples[i],sqDistance=g.line(p,labelCoordinates).squaredLength(),sqDistance<minSqDistance&&(minSqDistance=sqDistance,closestSample=p,closestSampleIndex=i);var prevSample=samples[closestSampleIndex-1],nextSample=samples[closestSampleIndex+1],angle=0;nextSample?angle=g.point(labelCoordinates).theta(nextSample):prevSample&&(angle=g.point(prevSample).theta(labelCoordinates)),labelCoordinates=g.point(labelCoordinates).offset(offset).rotate(labelCoordinates,angle-90)}this._labelCache[idx].attr("transform","translate("+labelCoordinates.x+", "+labelCoordinates.y+")")},this)}return this},updateToolsPosition:function(){if(!this._V.linkTools)return this;var scale="",offset=this.options.linkToolsOffset,connectionLength=this.getConnectionLength();if(!_.isNaN(connectionLength)){connectionLength<this.options.shortLinkLength&&(scale="scale(.5)",offset/=2);var toolPosition=this.getPointAtLength(offset);if(this._toolCache.attr("transform","translate("+toolPosition.x+", "+toolPosition.y+") "+scale),this.options.doubleLinkTools&&connectionLength>=this.options.longLinkLength){var doubleLinkToolsOffset=this.options.doubleLinkToolsOffset||offset;toolPosition=this.getPointAtLength(connectionLength-doubleLinkToolsOffset),this._tool2Cache.attr("transform","translate("+toolPosition.x+", "+toolPosition.y+") "+scale),this._tool2Cache.attr("visibility","visible")}else this.options.doubleLinkTools&&this._tool2Cache.attr("visibility","hidden")}return this},updateArrowheadMarkers:function(){if(!this._V.markerArrowheads)return this;if("none"===$.css(this._V.markerArrowheads.node,"display"))return this;var sx=this.getConnectionLength()<this.options.shortLinkLength?.5:1;return this._V.sourceArrowhead.scale(sx),this._V.targetArrowhead.scale(sx),this._translateAndAutoOrientArrows(this._V.sourceArrowhead,this._V.targetArrowhead),this},createWatcher:function(endType){function watchEndModel(link,end){end=end||{};var endModel=null,previousEnd=link.previous(endType)||{};return previousEnd.id&&this.stopListening(this.paper.getModelById(previousEnd.id),"change",onModelChange),end.id&&(endModel=this.paper.getModelById(end.id),this.listenTo(endModel,"change",onModelChange)),onModelChange.call(this,endModel,{cacheOnly:!0}),this}var onModelChange=_.partial(this.onEndModelChange,endType);return watchEndModel},onEndModelChange:function(endType,endModel,opt){var doUpdate=!opt.cacheOnly,model=this.model,end=model.get(endType)||{};if(endModel){var selector=this.constructor.makeSelector(end),oppositeEndType="source"==endType?"target":"source",oppositeEnd=model.get(oppositeEndType)||{},oppositeSelector=oppositeEnd.id&&this.constructor.makeSelector(oppositeEnd);if(opt.handleBy===this.cid&&selector==oppositeSelector)this[endType+"BBox"]=this[oppositeEndType+"BBox"],this[endType+"View"]=this[oppositeEndType+"View"],this[endType+"Magnet"]=this[oppositeEndType+"Magnet"];else if(opt.translateBy){var bbox=this[endType+"BBox"];bbox.x+=opt.tx,bbox.y+=opt.ty}else{var view=this.paper.findViewByModel(end.id),magnetElement=view.el.querySelector(selector);this[endType+"BBox"]=view.getStrokeBBox(magnetElement),this[endType+"View"]=view,this[endType+"Magnet"]=magnetElement}if(opt.handleBy===this.cid&&opt.translateBy&&model.isEmbeddedIn(endModel)&&!_.isEmpty(model.get("vertices"))&&(doUpdate=!1),!this.updatePostponed&&oppositeEnd.id){var oppositeEndModel=this.paper.getModelById(oppositeEnd.id);end.id===oppositeEnd.id&&(opt.handleBy=this.cid),(opt.handleBy===this.cid||opt.translateBy&&oppositeEndModel.isEmbeddedIn(opt.translateBy))&&(this.updatePostponed=!0,doUpdate=!1)}}else this[endType+"BBox"]=g.rect(end.x||0,end.y||0,1,1),this[endType+"View"]=this[endType+"Magnet"]=null;doUpdate&&(opt.updateConnectionOnly=!0,this.update(model,null,opt))},_translateAndAutoOrientArrows:function(sourceArrow,targetArrow){sourceArrow&&sourceArrow.translateAndAutoOrient(this.sourcePoint,_.first(this.route)||this.targetPoint,this.paper.viewport),targetArrow&&targetArrow.translateAndAutoOrient(this.targetPoint,_.last(this.route)||this.sourcePoint,this.paper.viewport)},removeVertex:function(idx){var vertices=_.clone(this.model.get("vertices"));return vertices&&vertices.length&&(vertices.splice(idx,1),this.model.set("vertices",vertices,{ui:!0})),this},addVertex:function(vertex){for(var pathLength,vertices=(this.model.get("vertices")||[]).slice(),originalVertices=vertices.slice(),path=this._V.connection.node.cloneNode(!1),originalPathLength=path.getTotalLength(),pathLengthTolerance=20,idx=vertices.length+1;idx--&&(vertices.splice(idx,0,vertex),V(path).attr("d",this.getPathData(this.findRoute(vertices))),pathLength=path.getTotalLength(),pathLength-originalPathLength>pathLengthTolerance);)vertices=originalVertices.slice();return idx===-1&&(idx=0,vertices.splice(idx,0,vertex)),this.model.set("vertices",vertices,{ui:!0}),idx},sendToken:function(token,duration,callback){duration=duration||1e3,V(this.paper.viewport).append(token),V(token).animateAlongPath({dur:duration+"ms",repeatCount:1},this._V.connection.node),_.delay(function(){V(token).remove(),callback&&callback()},duration)},findRoute:function(oldVertices){var namespace=joint.routers,router=this.model.get("router"),defaultRouter=this.paper.options.defaultRouter;if(!router)if(this.model.get("manhattan"))router={name:"orthogonal"};else{if(!defaultRouter)return oldVertices;router=defaultRouter}var args=router.args||{},routerFn=_.isFunction(router)?router:namespace[router.name];if(!_.isFunction(routerFn))throw new Error('unknown router: "'+router.name+'"');var newVertices=routerFn.call(this,oldVertices||[],args,this);return newVertices},getPathData:function(vertices){var namespace=joint.connectors,connector=this.model.get("connector"),defaultConnector=this.paper.options.defaultConnector;connector||(connector=this.model.get("smooth")?{name:"smooth"}:defaultConnector||{});var connectorFn=_.isFunction(connector)?connector:namespace[connector.name],args=connector.args||{};if(!_.isFunction(connectorFn))throw new Error('unknown connector: "'+connector.name+'"');var pathData=connectorFn.call(this,this._markerCache.sourcePoint,this._markerCache.targetPoint,vertices||this.model.get("vertices")||{},args,this);return pathData},getConnectionPoint:function(end,selectorOrPoint,referenceSelectorOrPoint){var spot;if(_.isEmpty(selectorOrPoint)&&(selectorOrPoint={x:0,y:0}),_.isEmpty(referenceSelectorOrPoint)&&(referenceSelectorOrPoint={x:0,y:0}),selectorOrPoint.id){var reference,spotBbox="source"===end?this.sourceBBox:this.targetBBox;if(referenceSelectorOrPoint.id){var referenceBbox="source"===end?this.targetBBox:this.sourceBBox;reference=g.rect(referenceBbox).intersectionWithLineFromCenterToPoint(g.rect(spotBbox).center()),reference=reference||g.rect(referenceBbox).center()}else reference=g.point(referenceSelectorOrPoint);if(this.paper.options.perpendicularLinks||this.options.perpendicular){var nearestSide,horizontalLineRect=g.rect(0,reference.y,this.paper.options.width,1),verticalLineRect=g.rect(reference.x,0,1,this.paper.options.height);if(horizontalLineRect.intersect(g.rect(spotBbox)))switch(nearestSide=g.rect(spotBbox).sideNearestToPoint(reference)){case"left":spot=g.point(spotBbox.x,reference.y);break;case"right":spot=g.point(spotBbox.x+spotBbox.width,reference.y);break;default:spot=g.rect(spotBbox).center()}else if(verticalLineRect.intersect(g.rect(spotBbox)))switch(nearestSide=g.rect(spotBbox).sideNearestToPoint(reference)){case"top":spot=g.point(reference.x,spotBbox.y);break;case"bottom":spot=g.point(reference.x,spotBbox.y+spotBbox.height);break;default:spot=g.rect(spotBbox).center()}else spot=g.rect(spotBbox).intersectionWithLineFromCenterToPoint(reference),spot=spot||g.rect(spotBbox).center()}else if(this.paper.options.linkConnectionPoint){var view="target"===end?this.targetView:this.sourceView,magnet="target"===end?this.targetMagnet:this.sourceMagnet;spot=this.paper.options.linkConnectionPoint(this,view,magnet,reference)}else spot=g.rect(spotBbox).intersectionWithLineFromCenterToPoint(reference),spot=spot||g.rect(spotBbox).center()}else spot=g.point(selectorOrPoint);return spot},getConnectionLength:function(){return this._V.connection.node.getTotalLength()},getPointAtLength:function(length){return this._V.connection.node.getPointAtLength(length)},_beforeArrowheadMove:function(){this._z=this.model.get("z"),this.model.toFront(),this.el.style.pointerEvents="none",this.paper.options.markAvailable&&this._markAvailableMagnets()},_afterArrowheadMove:function(){_.isNull(this._z)||(this.model.set("z",this._z,{ui:!0}),this._z=null),this.el.style.pointerEvents="visiblePainted",this.paper.options.markAvailable&&this._unmarkAvailableMagnets()},_createValidateConnectionArgs:function(arrowhead){function validateConnectionArgs(cellView,magnet){return args[j]=cellView,args[j+1]=cellView.el===magnet?void 0:magnet,args}var args=[];args[4]=arrowhead,args[5]=this;var oppositeArrowhead,i=0,j=0;"source"===arrowhead?(i=2,oppositeArrowhead="target"):(j=2,oppositeArrowhead="source");var end=this.model.get(oppositeArrowhead);return end.id&&(args[i]=this.paper.findViewByModel(end.id),args[i+1]=end.selector&&args[i].el.querySelector(end.selector)),validateConnectionArgs},_markAvailableMagnets:function(){function isMagnetAvailable(view,magnet){var paper=view.paper,validate=paper.options.validateConnection;return validate.apply(paper,this._validateConnectionArgs(view,magnet))}var paper=this.paper,elements=paper.model.getElements();this._marked={},_.chain(elements).map(paper.findViewByModel,paper).each(function(view){var magnets=Array.prototype.slice.call(view.el.querySelectorAll("[magnet]"));"false"!==view.el.getAttribute("magnet")&&magnets.push(view.el);var availableMagnets=_.filter(magnets,_.partial(isMagnetAvailable,view),this);availableMagnets.length>0&&(_.each(availableMagnets,_.partial(view.highlight,_,{magnetAvailability:!0}),view),view.highlight(null,{elementAvailability:!0}),this._marked[view.model.id]=availableMagnets)},this).value()},_unmarkAvailableMagnets:function(){_.each(this._marked,function(markedMagnets,id){var view=this.paper.findViewByModel(id);view&&(_.each(markedMagnets,_.partial(view.unhighlight,_,{magnetAvailability:!0}),view),view.unhighlight(null,{elementAvailability:!0}))},this),this._marked=null},startArrowheadMove:function(end,opt){opt=_.defaults(opt||{},{whenNotAllowed:"revert"}),this._action="arrowhead-move",this._whenNotAllowed=opt.whenNotAllowed,this._arrowhead=end,this._initialMagnet=this[end+"Magnet"]||(this[end+"View"]?this[end+"View"].el:null),this._initialEnd=_.clone(this.model.get(end))||{x:0,y:0},this._validateConnectionArgs=this._createValidateConnectionArgs(this._arrowhead),this._beforeArrowheadMove()},pointerdown:function(evt,x,y){if(joint.dia.CellView.prototype.pointerdown.apply(this,arguments),this.notify("link:pointerdown",evt,x,y),this._dx=x,this._dy=y,null==evt.target.getAttribute("magnet")){var labelNode,className=evt.target.getAttribute("class"),parentClassName=evt.target.parentNode.getAttribute("class");switch("label"===parentClassName?(className=parentClassName,labelNode=evt.target.parentNode):labelNode=evt.target,className){case"marker-vertex":
this.can("vertexMove")&&(this._action="vertex-move",this._vertexIdx=evt.target.getAttribute("idx"));break;case"marker-vertex-remove":case"marker-vertex-remove-area":this.can("vertexRemove")&&this.removeVertex(evt.target.getAttribute("idx"));break;case"marker-arrowhead":this.can("arrowheadMove")&&this.startArrowheadMove(evt.target.getAttribute("end"));break;case"label":this.can("labelMove")&&(this._action="label-move",this._labelIdx=parseInt(V(labelNode).attr("label-idx"),10),this._samples=this._V.connection.sample(1),this._linkLength=this._V.connection.node.getTotalLength());break;default:var targetParentEvent=evt.target.parentNode.getAttribute("event");targetParentEvent?this.can("useLinkTools")&&("remove"===targetParentEvent?this.model.remove():this.notify(targetParentEvent,evt,x,y)):this.can("vertexAdd")&&(this._vertexIdx=this.addVertex({x:x,y:y}),this._action="vertex-move")}}},pointermove:function(evt,x,y){switch(this._action){case"vertex-move":var vertices=_.clone(this.model.get("vertices"));vertices[this._vertexIdx]={x:x,y:y},this.model.set("vertices",vertices,{ui:!0});break;case"label-move":for(var closestSample,closestSampleIndex,p,sqDistance,dragPoint={x:x,y:y},samples=(this.model.get("labels")[this._labelIdx],this._samples),minSqDistance=1/0,i=0,len=samples.length;i<len;i++)p=samples[i],sqDistance=g.line(p,dragPoint).squaredLength(),sqDistance<minSqDistance&&(minSqDistance=sqDistance,closestSample=p,closestSampleIndex=i);var prevSample=samples[closestSampleIndex-1],nextSample=samples[closestSampleIndex+1],offset=(g.point(closestSample).distance(dragPoint),0);prevSample&&nextSample?offset=g.line(prevSample,nextSample).pointOffset(dragPoint):prevSample?offset=g.line(prevSample,closestSample).pointOffset(dragPoint):nextSample&&(offset=g.line(closestSample,nextSample).pointOffset(dragPoint)),this.model.label(this._labelIdx,{position:{distance:closestSample.distance/this._linkLength,offset:offset}});break;case"arrowhead-move":if(this.paper.options.snapLinks){var r=this.paper.options.snapLinks.radius||50,viewsInArea=this.paper.findViewsInArea({x:x-r,y:y-r,width:2*r,height:2*r});this._closestView&&this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this._closestView=this._closestEnd=null;var distance,minDistance=Number.MAX_VALUE,pointer=g.point(x,y);_.each(viewsInArea,function(view){"false"!==view.el.getAttribute("magnet")&&(distance=view.model.getBBox().center().distance(pointer),distance<r&&distance<minDistance&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(view,null))&&(minDistance=distance,this._closestView=view,this._closestEnd={id:view.model.id})),view.$("[magnet]").each(_.bind(function(index,magnet){var bbox=V(magnet).bbox(!1,this.paper.viewport);distance=pointer.distance({x:bbox.x+bbox.width/2,y:bbox.y+bbox.height/2}),distance<r&&distance<minDistance&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(view,magnet))&&(minDistance=distance,this._closestView=view,this._closestEnd={id:view.model.id,selector:view.getSelector(magnet),port:magnet.getAttribute("port")})},this))},this),this._closestView&&this._closestView.highlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),this.model.set(this._arrowhead,this._closestEnd||{x:x,y:y},{ui:!0})}else{var target="mousemove"===evt.type?evt.target:document.elementFromPoint(evt.clientX,evt.clientY);this._targetEvent!==target&&(this._magnetUnderPointer&&this._viewUnderPointer.unhighlight(this._magnetUnderPointer,{connecting:!0}),this._viewUnderPointer=this.paper.findView(target),this._viewUnderPointer?(this._magnetUnderPointer=this._viewUnderPointer.findMagnet(target),this._magnetUnderPointer&&this.paper.options.validateConnection.apply(this.paper,this._validateConnectionArgs(this._viewUnderPointer,this._magnetUnderPointer))?this._magnetUnderPointer&&this._viewUnderPointer.highlight(this._magnetUnderPointer,{connecting:!0}):this._magnetUnderPointer=null):this._magnetUnderPointer=null),this._targetEvent=target,this.model.set(this._arrowhead,{x:x,y:y},{ui:!0})}}this._dx=x,this._dy=y,joint.dia.CellView.prototype.pointermove.apply(this,arguments),this.notify("link:pointermove",evt,x,y)},pointerup:function(evt,x,y){if("label-move"===this._action)this._samples=null;else if("arrowhead-move"===this._action){var magnetUnderPointer,paper=this.paper,paperOptions=paper.options,arrowhead=this._arrowhead,initialEnd=this._initialEnd;if(paperOptions.snapLinks)this._closestView&&(this._closestView.unhighlight(this._closestEnd.selector,{connecting:!0,snapping:!0}),magnetUnderPointer=this._closestView.findMagnet(this._closestEnd.selector)),this._closestView=this._closestEnd=null;else{var viewUnderPointer=this._viewUnderPointer;if(magnetUnderPointer=this._magnetUnderPointer,this._viewUnderPointer=null,this._magnetUnderPointer=null,magnetUnderPointer){viewUnderPointer.unhighlight(magnetUnderPointer,{connecting:!0});var selector=viewUnderPointer.getSelector(magnetUnderPointer),port=magnetUnderPointer.getAttribute("port"),arrowheadValue={id:viewUnderPointer.model.id};null!=selector&&(arrowheadValue.port=port),null!=port&&(arrowheadValue.selector=selector),this.model.set(arrowhead,arrowheadValue,{ui:!0})}}if(!paper.linkAllowed(this))switch(this._whenNotAllowed){case"remove":this.model.remove();break;case"revert":default:this.model.set(arrowhead,initialEnd,{ui:!0})}paperOptions.embeddingMode&&this.model.reparent()&&(this._z=null);var currentEnd=this.model.prop(arrowhead)||{},endChanged=!joint.dia.Link.endsEqual(initialEnd,currentEnd);endChanged&&(initialEnd.id&&this.notify("link:disconnect",evt,paper.findViewByModel(initialEnd.id),this._initialMagnet,arrowhead),currentEnd.id&&this.notify("link:connect",evt,paper.findViewByModel(currentEnd.id),magnetUnderPointer,arrowhead)),this._afterArrowheadMove()}this._action=null,this._whenNotAllowed=null,this._initialMagnet=null,this._initialEnd=null,this._validateConnectionArgs=null,this.notify("link:pointerup",evt,x,y),joint.dia.CellView.prototype.pointerup.apply(this,arguments)}},{makeSelector:function(end){var selector='[model-id="'+end.id+'"]';return end.port?selector+=' [port="'+end.port+'"]':end.selector&&(selector+=" "+end.selector),selector}}),joint.dia.Paper=joint.mvc.View.extend({className:"paper",options:{width:800,height:600,origin:{x:0,y:0},gridSize:1,drawGrid:!1,perpendicularLinks:!1,elementView:joint.dia.ElementView,linkView:joint.dia.LinkView,snapLinks:!1,multiLinks:!0,guard:function(evt,view){return!1},highlighting:{"default":{name:"stroke",options:{padding:3}},magnetAvailability:{name:"addClass",options:{className:"available-magnet"}},elementAvailability:{name:"addClass",options:{className:"available-cell"}}},preventContextMenu:!0,restrictTranslate:!1,markAvailable:!1,defaultLink:new joint.dia.Link,defaultConnector:{name:"normal"},defaultRouter:{name:"normal"},validateMagnet:function(cellView,magnet){return"passive"!==magnet.getAttribute("magnet")},validateConnection:function(cellViewS,magnetS,cellViewT,magnetT,end,linkView){return("target"===end?cellViewT:cellViewS)instanceof joint.dia.ElementView},embeddingMode:!1,validateEmbedding:function(childView,parentView){return!0},findParentBy:"bbox",frontParentOnly:!0,interactive:{labelMove:!1},linkPinning:!0,clickThreshold:0,cellViewNamespace:joint.shapes,highlighterNamespace:joint.highlighters},events:{mousedown:"pointerdown",dblclick:"mousedblclick",click:"mouseclick",touchstart:"pointerdown",touchend:"mouseclick",touchmove:"pointermove",mousemove:"pointermove","mouseover .element":"cellMouseover","mouseover .link":"cellMouseover","mouseout .element":"cellMouseout","mouseout .link":"cellMouseout",contextmenu:"contextmenu",mousewheel:"mousewheel",DOMMouseScroll:"mousewheel"},_highlights:[],init:function(){_.bindAll(this,"pointerup"),this.model=this.options.model||new joint.dia.Graph,this.options.origin=_.clone(this.options.origin),this.options.defaultConnector=_.clone(this.options.defaultConnector),_.defaults(this.options.highlighting,this.constructor.prototype.options.highlighting),this.options.highlighting=_.cloneDeep(this.options.highlighting),this.svg=V("svg").node,this.viewport=V("g").addClass("viewport").node,this.defs=V("defs").node,V(this.svg).append([this.viewport,this.defs]),this.$el.append(this.svg),this.listenTo(this.model,"add",this.onCellAdded),this.listenTo(this.model,"remove",this.removeView),this.listenTo(this.model,"reset",this.resetViews),this.listenTo(this.model,"sort",this._onSort),this.listenTo(this.model,"batch:stop",this._onBatchStop),this.setOrigin(),this.setDimensions(),$(document).on("mouseup touchend",this.pointerup),this._mousemoved=0,this._views={},this.on("cell:highlight",this.onCellHighlight,this),this.on("cell:unhighlight",this.onCellUnhighlight,this)},_onSort:function(){this.model.hasActiveBatch("add")||this.sortViews()},_onBatchStop:function(data){var name=data&&data.batchName;"add"!==name||this.model.hasActiveBatch("add")||this.sortViews()},onRemove:function(){this.removeViews(),$(document).off("mouseup touchend",this.pointerup)},setDimensions:function(width,height){width=this.options.width=width||this.options.width,height=this.options.height=height||this.options.height,V(this.svg).attr({width:width,height:height}),this.trigger("resize",width,height)},setOrigin:function(ox,oy){this.options.origin.x=ox||0,this.options.origin.y=oy||0,V(this.viewport).translate(ox,oy,{absolute:!0}),this.trigger("translate",ox,oy),this.options.drawGrid&&this.drawGrid()},fitToContent:function(gridWidth,gridHeight,padding,opt){_.isObject(gridWidth)?(opt=gridWidth,gridWidth=opt.gridWidth||1,gridHeight=opt.gridHeight||1,padding=opt.padding||0):(opt=opt||{},gridWidth=gridWidth||1,gridHeight=gridHeight||1,padding=padding||0),padding=joint.util.normalizeSides(padding);var bbox=V(this.viewport).bbox(!0,this.svg),currentScale=V(this.viewport).scale();bbox.x*=currentScale.sx,bbox.y*=currentScale.sy,bbox.width*=currentScale.sx,bbox.height*=currentScale.sy;var calcWidth=Math.max(Math.ceil((bbox.width+bbox.x)/gridWidth),1)*gridWidth,calcHeight=Math.max(Math.ceil((bbox.height+bbox.y)/gridHeight),1)*gridHeight,tx=0,ty=0;("negative"==opt.allowNewOrigin&&bbox.x<0||"positive"==opt.allowNewOrigin&&bbox.x>=0||"any"==opt.allowNewOrigin)&&(tx=Math.ceil(-bbox.x/gridWidth)*gridWidth,tx+=padding.left,calcWidth+=tx),("negative"==opt.allowNewOrigin&&bbox.y<0||"positive"==opt.allowNewOrigin&&bbox.y>=0||"any"==opt.allowNewOrigin)&&(ty=Math.ceil(-bbox.y/gridHeight)*gridHeight,ty+=padding.top,calcHeight+=ty),calcWidth+=padding.right,calcHeight+=padding.bottom,calcWidth=Math.max(calcWidth,opt.minWidth||0),calcHeight=Math.max(calcHeight,opt.minHeight||0),calcWidth=Math.min(calcWidth,opt.maxWidth||Number.MAX_VALUE),calcHeight=Math.min(calcHeight,opt.maxHeight||Number.MAX_VALUE);var dimensionChange=calcWidth!=this.options.width||calcHeight!=this.options.height,originChange=tx!=this.options.origin.x||ty!=this.options.origin.y;originChange&&this.setOrigin(tx,ty),dimensionChange&&this.setDimensions(calcWidth,calcHeight)},scaleContentToFit:function(opt){var contentBBox=this.getContentBBox();if(contentBBox.width&&contentBBox.height){opt=opt||{},_.defaults(opt,{padding:0,preserveAspectRatio:!0,scaleGrid:null,minScale:0,maxScale:Number.MAX_VALUE});var padding=opt.padding,minScaleX=opt.minScaleX||opt.minScale,maxScaleX=opt.maxScaleX||opt.maxScale,minScaleY=opt.minScaleY||opt.minScale,maxScaleY=opt.maxScaleY||opt.maxScale,fittingBBox=opt.fittingBBox||{x:this.options.origin.x,y:this.options.origin.y,width:this.options.width,height:this.options.height};fittingBBox=g.rect(fittingBBox).moveAndExpand({x:padding,y:padding,width:-2*padding,height:-2*padding});var currentScale=V(this.viewport).scale(),newSx=fittingBBox.width/contentBBox.width*currentScale.sx,newSy=fittingBBox.height/contentBBox.height*currentScale.sy;if(opt.preserveAspectRatio&&(newSx=newSy=Math.min(newSx,newSy)),opt.scaleGrid){var gridSize=opt.scaleGrid;newSx=gridSize*Math.floor(newSx/gridSize),newSy=gridSize*Math.floor(newSy/gridSize)}newSx=Math.min(maxScaleX,Math.max(minScaleX,newSx)),newSy=Math.min(maxScaleY,Math.max(minScaleY,newSy)),this.scale(newSx,newSy);var contentTranslation=this.getContentBBox(),newOx=fittingBBox.x-contentTranslation.x,newOy=fittingBBox.y-contentTranslation.y;this.setOrigin(newOx,newOy)}},getContentBBox:function(){var crect=this.viewport.getBoundingClientRect(),screenCTM=this.viewport.getScreenCTM(),viewportCTM=this.viewport.getCTM();return g.rect({x:crect.left-screenCTM.e+viewportCTM.e,y:crect.top-screenCTM.f+viewportCTM.f,width:crect.width,height:crect.height})},getArea:function(){var transformationMatrix=this.viewport.getCTM().inverse(),noTransformationBBox={x:0,y:0,width:this.options.width,height:this.options.height};return g.rect(V.transformRect(noTransformationBBox,transformationMatrix))},getRestrictedArea:function(){var restrictedArea;return restrictedArea=_.isFunction(this.options.restrictTranslate)?this.options.restrictTranslate.apply(this,arguments):this.options.restrictTranslate===!0?this.getArea():this.options.restrictTranslate||null},createViewForModel:function(cell){var optionalViewClass,defaultViewClass,namespace=this.options.cellViewNamespace,type=cell.get("type")+"View",namespaceViewClass=joint.util.getByPath(namespace,type,".");cell.isLink()?(optionalViewClass=this.options.linkView,defaultViewClass=joint.dia.LinkView):(optionalViewClass=this.options.elementView,defaultViewClass=joint.dia.ElementView);var ViewClass=optionalViewClass.prototype instanceof Backbone.View?namespaceViewClass||optionalViewClass:optionalViewClass.call(this,cell)||namespaceViewClass||defaultViewClass;return new ViewClass({model:cell,interactive:this.options.interactive})},onCellAdded:function(cell,graph,opt){if(this.options.async&&opt.async!==!1&&_.isNumber(opt.position)){if(this._asyncCells=this._asyncCells||[],this._asyncCells.push(cell),0==opt.position){if(this._frameId)throw new Error("another asynchronous rendering in progress");this.asyncRenderViews(this._asyncCells,opt),delete this._asyncCells}}else this.renderView(cell)},removeView:function(cell){var view=this._views[cell.id];return view&&(view.remove(),delete this._views[cell.id]),view},renderView:function(cell){var view=this._views[cell.id]=this.createViewForModel(cell);return V(this.viewport).append(view.el),view.paper=this,view.render(),$(view.el).find("image").on("dragstart",function(){return!1}),view},beforeRenderViews:function(cells){return cells.sort(function(a){return a instanceof joint.dia.Link?1:-1}),cells},afterRenderViews:function(){this.sortViews()},resetViews:function(cellsCollection,opt){this.removeViews();var cells=cellsCollection.models.slice();cells=this.beforeRenderViews(cells,opt)||cells,this._frameId&&(joint.util.cancelFrame(this._frameId),delete this._frameId),this.options.async?this.asyncRenderViews(cells,opt):(_.each(cells,this.renderView,this),this.sortViews())},removeViews:function(){_.invoke(this._views,"remove"),this._views={}},asyncBatchAdded:_.noop,asyncRenderViews:function(cells,opt){if(this._frameId){var batchSize=this.options.async&&this.options.async.batchSize||50,batchCells=cells.splice(0,batchSize),collection=this.model.get("cells");_.each(batchCells,function(cell){cell.collection===collection&&this.renderView(cell)},this),this.asyncBatchAdded()}cells.length?this._frameId=joint.util.nextFrame(function(){this.asyncRenderViews(cells,opt)},this):(delete this._frameId,this.afterRenderViews(opt),this.trigger("render:done",opt))},sortViews:function(){var $cells=$(this.viewport).children("[model-id]"),cells=this.model.get("cells");joint.util.sortElements($cells,function(a,b){var cellA=cells.get($(a).attr("model-id")),cellB=cells.get($(b).attr("model-id"));return(cellA.get("z")||0)>(cellB.get("z")||0)?1:-1})},scale:function(sx,sy,ox,oy){sy=sy||sx,_.isUndefined(ox)&&(ox=0,oy=0),V(this.viewport).attr("transform","");var oldTx=this.options.origin.x,oldTy=this.options.origin.y;if(ox||oy||oldTx||oldTy){var newTx=oldTx-ox*(sx-1),newTy=oldTy-oy*(sy-1);this.setOrigin(newTx,newTy)}return V(this.viewport).scale(sx,sy),this.trigger("scale",sx,sy,ox,oy),this.options.drawGrid&&this.drawGrid(),this},rotate:function(deg,ox,oy){if(_.isUndefined(ox)){var bbox=this.viewport.getBBox();ox=bbox.width/2,oy=bbox.height/2}V(this.viewport).rotate(deg,ox,oy)},findView:function($el){for(var el=_.isString($el)?this.viewport.querySelector($el):$el instanceof $?$el[0]:$el;el&&el!==this.el&&el!==document;){var id=el.getAttribute("model-id");if(id)return this._views[id];el=el.parentNode}},findViewByModel:function(cell){var id=_.isString(cell)?cell:cell.id;return this._views[id]},findViewsFromPoint:function(p){p=g.point(p);var views=_.map(this.model.getElements(),this.findViewByModel,this);return _.filter(views,function(view){return view&&g.rect(view.vel.bbox(!1,this.viewport)).containsPoint(p)},this)},findViewsInArea:function(rect,opt){opt=_.defaults(opt||{},{strict:!1}),rect=g.rect(rect);var views=_.map(this.model.getElements(),this.findViewByModel,this),method=opt.strict?"containsRect":"intersect";return _.filter(views,function(view){return view&&rect[method](g.rect(view.vel.bbox(!1,this.viewport)))},this)},getModelById:function(id){return this.model.getCell(id)},snapToGrid:function(p){var localPoint=V(this.viewport).toLocalPoint(p.x,p.y);return{x:g.snapToGrid(localPoint.x,this.options.gridSize),y:g.snapToGrid(localPoint.y,this.options.gridSize)}},clientToLocalPoint:function(p){p=g.point(p);var fakeRect=V("rect",{width:this.options.width,height:this.options.height,x:0,y:0,opacity:0});V(this.svg).prepend(fakeRect);var paperOffset=$(this.svg).offset();fakeRect.remove();var scrollTop=document.body.scrollTop||document.documentElement.scrollTop,scrollLeft=document.body.scrollLeft||document.documentElement.scrollLeft;return p.offset(scrollLeft-paperOffset.left,scrollTop-paperOffset.top),V.transformPoint(p,this.viewport.getCTM().inverse())},linkAllowed:function(linkViewOrModel){var link;if(linkViewOrModel instanceof joint.dia.Link)link=linkViewOrModel;else{if(!(linkViewOrModel instanceof joint.dia.LinkView))throw new Error("Must provide link model or view.");link=linkViewOrModel.model}if(!this.options.multiLinks){var source=link.get("source"),target=link.get("target");if(source.id&&target.id){var sourceModel=link.getSourceElement();if(sourceModel){var connectedLinks=this.model.getConnectedLinks(sourceModel,{outbound:!0,inbound:!1}),numSameLinks=_.filter(connectedLinks,function(_link){var _source=_link.get("source"),_target=_link.get("target");return _source&&_source.id===source.id&&(!_source.port||_source.port===source.port)&&_target&&_target.id===target.id&&(!_target.port||_target.port===target.port)}).length;if(numSameLinks>1)return!1}}}return!!(this.options.linkPinning||_.has(link.get("source"),"id")&&_.has(link.get("target"),"id"))},getDefaultLink:function(cellView,magnet){return _.isFunction(this.options.defaultLink)?this.options.defaultLink.call(this,cellView,magnet):this.options.defaultLink.clone()},resolveHighlighter:function(opt){opt=opt||{};var highlighterDef=opt.highlighter,paperOpt=this.options;if(_.isUndefined(highlighterDef)){var type=_.chain(opt).pick("embedding","connecting","magnetAvailability","elementAvailability").keys().first().value();highlighterDef=type&&paperOpt.highlighting[type]||paperOpt.highlighting["default"]}if(!highlighterDef)return!1;var name=highlighterDef.name,highlighter=paperOpt.highlighterNamespace[name];if(!highlighter)throw new Error('Unknown highlighter ("'+name+'")');if("function"!=typeof highlighter.highlight)throw new Error('Highlighter ("'+name+'") is missing required highlight() method');if("function"!=typeof highlighter.unhighlight)throw new Error('Highlighter ("'+name+'") is missing required unhighlight() method');return{highlighter:highlighter,options:highlighterDef.options,name:name}},onCellHighlight:function(cellView,magnetEl,opt){if(opt=this.resolveHighlighter(opt)){var key=opt.name+magnetEl.id+JSON.stringify(opt.options);if(!this._highlights[key]){var highlighter=opt.highlighter;highlighter.highlight(cellView,magnetEl,_.clone(opt.options)),this._highlights[key]={cellView:cellView,magnetEl:magnetEl,opt:opt.options,highlighter:highlighter}}}},onCellUnhighlight:function(cellView,magnetEl,opt){if(opt=this.resolveHighlighter(opt)){var key=opt.name+magnetEl.id+JSON.stringify(opt.options),highlight=this._highlights[key];highlight&&(highlight.highlighter.unhighlight(highlight.cellView,highlight.magnetEl,highlight.opt),this._highlights[key]=null)}},mousedblclick:function(evt){evt.preventDefault(),evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(!this.guard(evt,view)){var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});view?view.pointerdblclick(evt,localPoint.x,localPoint.y):this.trigger("blank:pointerdblclick",evt,localPoint.x,localPoint.y)}},mouseclick:function(evt){if(this._mousemoved<=this.options.clickThreshold){evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(this.guard(evt,view))return;var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});view?view.pointerclick(evt,localPoint.x,localPoint.y):this.trigger("blank:pointerclick",evt,localPoint.x,localPoint.y)}},guard:function(evt,view){return!(!this.options.guard||!this.options.guard(evt,view))||!(view&&view.model&&view.model instanceof joint.dia.Cell)&&(this.svg!==evt.target&&this.el!==evt.target&&!$.contains(this.svg,evt.target))},contextmenu:function(evt){evt=joint.util.normalizeEvent(evt),this.options.preventContextMenu&&evt.preventDefault();var view=this.findView(evt.target);if(!this.guard(evt,view)){var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});view?view.contextmenu(evt,localPoint.x,localPoint.y):this.trigger("blank:contextmenu",evt,localPoint.x,localPoint.y)}},pointerdown:function(evt){evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(!this.guard(evt,view)){evt.preventDefault(),this._mousemoved=0;var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});view?(this.sourceView=view,view.pointerdown(evt,localPoint.x,localPoint.y)):this.trigger("blank:pointerdown",evt,localPoint.x,localPoint.y)}},pointermove:function(evt){if(this.sourceView){evt.preventDefault(),evt=joint.util.normalizeEvent(evt),this._mousemoved++;var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});this.sourceView.pointermove(evt,localPoint.x,localPoint.y)}},pointerup:function(evt){evt=joint.util.normalizeEvent(evt);var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});this.sourceView?(this.sourceView.pointerup(evt,localPoint.x,localPoint.y),this.sourceView=null):this.trigger("blank:pointerup",evt,localPoint.x,localPoint.y)},mousewheel:function(evt){evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(!this.guard(evt,view)){var originalEvent=evt.originalEvent,localPoint=this.snapToGrid({x:originalEvent.clientX,y:originalEvent.clientY}),delta=Math.max(-1,Math.min(1,originalEvent.wheelDelta||-originalEvent.detail));view?view.mousewheel(evt,localPoint.x,localPoint.y,delta):this.trigger("blank:mousewheel",evt,localPoint.x,localPoint.y,delta)}},cellMouseover:function(evt){evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(view){if(this.guard(evt,view))return;view.mouseover(evt)}},cellMouseout:function(evt){evt=joint.util.normalizeEvent(evt);var view=this.findView(evt.target);if(view){if(this.guard(evt,view))return;view.mouseout(evt)}},setGridSize:function(gridSize){return this.options.gridSize=gridSize,this.options.drawGrid&&this.drawGrid(),this},clearGrid:function(){return this.el.style.backgroundImage="none",this},drawGrid:function(opt){opt=_.defaults(opt||{},this.options.drawGrid,{color:"#aaa",thickness:1});var gridSize=this.options.gridSize;if(gridSize<=1)return this.clearGrid();var currentScale=V(this.viewport).scale(),scaleX=currentScale.sx,scaleY=currentScale.sy,originX=this.options.origin.x,originY=this.options.origin.y,gridX=gridSize*scaleX,gridY=gridSize*scaleY,canvas=document.createElement("canvas");canvas.width=gridX,canvas.height=gridY,gridX=originX>=0?originX%gridX:gridX+originX%gridX,gridY=originY>=0?originY%gridY:gridY+originY%gridY;var context=canvas.getContext("2d");context.beginPath(),context.rect(gridX,gridY,opt.thickness*scaleX,opt.thickness*scaleY),context.fillStyle=opt.color,context.fill();var backgroundImage=canvas.toDataURL("image/png");return this.el.style.backgroundImage='url("'+backgroundImage+'")',this},setInteractivity:function(value){this.options.interactive=value,_.invoke(this._views,"setInteractivity",value)}}),joint.shapes.basic={},joint.shapes.basic.Generic=joint.dia.Element.extend({defaults:joint.util.deepSupplement({type:"basic.Generic",attrs:{".":{fill:"#ffffff",stroke:"none"}}},joint.dia.Element.prototype.defaults)}),joint.shapes.basic.Rect=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><rect/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Rect",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:100,height:60},text:{fill:"#000000",text:"","font-size":14,"ref-x":.5,"ref-y":.5,"text-anchor":"middle","y-alignment":"middle","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.TextView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.listenTo(this.model,"change:attrs",this.resize)}}),joint.shapes.basic.Text=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><text/></g></g>',defaults:joint.util.deepSupplement({type:"basic.Text",attrs:{text:{"font-size":18,fill:"#000000"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Circle=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><circle/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Circle",size:{width:60,height:60},attrs:{circle:{fill:"#ffffff",stroke:"#000000",r:30,cx:30,cy:30},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Ellipse=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><ellipse/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Ellipse",size:{width:60,height:40},attrs:{ellipse:{fill:"#ffffff",stroke:"#000000",rx:30,ry:20,cx:30,cy:20},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-y":.5,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Polygon=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polygon/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polygon",size:{width:60,height:40},attrs:{polygon:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Polyline=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><polyline/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Polyline",size:{width:60,height:40},attrs:{polyline:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Image=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><image/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Image",attrs:{text:{"font-size":14,text:"","text-anchor":"middle","ref-x":.5,"ref-dy":20,"y-alignment":"middle",fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Path=joint.shapes.basic.Generic.extend({markup:'<g class="rotatable"><g class="scalable"><path/></g><text/></g>',defaults:joint.util.deepSupplement({type:"basic.Path",size:{width:60,height:60},attrs:{path:{fill:"#ffffff",stroke:"#000000"},text:{"font-size":14,text:"","text-anchor":"middle",ref:"path","ref-x":.5,"ref-dy":10,fill:"#000000","font-family":"Arial, helvetica, sans-serif"}}},joint.shapes.basic.Generic.prototype.defaults)}),joint.shapes.basic.Rhombus=joint.shapes.basic.Path.extend({defaults:joint.util.deepSupplement({type:"basic.Rhombus",attrs:{path:{d:"M 30 0 L 60 30 30 60 0 30 z"},text:{"ref-y":.5,"y-alignment":"middle"}}},joint.shapes.basic.Path.prototype.defaults)}),joint.shapes.basic.PortsModelInterface={initialize:function(){this.updatePortsAttrs(),this.on("change:inPorts change:outPorts",this.updatePortsAttrs,this),this.constructor.__super__.constructor.__super__.initialize.apply(this,arguments)},updatePortsAttrs:function(eventName){if(this._portSelectors){var newAttrs=_.omit(this.get("attrs"),this._portSelectors);this.set("attrs",newAttrs,{silent:!0})}this._portSelectors=[];var attrs={};_.each(this.get("inPorts"),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,".inPorts","in");this._portSelectors=this._portSelectors.concat(_.keys(portAttributes)),_.extend(attrs,portAttributes)},this),_.each(this.get("outPorts"),function(portName,index,ports){var portAttributes=this.getPortAttrs(portName,index,ports.length,".outPorts","out");this._portSelectors=this._portSelectors.concat(_.keys(portAttributes)),_.extend(attrs,portAttributes)},this),this.attr(attrs,{silent:!0}),this.processPorts(),this.trigger("process:ports")},getPortSelector:function(name){var selector=".inPorts",index=this.get("inPorts").indexOf(name);if(index<0&&(selector=".outPorts",index=this.get("outPorts").indexOf(name),index<0))throw new Error("getPortSelector(): Port doesn't exist.");return selector+">g:nth-child("+(index+1)+")>.port-body"}},joint.shapes.basic.PortsViewInterface={initialize:function(){this.listenTo(this.model,"process:ports",this.update),joint.dia.ElementView.prototype.initialize.apply(this,arguments)},update:function(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},renderPorts:function(){var $inPorts=this.$(".inPorts").empty(),$outPorts=this.$(".outPorts").empty(),portTemplate=joint.util.template(this.model.portMarkup);_.each(_.filter(this.model.ports,function(p){return"in"===p.type}),function(port,index){$inPorts.append(V(portTemplate({id:index,port:port})).node)}),_.each(_.filter(this.model.ports,function(p){return"out"===p.type}),function(port,index){$outPorts.append(V(portTemplate({id:index,port:port})).node)})}},joint.shapes.basic.TextBlock=joint.shapes.basic.Generic.extend({markup:['<g class="rotatable">','<g class="scalable"><rect/></g>',joint.env.test("svgforeignobject")?'<foreignObject class="fobj"><body xmlns="http://www.w3.org/1999/xhtml"><div class="content"/></body></foreignObject>':'<text class="content"/>',"</g>"].join(""),defaults:joint.util.deepSupplement({type:"basic.TextBlock",attrs:{rect:{fill:"#ffffff",stroke:"#000000",width:80,height:100},text:{fill:"#000000","font-size":14,"font-family":"Arial, helvetica, sans-serif"},".content":{text:"",ref:"rect","ref-x":.5,"ref-y":.5,"y-alignment":"middle","x-alignment":"middle"}},content:""},joint.shapes.basic.Generic.prototype.defaults),initialize:function(){this.listenTo(this,"change:size",this.updateSize),this.listenTo(this,"change:content",this.updateContent),this.updateSize(this,this.get("size")),this.updateContent(this,this.get("content")),joint.shapes.basic.Generic.prototype.initialize.apply(this,arguments)},updateSize:function(cell,size){this.attr({".fobj":_.clone(size),div:{style:_.clone(size)}})},updateContent:function(cell,content){joint.env.test("svgforeignobject")?this.attr({
".content":{html:content}}):this.attr({".content":{text:content}})},setForeignObjectSize:function(){this.updateSize.apply(this,arguments)},setDivContent:function(){this.updateContent.apply(this,arguments)}}),joint.shapes.basic.TextBlockView=joint.dia.ElementView.extend({initialize:function(){joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.noSVGForeignObjectElement=!joint.env.test("svgforeignobject"),joint.env.test("svgforeignobject")||this.listenTo(this.model,"change:content",function(cell){this.updateContent(cell)})},update:function(cell,renderingOnlyAttrs){if(joint.env.test("svgforeignobject")){var model=this.model,noTextAttrs=_.omit(renderingOnlyAttrs||model.get("attrs"),".content");joint.dia.ElementView.prototype.update.call(this,model,noTextAttrs),renderingOnlyAttrs&&!_.has(renderingOnlyAttrs,".content")||this.updateContent(model,renderingOnlyAttrs)}else joint.dia.ElementView.prototype.update.call(this,model,renderingOnlyAttrs)},updateContent:function(cell,renderingOnlyAttrs){var textAttrs=_.merge({},(renderingOnlyAttrs||cell.get("attrs"))[".content"]);textAttrs=_.omit(textAttrs,"text");var text=joint.util.breakText(cell.get("content"),cell.get("size"),textAttrs,{svgDocument:this.paper.svg}),attrs=joint.util.setByPath({},".content",textAttrs,"/");attrs[".content"].text=text,joint.dia.ElementView.prototype.update.call(this,cell,attrs)}}),joint.routers.manhattan=function(g,_,joint){"use strict";function ObstacleMap(opt){this.map={},this.options=opt,this.mapGridSize=100}function SortedSet(){this.items=[],this.hash={},this.values={},this.OPEN=1,this.CLOSE=2}function normalizePoint(point){return g.point(0===point.x?0:Math.abs(point.x)/point.x,0===point.y?0:Math.abs(point.y)/point.y)}function reconstructRoute(parents,point,startCenter,endCenter){for(var parent,route=[],prevDiff=normalizePoint(endCenter.difference(point)),current=point;parent=parents[current];){var diff=normalizePoint(current.difference(parent));diff.equals(prevDiff)||(route.unshift(current),prevDiff=diff),current=parent}var startDiff=normalizePoint(g.point(current).difference(startCenter));return startDiff.equals(prevDiff)||route.unshift(current),route}function getRectPoints(bbox,directionList,opt){var step=opt.step,center=bbox.center(),startPoints=_.chain(opt.directionMap).pick(directionList).map(function(direction){var x=direction.x*bbox.width/2,y=direction.y*bbox.height/2,point=center.clone().offset(x,y);return bbox.containsPoint(point)&&point.offset(direction.x*step,direction.y*step),point.snapToGrid(step)}).value();return startPoints}function getDirectionAngle(start,end,dirLen){var q=360/dirLen;return Math.floor(g.normalizeAngle(start.theta(end)+q/2)/q)*q}function getDirectionChange(angle1,angle2){var dirChange=Math.abs(angle1-angle2);return dirChange>180?360-dirChange:dirChange}function estimateCost(from,endPoints){for(var min=1/0,i=0,len=endPoints.length;i<len;i++){var cost=from.manhattanDistance(endPoints[i]);cost<min&&(min=cost)}return min}function findRoute(start,end,map,opt){var startPoints,endPoints,startCenter,endCenter,step=opt.step;if(start instanceof g.rect?(startPoints=getRectPoints(start,opt.startDirections,opt),startCenter=start.center().snapToGrid(step)):(startCenter=start.clone().snapToGrid(step),startPoints=[startCenter]),end instanceof g.rect?(endPoints=getRectPoints(end,opt.endDirections,opt),endCenter=end.center().snapToGrid(step)):(endCenter=end.clone().snapToGrid(step),endPoints=[endCenter]),startPoints=_.filter(startPoints,map.isPointAccessible,map),endPoints=_.filter(endPoints,map.isPointAccessible,map),startPoints.length>0&&endPoints.length>0){var openSet=new SortedSet,parents={},costs={};_.each(startPoints,function(point){var key=point.toString();openSet.add(key,estimateCost(point,endPoints)),costs[key]=0});for(var dir,dirChange,dirs=opt.directions,dirLen=dirs.length,loopsRemain=opt.maximumLoops,endPointsKeys=_.invoke(endPoints,"toString");!openSet.isEmpty()&&loopsRemain>0;){var currentKey=openSet.pop(),currentPoint=g.point(currentKey),currentDist=costs[currentKey],previousDirAngle=currentDirAngle,currentDirAngle=parents[currentKey]?getDirectionAngle(parents[currentKey],currentPoint,dirLen):null!=opt.previousDirAngle?opt.previousDirAngle:getDirectionAngle(startCenter,currentPoint,dirLen);if(endPointsKeys.indexOf(currentKey)>=0&&(dirChange=getDirectionChange(currentDirAngle,getDirectionAngle(currentPoint,endCenter,dirLen)),currentPoint.equals(endCenter)||dirChange<180))return opt.previousDirAngle=currentDirAngle,reconstructRoute(parents,currentPoint,startCenter,endCenter);for(var i=0;i<dirLen;i++)if(dir=dirs[i],dirChange=getDirectionChange(currentDirAngle,dir.angle),!(previousDirAngle&&dirChange>opt.maxAllowedDirectionChange)){var neighborPoint=currentPoint.clone().offset(dir.offsetX,dir.offsetY),neighborKey=neighborPoint.toString();if(!openSet.isClose(neighborKey)&&map.isPointAccessible(neighborPoint)){var costFromStart=currentDist+dir.cost+opt.penalties[dirChange];(!openSet.isOpen(neighborKey)||costFromStart<costs[neighborKey])&&(parents[neighborKey]=currentPoint,costs[neighborKey]=costFromStart,openSet.add(neighborKey,costFromStart+estimateCost(neighborPoint,endPoints)))}}loopsRemain--}}return opt.fallbackRoute(startCenter,endCenter,opt)}function resolveOptions(opt){opt.directions=_.result(opt,"directions"),opt.penalties=_.result(opt,"penalties"),opt.paddingBox=_.result(opt,"paddingBox"),_.each(opt.directions,function(direction){var point1=g.point(0,0),point2=g.point(direction.offsetX,direction.offsetY);direction.angle=g.normalizeAngle(point1.theta(point2))})}function router(vertices,opt){resolveOptions(opt),this.options.perpendicular=!!opt.perpendicular;for(var sourceBBox=g.rect(this.sourceBBox).moveAndExpand(opt.paddingBox),targetBBox=g.rect(this.targetBBox).moveAndExpand(opt.paddingBox),map=new ObstacleMap(opt).build(this.paper.model,this.model),oldVertices=_.map(vertices,g.point),newVertices=[],tailPoint=sourceBBox.center().snapToGrid(opt.step),i=0,len=oldVertices.length;i<=len;i++){var partialRoute=null,from=to||sourceBBox,to=oldVertices[i];if(!to){to=targetBBox;var endingAtPoint=!this.model.get("source").id||!this.model.get("target").id;if(endingAtPoint&&_.isFunction(opt.draggingRoute)){var dragFrom=from instanceof g.rect?from.center():from;partialRoute=opt.draggingRoute(dragFrom,to.origin(),opt)}}if(partialRoute=partialRoute||findRoute(from,to,map,opt),null===partialRoute){if(!_.isFunction(joint.routers.orthogonal))throw new Error("Manhattan requires the orthogonal router.");return joint.routers.orthogonal(vertices,opt,this)}var leadPoint=_.first(partialRoute);leadPoint&&leadPoint.equals(tailPoint)&&partialRoute.shift(),tailPoint=_.last(partialRoute)||tailPoint,Array.prototype.push.apply(newVertices,partialRoute)}return newVertices}var config={step:10,perpendicular:!0,excludeEnds:[],excludeTypes:["basic.Text"],maximumLoops:2e3,startDirections:["left","right","top","bottom"],endDirections:["left","right","top","bottom"],directionMap:{right:{x:1,y:0},bottom:{x:0,y:1},left:{x:-1,y:0},top:{x:0,y:-1}},maxAllowedDirectionChange:90,paddingBox:function(){var step=this.step;return{x:-step,y:-step,width:2*step,height:2*step}},directions:function(){var step=this.step;return[{offsetX:step,offsetY:0,cost:step},{offsetX:0,offsetY:step,cost:step},{offsetX:-step,offsetY:0,cost:step},{offsetX:0,offsetY:-step,cost:step}]},penalties:function(){return{0:0,45:this.step/2,90:this.step/2}},fallbackRoute:_.constant(null),draggingRoute:null};return ObstacleMap.prototype.build=function(graph,link){var opt=this.options,excludedEnds=_.chain(opt.excludeEnds).map(link.get,link).pluck("id").map(graph.getCell,graph).value(),excludedAncestors=[],source=graph.getCell(link.get("source").id);source&&(excludedAncestors=_.union(excludedAncestors,_.map(source.getAncestors(),"id")));var target=graph.getCell(link.get("target").id);target&&(excludedAncestors=_.union(excludedAncestors,_.map(target.getAncestors(),"id")));var mapGridSize=this.mapGridSize;return _.chain(graph.getElements()).difference(excludedEnds).reject(function(element){return _.contains(opt.excludeTypes,element.get("type"))||_.contains(excludedAncestors,element.id)}).invoke("getBBox").invoke("moveAndExpand",opt.paddingBox).foldl(function(map,bbox){for(var origin=bbox.origin().snapToGrid(mapGridSize),corner=bbox.corner().snapToGrid(mapGridSize),x=origin.x;x<=corner.x;x+=mapGridSize)for(var y=origin.y;y<=corner.y;y+=mapGridSize){var gridKey=x+"@"+y;map[gridKey]=map[gridKey]||[],map[gridKey].push(bbox)}return map},this.map).value(),this},ObstacleMap.prototype.isPointAccessible=function(point){var mapKey=point.clone().snapToGrid(this.mapGridSize).toString();return _.every(this.map[mapKey],function(obstacle){return!obstacle.containsPoint(point)})},SortedSet.prototype.add=function(item,value){this.hash[item]?this.items.splice(this.items.indexOf(item),1):this.hash[item]=this.OPEN,this.values[item]=value;var index=_.sortedIndex(this.items,item,function(i){return this.values[i]},this);this.items.splice(index,0,item)},SortedSet.prototype.remove=function(item){this.hash[item]=this.CLOSE},SortedSet.prototype.isOpen=function(item){return this.hash[item]===this.OPEN},SortedSet.prototype.isClose=function(item){return this.hash[item]===this.CLOSE},SortedSet.prototype.isEmpty=function(){return 0===this.items.length},SortedSet.prototype.pop=function(){var item=this.items.shift();return this.remove(item),item},function(vertices,opt,linkView){return router.call(linkView,vertices,_.extend({},config,opt))}}(g,_,joint),joint.routers.metro=function(){if(!_.isFunction(joint.routers.manhattan))throw new Error("Metro requires the manhattan router.");var config={diagonalCost:null,directions:function(){var step=this.step,diagonalCost=this.diagonalCost||Math.ceil(Math.sqrt(step*step<<1));return[{offsetX:step,offsetY:0,cost:step},{offsetX:step,offsetY:step,cost:diagonalCost},{offsetX:0,offsetY:step,cost:step},{offsetX:-step,offsetY:step,cost:diagonalCost},{offsetX:-step,offsetY:0,cost:step},{offsetX:-step,offsetY:-step,cost:diagonalCost},{offsetX:0,offsetY:-step,cost:step},{offsetX:step,offsetY:-step,cost:diagonalCost}]},maxAllowedDirectionChange:45,fallbackRoute:function(from,to,opts){var theta=from.theta(to),a={x:to.x,y:from.y},b={x:from.x,y:to.y};if(theta%180>90){var t=a;a=b,b=t}var p1=theta%90<45?a:b,l1=g.line(from,p1),alpha=90*Math.ceil(theta/90),p2=g.point.fromPolar(l1.squaredLength(),g.toRad(alpha+135),p1),l2=g.line(to,p2),point=l1.intersection(l2);return point?[point.round(),to]:[to]}};return function(vertices,opts,linkView){return joint.routers.manhattan(vertices,_.extend({},config,opts),linkView)}}(),joint.routers.normal=function(vertices,opt,linkView){return vertices},joint.routers.oneSide=function(vertices,opt,linkView){var coordinate,dimension,direction,side=opt.side||"bottom",padding=opt.padding||40,sourceBBox=linkView.sourceBBox,targetBBox=linkView.targetBBox,sourcePoint=sourceBBox.center(),targetPoint=targetBBox.center();switch(side){case"bottom":direction=1,coordinate="y",dimension="height";break;case"top":direction=-1,coordinate="y",dimension="height";break;case"left":direction=-1,coordinate="x",dimension="width";break;case"right":direction=1,coordinate="x",dimension="width";break;default:throw new Error("Router: invalid side")}return sourcePoint[coordinate]+=direction*(sourceBBox[dimension]/2+padding),targetPoint[coordinate]+=direction*(targetBBox[dimension]/2+padding),direction*(sourcePoint[coordinate]-targetPoint[coordinate])>0?targetPoint[coordinate]=sourcePoint[coordinate]:sourcePoint[coordinate]=targetPoint[coordinate],[sourcePoint].concat(vertices,targetPoint)},joint.routers.orthogonal=function(){function bearing(from,to){return from.x==to.x?from.y>to.y?"N":"S":from.y==to.y?from.x>to.x?"W":"E":null}function boxSize(bbox,brng){return bbox["W"==brng||"E"==brng?"width":"height"]}function expand(bbox,val){return g.rect(bbox).moveAndExpand({x:-val,y:-val,width:2*val,height:2*val})}function pointBox(p){return g.rect(p.x,p.y,0,0)}function boundary(bbox1,bbox2){var x1=Math.min(bbox1.x,bbox2.x),y1=Math.min(bbox1.y,bbox2.y),x2=Math.max(bbox1.x+bbox1.width,bbox2.x+bbox2.width),y2=Math.max(bbox1.y+bbox1.height,bbox2.y+bbox2.height);return g.rect(x1,y1,x2-x1,y2-y1)}function freeJoin(p1,p2,bbox){var p=g.point(p1.x,p2.y);return bbox.containsPoint(p)&&(p=g.point(p2.x,p1.y)),p}function vertexVertex(from,to,brng){var p1=g.point(from.x,to.y),p2=g.point(to.x,from.y),d1=bearing(from,p1),d2=bearing(from,p2),xBrng=opposite[brng],p=d1==brng||d1!=xBrng&&(d2==xBrng||d2!=brng)?p1:p2;return{points:[p],direction:bearing(p,to)}}function elementVertex(from,to,fromBBox){var p=freeJoin(from,to,fromBBox);return{points:[p],direction:bearing(p,to)}}function vertexElement(from,to,toBBox,brng){var p,route={},pts=[g.point(from.x,to.y),g.point(to.x,from.y)],freePts=_.filter(pts,function(pt){return!toBBox.containsPoint(pt)}),freeBrngPts=_.filter(freePts,function(pt){return bearing(pt,from)!=brng});if(freeBrngPts.length>0)p=_.filter(freeBrngPts,function(pt){return bearing(from,pt)==brng}).pop(),p=p||freeBrngPts[0],route.points=[p],route.direction=bearing(p,to);else{p=_.difference(pts,freePts)[0];var p2=g.point(to).move(p,-boxSize(toBBox,brng)/2),p1=freeJoin(p2,from,toBBox);route.points=[p1,p2],route.direction=bearing(p2,to)}return route}function elementElement(from,to,fromBBox,toBBox){var route=elementVertex(to,from,toBBox),p1=route.points[0];if(fromBBox.containsPoint(p1)){route=elementVertex(from,to,fromBBox);var p2=route.points[0];if(toBBox.containsPoint(p2)){var fromBorder=g.point(from).move(p2,-boxSize(fromBBox,bearing(from,p2))/2),toBorder=g.point(to).move(p1,-boxSize(toBBox,bearing(to,p1))/2),mid=g.line(fromBorder,toBorder).midpoint(),startRoute=elementVertex(from,mid,fromBBox),endRoute=vertexVertex(mid,to,startRoute.direction);route.points=[startRoute.points[0],endRoute.points[0]],route.direction=endRoute.direction}}return route}function insideElement(from,to,fromBBox,toBBox,brng){var p1,p2,p3,route={},bndry=expand(boundary(fromBBox,toBBox),1),reversed=bndry.center().distance(to)>bndry.center().distance(from),start=reversed?to:from,end=reversed?from:to;return brng?(p1=g.point.fromPolar(bndry.width+bndry.height,radians[brng],start),p1=bndry.pointNearestToPoint(p1).move(p1,-1)):p1=bndry.pointNearestToPoint(start).move(start,1),p2=freeJoin(p1,end,bndry),p1.round().equals(p2.round())?(p2=g.point.fromPolar(bndry.width+bndry.height,g.toRad(p1.theta(start))+Math.PI/2,end),p2=bndry.pointNearestToPoint(p2).move(end,1).round(),p3=freeJoin(p1,p2,bndry),route.points=reversed?[p2,p3,p1]:[p1,p3,p2]):route.points=reversed?[p2,p1]:[p1,p2],route.direction=reversed?bearing(p1,to):bearing(p2,to),route}function findOrthogonalRoute(vertices,opt,linkView){var padding=opt.elementPadding||20,orthogonalVertices=[],sourceBBox=expand(linkView.sourceBBox,padding),targetBBox=expand(linkView.targetBBox,padding);vertices=_.map(vertices,g.point),vertices.unshift(sourceBBox.center()),vertices.push(targetBBox.center());for(var brng,i=0,max=vertices.length-1;i<max;i++){var route=null,from=vertices[i],to=vertices[i+1],isOrthogonal=!!bearing(from,to);if(0==i)i+1==max?sourceBBox.intersect(expand(targetBBox,1))?route=insideElement(from,to,sourceBBox,targetBBox):isOrthogonal||(route=elementElement(from,to,sourceBBox,targetBBox)):sourceBBox.containsPoint(to)?route=insideElement(from,to,sourceBBox,expand(pointBox(to),padding)):isOrthogonal||(route=elementVertex(from,to,sourceBBox));else if(i+1==max){var orthogonalLoop=isOrthogonal&&bearing(to,from)==brng;targetBBox.containsPoint(from)||orthogonalLoop?route=insideElement(from,to,expand(pointBox(from),padding),targetBBox,brng):isOrthogonal||(route=vertexElement(from,to,targetBBox,brng))}else isOrthogonal||(route=vertexVertex(from,to,brng));route?(Array.prototype.push.apply(orthogonalVertices,route.points),brng=route.direction):brng=bearing(from,to),i+1<max&&orthogonalVertices.push(to)}return orthogonalVertices}var opposite={N:"S",S:"N",E:"W",W:"E"},radians={N:-Math.PI/2*3,S:-Math.PI/2,E:0,W:Math.PI};return findOrthogonalRoute}(),joint.connectors.normal=function(sourcePoint,targetPoint,vertices){var d=["M",sourcePoint.x,sourcePoint.y];return _.each(vertices,function(vertex){d.push(vertex.x,vertex.y)}),d.push(targetPoint.x,targetPoint.y),d.join(" ")},joint.connectors.rounded=function(sourcePoint,targetPoint,vertices,opts){opts=opts||{};var c1,c2,d1,d2,prev,next,offset=opts.radius||10,d=["M",sourcePoint.x,sourcePoint.y];return _.each(vertices,function(vertex,index){prev=vertices[index-1]||sourcePoint,next=vertices[index+1]||targetPoint,d1=d2||g.point(vertex).distance(prev)/2,d2=g.point(vertex).distance(next)/2,c1=g.point(vertex).move(prev,-Math.min(offset,d1)).round(),c2=g.point(vertex).move(next,-Math.min(offset,d2)).round(),d.push(c1.x,c1.y,"S",vertex.x,vertex.y,c2.x,c2.y,"L")}),d.push(targetPoint.x,targetPoint.y),d.join(" ")},joint.connectors.smooth=function(sourcePoint,targetPoint,vertices){var d;if(vertices.length)d=g.bezier.curveThroughPoints([sourcePoint].concat(vertices).concat([targetPoint]));else{var controlPointX=(sourcePoint.x+targetPoint.x)/2;d=["M",sourcePoint.x,sourcePoint.y,"C",controlPointX,sourcePoint.y,controlPointX,targetPoint.y,targetPoint.x,targetPoint.y]}return d.join(" ")},joint.connectors.jumpover=function(_,g){function createLines(sourcePoint,targetPoint,vertices){var points=[].concat(sourcePoint,vertices,targetPoint);return points.reduce(function(resultLines,point,idx){var nextPoint=points[idx+1];return null!=nextPoint&&(resultLines[idx]=g.line(point,nextPoint)),resultLines},[])}function setupUpdating(jumpOverLinkView){var updateList=jumpOverLinkView.paper._jumpOverUpdateList;null==updateList&&(updateList=jumpOverLinkView.paper._jumpOverUpdateList=[],jumpOverLinkView.paper.on("cell:pointerup",updateJumpOver),jumpOverLinkView.paper.model.on("reset",function(){updateList=[]})),updateList.indexOf(jumpOverLinkView)<0&&(updateList.push(jumpOverLinkView),jumpOverLinkView.listenToOnce(jumpOverLinkView.model,"change:connector remove",function(){updateList.splice(updateList.indexOf(jumpOverLinkView),1)}))}function updateJumpOver(){for(var updateList=this._jumpOverUpdateList,i=0;i<updateList.length;i++)updateList[i].update()}function findLineIntersections(line,crossCheckLines){return _(crossCheckLines).map(function(crossCheckLine){return line.intersection(crossCheckLine)}).compact().value()}function sortPoints(p1,p2){return g.line(p1,p2).squaredLength()}function createJumps(line,intersections,jumpSize){return intersections.reduce(function(resultLines,point,idx){if(point.skip===!0)return resultLines;var lastLine=resultLines.pop()||line,jumpStart=g.point(point).move(lastLine.start,-jumpSize),jumpEnd=g.point(point).move(lastLine.start,+jumpSize),nextPoint=intersections[idx+1];if(null!=nextPoint){var distance=jumpEnd.distance(nextPoint);distance<=jumpSize&&(jumpEnd=nextPoint.move(lastLine.start,distance),nextPoint.skip=!0)}else{var endDistance=jumpStart.distance(lastLine.end);if(endDistance<2*jumpSize+CLOSE_PROXIMITY_PADDING)return resultLines.push(lastLine),resultLines}var startDistance=jumpEnd.distance(lastLine.start);if(startDistance<2*jumpSize+CLOSE_PROXIMITY_PADDING)return resultLines.push(lastLine),resultLines;var jumpLine=g.line(jumpStart,jumpEnd);return jumpLine.isJump=!0,resultLines.push(g.line(lastLine.start,jumpStart),jumpLine,g.line(jumpEnd,lastLine.end)),resultLines},[])}function buildPath(lines,jumpSize,jumpType){var start=["M",lines[0].start.x,lines[0].start.y],paths=_(lines).map(function(line){if(line.isJump){var diff;if("arc"===jumpType){diff=line.start.difference(line.end);var xAxisRotate=Number(diff.x<0&&diff.y<0);return["A",jumpSize,jumpSize,0,0,xAxisRotate,line.end.x,line.end.y]}if("gap"===jumpType)return["M",line.end.x,line.end.y];if("cubic"===jumpType){diff=line.start.difference(line.end);var angle=line.start.theta(line.end),xOffset=.6*jumpSize,yOffset=1.35*jumpSize;diff.x<0&&diff.y<0&&(yOffset*=-1);var controlStartPoint=g.point(line.start.x+xOffset,line.start.y+yOffset).rotate(line.start,angle),controlEndPoint=g.point(line.end.x-xOffset,line.end.y+yOffset).rotate(line.end,angle);return["C",controlStartPoint.x,controlStartPoint.y,controlEndPoint.x,controlEndPoint.y,line.end.x,line.end.y]}}return["L",line.end.x,line.end.y]}).flatten().value();return[].concat(start,paths).join(" ")}var JUMP_SIZE=5,JUMP_TYPES=["arc","gap","cubic"],CLOSE_PROXIMITY_PADDING=1,IGNORED_CONNECTORS=["smooth"];return function(sourcePoint,targetPoint,vertices,opts){setupUpdating(this);var jumpSize=opts.size||JUMP_SIZE,jumpType=opts.jump&&(""+opts.jump).toLowerCase(),ignoreConnectors=opts.ignoreConnectors||IGNORED_CONNECTORS;JUMP_TYPES.indexOf(jumpType)===-1&&(jumpType=JUMP_TYPES[0]);var paper=this.paper,graph=paper.model,allLinks=graph.getLinks();if(1===allLinks.length)return buildPath(createLines(sourcePoint,targetPoint,vertices),jumpSize,jumpType);var thisModel=this.model,thisIndex=allLinks.indexOf(thisModel),defaultConnector=paper.options.defaultConnector||{},links=allLinks.filter(function(link,idx){var connector=link.get("connector")||defaultConnector;return!_.contains(ignoreConnectors,connector.name)&&(!(idx>thisIndex)||"jumpover"!==connector.name)}),linkViews=links.map(function(link){return paper.findViewByModel(link)}),thisLines=createLines(sourcePoint,targetPoint,vertices),linkLines=linkViews.map(function(linkView){return null==linkView?[]:linkView===this?thisLines:createLines(linkView.sourcePoint,linkView.targetPoint,linkView.route)},this),jumpingLines=thisLines.reduce(function(resultLines,thisLine){var intersections=_(links).map(function(link,i){return link===thisModel?null:findLineIntersections(thisLine,linkLines[i])}).flatten().compact().sortBy(_.partial(sortPoints,thisLine.start)).value();return intersections.length>0?resultLines.push.apply(resultLines,createJumps(thisLine,intersections,jumpSize)):resultLines.push(thisLine),resultLines},[]);return buildPath(jumpingLines,jumpSize,jumpType)}}(_,g),joint.highlighters.addClass={className:"highlighted",highlight:function(cellView,magnetEl,opt){var className=opt.className||this.className;V(magnetEl).addClass(className)},unhighlight:function(cellView,magnetEl,opt){var className=opt.className||this.className;V(magnetEl).removeClass(className)}},joint.highlighters.opacity={highlight:function(cellView,magnetEl,opt){V(magnetEl).addClass("joint-highlight-opacity")},unhighlight:function(cellView,magnetEl,opt){V(magnetEl).removeClass("joint-highlight-opacity")}},joint.highlighters.stroke={defaultOptions:{padding:3,rx:0,ry:0},_views:{},highlight:function(cellView,magnetEl,opt){if(!this._views[magnetEl.id]){opt=_.defaults(opt||{},this.defaultOptions);var magnetVel=V(magnetEl),magnetBBox=magnetVel.bbox(!0);try{var pathData=magnetVel.convertToPathData()}catch(error){pathData=V.rectToPath(_.extend({},opt,magnetBBox))}var highlightVel=V("path").attr({d:pathData,"class":"joint-highlight-stroke","pointer-events":"none"});highlightVel.transform(cellView.el.getCTM().inverse()),highlightVel.transform(magnetEl.getCTM());var padding=opt.padding;if(padding){var cx=magnetBBox.x+magnetBBox.width/2,cy=magnetBBox.y+magnetBBox.height/2,sx=(magnetBBox.width+padding)/magnetBBox.width,sy=(magnetBBox.height+padding)/magnetBBox.height;highlightVel.transform({a:sx,b:0,c:0,d:sy,e:cx-sx*cx,f:cy-sy*cy})}var highlightView=this._views[magnetEl.id]=new joint.mvc.View({el:highlightVel.node,$el:highlightVel});highlightView.listenTo(cellView.model,"remove",highlightView.remove),cellView.vel.append(highlightVel)}},unhighlight:function(cellView,magnetEl,opt){opt=_.defaults(opt||{},this.defaultOptions),this._views[magnetEl.id]&&(this._views[magnetEl.id].remove(),this._views[magnetEl.id]=null)}},joint.g=g,joint.V=joint.Vectorizer=V,joint});