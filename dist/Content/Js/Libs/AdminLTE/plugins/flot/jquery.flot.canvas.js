!function($){function init(plot,classes){var Canvas=classes.Canvas;null==render&&(getTextInfo=Canvas.prototype.getTextInfo,addText=Canvas.prototype.addText,render=Canvas.prototype.render),Canvas.prototype.render=function(){if(!plot.getOptions().canvas)return render.call(this);var context=this.context,cache=this._textCache;context.save(),context.textBaseline="middle";for(var layerKey in cache)if(hasOwnProperty.call(cache,layerKey)){var layerCache=cache[layerKey];for(var styleKey in layerCache)if(hasOwnProperty.call(layerCache,styleKey)){var styleCache=layerCache[styleKey],updateStyles=!0;for(var key in styleCache)if(hasOwnProperty.call(styleCache,key)){var info=styleCache[key],positions=info.positions,lines=info.lines;updateStyles&&(context.fillStyle=info.font.color,context.font=info.font.definition,updateStyles=!1);for(var position,i=0;position=positions[i];i++)if(position.active)for(var line,j=0;line=position.lines[j];j++)context.fillText(lines[j].text,line[0],line[1]);else positions.splice(i--,1);0==positions.length&&delete styleCache[key]}}}context.restore()},Canvas.prototype.getTextInfo=function(layer,text,font,angle,width){if(!plot.getOptions().canvas)return getTextInfo.call(this,layer,text,font,angle,width);var textStyle,layerCache,styleCache,info;if(text=""+text,textStyle="object"==typeof font?font.style+" "+font.variant+" "+font.weight+" "+font.size+"px "+font.family:font,layerCache=this._textCache[layer],null==layerCache&&(layerCache=this._textCache[layer]={}),styleCache=layerCache[textStyle],null==styleCache&&(styleCache=layerCache[textStyle]={}),info=styleCache[text],null==info){var context=this.context;if("object"!=typeof font){var element=$("<div>&nbsp;</div>").css("position","absolute").addClass("string"==typeof font?font:null).appendTo(this.getTextLayer(layer));font={lineHeight:element.height(),style:element.css("font-style"),variant:element.css("font-variant"),weight:element.css("font-weight"),family:element.css("font-family"),color:element.css("color")},font.size=element.css("line-height",1).height(),element.remove()}textStyle=font.style+" "+font.variant+" "+font.weight+" "+font.size+"px "+font.family,info=styleCache[text]={width:0,height:0,positions:[],lines:[],font:{definition:textStyle,color:font.color}},context.save(),context.font=textStyle;for(var lines=(text+"").replace(/<br ?\/?>|\r\n|\r/g,"\n").split("\n"),i=0;i<lines.length;++i){var lineText=lines[i],measured=context.measureText(lineText);info.width=Math.max(measured.width,info.width),info.height+=font.lineHeight,info.lines.push({text:lineText,width:measured.width,height:font.lineHeight})}context.restore()}return info},Canvas.prototype.addText=function(layer,x,y,text,font,angle,width,halign,valign){if(!plot.getOptions().canvas)return addText.call(this,layer,x,y,text,font,angle,width,halign,valign);var info=this.getTextInfo(layer,text,font,angle,width),positions=info.positions,lines=info.lines;y+=info.height/lines.length/2,y="middle"==valign?Math.round(y-info.height/2):"bottom"==valign?Math.round(y-info.height):Math.round(y),window.opera&&window.opera.version().split(".")[0]<12&&(y-=2);for(var position,i=0;position=positions[i];i++)if(position.x==x&&position.y==y)return void(position.active=!0);position={active:!0,lines:[],x:x,y:y},positions.push(position);for(var line,i=0;line=lines[i];i++)"center"==halign?position.lines.push([Math.round(x-line.width/2),y]):"right"==halign?position.lines.push([Math.round(x-line.width),y]):position.lines.push([Math.round(x),y]),y+=line.height}}var render,getTextInfo,addText,options={canvas:!0},hasOwnProperty=Object.prototype.hasOwnProperty;$.plot.plugins.push({init:init,options:options,name:"canvas",version:"1.0"})}(jQuery);